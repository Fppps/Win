<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 13 Concept</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts for custom typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Anime.js for advanced animations and transitions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase SDK (Version 11.6.1 is used as per instructions) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null; // Will store the authenticated user ID
        window.isAuthReady = false; // Flag to indicate if auth state is determined

        // Global user preferences
        window.userPreferences = {
            username: 'User Name',
            password: '', // Storing password for demo, but in real app, only store hash
            wallpaperUrl: 'Assets/Background/BackgroundV2.png',
            theme: 'dark-mode' // 'dark-mode' or 'light-mode'
        };

        // Check for global __firebase_config and __app_id provided by Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase on window load
        window.addEventListener('load', async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    window.firebaseApp = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.firebaseApp);
                    window.auth = getAuth(window.firebaseApp);

                    onAuthStateChanged(window.auth, async (user) => {
                        if (user) {
                            window.userId = user.uid;
                        } else {
                            // Sign in anonymously if no user is logged in
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(window.auth, initialAuthToken);
                                    window.userId = window.auth.currentUser.uid;
                                } else {
                                    const anonUserCredential = await signInAnonymously(window.auth);
                                    window.userId = anonUserCredential.user.uid;
                                }
                            } catch (error) {
                                console.error("Firebase Anonymous Sign-in Error:", error);
                                // Fallback to a random ID if anonymous sign-in fails
                                window.userId = crypto.randomUUID();
                            }
                        }
                        window.isAuthReady = true;
                        // Now that auth is ready, proceed with desktop initialization and loading preferences
                        initializeDesktopListeners();
                        loadUserPreferences(); // Load user data after successful authentication
                    });
                } else {
                    console.warn("Firebase config not found. Running without Firebase features.");
                    // Fallback to random ID if Firebase is not configured
                    window.userId = crypto.randomUUID();
                    window.isAuthReady = true;
                    initializeDesktopListeners(); // Initialize desktop without Firebase data
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Fallback to random ID if Firebase initialization fails
                window.userId = crypto.randomUUID();
                window.isAuthReady = true;
                initializeDesktopListeners(); // Initialize desktop without Firebase data
            }
        });

        async function loadUserPreferences() {
            if (!window.db || !window.userId) {
                console.warn("Firestore or User ID not available. Cannot load preferences.");
                return;
            }
            try {
                // Private data: /artifacts/{appId}/users/{userId}/settings/user_preferences
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/settings/user_preferences`);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.userPreferences.username = data.username || window.userPreferences.username;
                    window.userPreferences.password = data.password || window.userPreferences.password; // Note: Storing password directly is insecure for production
                    window.userPreferences.wallpaperUrl = data.wallpaperUrl || window.userPreferences.wallpaperUrl;
                    window.userPreferences.theme = data.theme || window.userPreferences.theme;
                    console.log("User preferences loaded:", window.userPreferences);
                } else {
                    console.log("No user preferences found, using defaults.");
                }

                // Apply loaded preferences
                updateProfileDisplay();
                applyWallpaper(window.userPreferences.wallpaperUrl);
                applyTheme(window.userPreferences.theme);

            } catch (e) {
                console.error("Error loading user preferences:", e);
                showMessage("Failed to load user settings.");
            }
        }

        async function saveUserPreferences() {
            if (!window.db || !window.userId) {
                console.warn("Firestore or User ID not available. Cannot save preferences.");
                return;
            }
            try {
                // Private data: /artifacts/{appId}/users/{userId}/settings/user_preferences
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/settings/user_preferences`);
                await setDoc(userDocRef, window.userPreferences, { merge: true });
                showMessage("Settings saved successfully!");
                console.log("User preferences saved:", window.userPreferences);
                // After saving, re-apply display for immediate effect (e.g., username change)
                updateProfileDisplay();
                applyWallpaper(window.userPreferences.wallpaperUrl);
                applyTheme(window.userPreferences.theme);

            } catch (e) {
                console.error("Error saving user preferences:", e);
                showMessage("Failed to save settings.");
            }
        }

        function updateProfileDisplay() {
            if (welcomeMessage) {
                welcomeMessage.textContent = `Welcome Back, ${window.userPreferences.username}`;
            }
            // Update the profile in the settings accounts section if it's open
            const accountsUsernameInput = document.querySelector('#accounts-username-input');
            if (accountsUsernameInput) {
                accountsUsernameInput.value = window.userPreferences.username;
            }
        }

        function applyWallpaper(url) {
            if (desktopEnvContainer) {
                // Update CSS variable directly
                desktopEnvContainer.style.setProperty('--desktop-image', `url('${url}')`);
            }
        }

        function applyTheme(theme) {
            if (document.body) {
                if (theme === 'light-mode') {
                    document.body.classList.add('light-mode');
                    // Also update the toggle in Display Settings if it's open
                    const themeModeToggle = document.querySelector('#display-settings-window #theme-mode');
                    if (themeModeToggle) themeModeToggle.checked = true;
                } else {
                    document.body.classList.remove('light-mode');
                    const themeModeToggle = document.querySelector('#display-settings-window #theme-mode');
                    if (themeModeToggle) themeModeToggle.checked = false;
                }
            }
        }

    </script>
    <!-- Embedded CSS styles -->
    <style>
        /* Define CSS variables for themes. Default values are for dark mode. */
        :root {
            --main-bg-color: #3E3572; /* Dark mode background color for the desktop underneath the image */
            --desktop-image: url('Assets/Background/BackgroundV2.png'); /* Transparent image overlay */
            --desktop-text-color: #f9fafb; /* Light text for dark background */

            --window-bg: rgba(26, 26, 26, 0.95); /* Semi-transparent dark gray for window background */
            --window-border: #4a4a4a; /* Dark gray border for windows */
            --window-text: #f9fafb; /* Light text for window content */

            --header-bg: #1f2937; /* Darker gray for window headers */
            --header-border: #4a4a4a; /* Darker gray border for headers */
            --header-button-hover: #374151; /* Darker gray for header button hover */
            --header-button-text: #9ca3af; /* Light gray for header button icons */

            --sidebar-bg: #2a2a2a; /* Dark gray for settings sidebar */
            --sidebar-border: #4a4a4a; /* Dark gray border for sidebar */
            --content-area-bg: #1a1a1a; /* Even darker gray for settings content area */

            --input-bg: #374151; /* Medium gray for inputs */
            --input-text: #f9fafb; /* Light text for inputs */
            --placeholder-color: #9ca3af; /* Gray placeholder text */
            --focus-ring-color: #3b82f6; /* Blue focus ring for inputs */

            --general-button-bg: #3b82f6; /* Blue for general buttons */
            --general-button-hover: #2563eb; /* Darker blue for general button hover */
            --general-button-text: #ffffff; /* White text for general buttons */

            --start-menu-item-hover: rgba(255, 255, 255, 0.1); /* Subtle hover for start menu items */
            --context-menu-item-hover: #3b82f6; /* Blue hover for context menu items */
        }

        /* Light mode overrides for CSS variables */
        body.light-mode {
            --main-bg-color: #8975FC; /* Light mode background color for the desktop underneath the image */
            --desktop-text-color: #1a1a1a; /* Dark text for light background */

            --window-bg: rgba(255, 255, 255, 0.95); /* Semi-transparent white for window background */
            --window-border: #d1d5db; /* Light gray border for windows */
            --window-text: #1a1a1a; /* Dark text for window content */

            --header-bg: #e0e7ff; /* Lighter blue-ish for window headers */
            --header-border: #a7b7e5; /* Light blue border for headers */
            --header-button-hover: #a7b7e5; /* Lighter blue for header button hover */
            --header-button-text: #3b82f6; /* Blue for header button icons */

            --sidebar-bg: #f3f4f6; /* Light gray for settings sidebar */
            --sidebar-border: #e5e7eb; /* Lighter gray border for sidebar */
            --content-area-bg: #ffffff; /* White for settings content area */

            --input-bg: #e5e7eb; /* Lighter gray for inputs */
            --input-text: #1a1a1a; /* Dark text for inputs */
            --placeholder-color: #6b7280; /* Darker gray placeholder text */
            --focus-ring-color: #60a5fa; /* Lighter blue focus ring */

            --general-button-bg: #60a5fa; /* Lighter blue for general buttons */
            --general-button-hover: #3b82f6; /* Darker blue for general button hover */

            --start-menu-item-hover: rgba(0, 0, 0, 0.05); /* Subtle hover for light mode start menu items */
            --context-menu-item-hover: #60a5fa; /* Lighter blue hover for context menu items */
        }

        /* Base styles applied to body and globally */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll */
            cursor: default;
            background-color: var(--main-bg-color); /* Apply main background color */
            color: var(--desktop-text-color); /* Apply desktop text color */
            transition: background-color 0.5s ease-out, color 0.5s ease-out;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--sidebar-bg); /* Use a theme-adaptive background */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888; /* Neutral gray for thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Darker neutral gray on hover */
        }

        /* Window styles */
        .window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center initially */
            min-width: 300px;
            min-height: 200px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45); /* Enhanced shadow for depth */
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            resize: both; /* Enable native resize, overridden by custom handle */
            background-color: var(--window-bg);
            border: 1px solid var(--window-border);
            color: var(--window-text);
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out, color 0.3s ease-out, box-shadow 0.3s ease-out;
        }

        .window-header {
            cursor: grab;
            user-select: none;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out;
        }

        .window-header:active {
            cursor: grabbing;
        }

        .resize-handle {
            position: absolute;
            width: 15px;
            height: 15px;
            bottom: 0;
            right: 0;
            cursor: se-resize;
            background: transparent;
            z-index: 10;
        }

        .maximized {
            width: 100vw !important;
            height: 100vh !important;
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            border-radius: 0 !important;
        }

        .minimized {
            display: none !important;
        }

        /* Start Menu and Context Menu */
        .start-menu {
            position: absolute;
            bottom: 0;
            left: 0.5rem;
            width: 900px;
            max-width: 95vw;
            height: 500px;
            max-height: calc(100vh - 5rem);
            overflow: hidden;
            transform-origin: bottom left;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease-out;
            display: flex;
            background-color: var(--window-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px); /* Slightly stronger blur */
        }

        .start-menu.hidden {
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
        }

        .start-menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .start-menu-item:hover {
            background-color: var(--start-menu-item-hover);
        }

        .context-menu {
            position: absolute;
            z-index: 9999;
            transform-origin: top left;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out, background-color 0.3s ease-out;
            background-color: var(--window-bg);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px); /* Slightly stronger blur */
        }
        .context-menu.hidden {
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
        }

        .context-menu div {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .context-menu div:hover {
            background-color: var(--context-menu-item-hover);
            color: white;
        }

        /* Keyframe animations for windows */
        @keyframes window-open {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        .window.opening {
            animation: window-open 0.2s ease-out forwards;
        }

        @keyframes window-close {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }
        .window.closing {
            animation: window-close 0.2s ease-out forwards;
        }

        /* Desktop environment container */
        #desktop-env-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--main-bg-color);
            background-image: var(--desktop-image);
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
            transition: filter 0.5s ease-out, background-color 0.5s ease-out;
            z-index: 1;
            display: flex;
            flex-direction: column;
            filter: brightness(100%);
        }
        #desktop-env-container.blurred {
            filter: blur(5px);
        }
        #desktop-env-container.desktop-active {
            z-index: 10;
        }
        #desktop-env-container.night-light-active {
            filter: brightness(var(--desktop-brightness-value, 100%)) sepia(0.3) hue-rotate(-20deg);
        }

        /* Login screen styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s ease-out;
        }
        #login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-card {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6); /* Stronger shadow for depth */
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(20px);
            opacity: 0;
        }
        .login-card.show {
            transform: translateY(0);
            opacity: 1;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }

        /* Profile picture on login screen */
        .profile-pic-login {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background-color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 24px;
            color: white;
            overflow: hidden;
            border: 3px solid #60a5fa;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .profile-pic-login img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Welcome Back message */
        .welcome-message {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            color: #e0e7ff;
        }
        .welcome-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom Message Box Styles */
        #message-box {
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 11000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none;
        }
        #message-box.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Windows-style Loading Spinner */
        .windows-spinner {
            width: 50px;
            height: 50px;
            position: relative;
            margin-top: 20px;
            transform: rotate(45deg);
            display: none;
        }

        .windows-spinner.show {
            display: block;
        }

        .windows-spinner .dot {
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            border-radius: 50%;
            position: absolute;
            animation: windows-dot-spin 1.5s infinite ease-in-out;
            opacity: 0;
        }

        .windows-spinner .dot:nth-child(1) { top: 0; left: 0; animation-delay: 0s; }
        .windows-spinner .dot:nth-child(2) { top: 0; right: 0; animation-delay: 0.1s; }
        .windows-spinner .dot:nth-child(3) { bottom: 0; right: 0; animation-delay: 0.2s; }
        .windows-spinner .dot:nth-child(4) { bottom: 0; left: 0; animation-delay: 0.3s; }

        @keyframes windows-dot-spin {
            0%, 100% {
                transform: scale(0.5);
                opacity: 0;
            }
            25% {
                transform: scale(1);
                opacity: 1;
            }
            50%, 75% {
                transform: scale(0.5);
                opacity: 0;
            }
        }

        /* Ensure windows-container does not block clicks on desktop icons */
        #windows-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        /* Settings App Specific Styles */
        .settings-sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            padding: 1rem;
            flex-shrink: 0;
            overflow-y: auto;
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out;
        }

        .settings-content-area {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: var(--content-area-bg);
            transition: background-color 0.3s ease-out;
        }

        .settings-category-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .settings-category-item:hover {
            background-color: var(--start-menu-item-hover); /* Reusing start menu item hover for consistency */
        }

        .settings-category-item.active {
            background-color: #005fba; /* Windows blue */
            color: white;
        }

        .settings-category-item i {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .settings-category-item span {
            font-weight: 500;
        }

        /* Input field styling based on theme variables */
        input[type="text"], input[type="password"], select {
            background-color: var(--input-bg);
            color: var(--input-text);
            padding: 0.75rem 1rem; /* Consistent padding */
            border-radius: 8px; /* Slightly more rounded */
            border: 1px solid var(--window-border); /* Subtle border */
            transition: background-color 0.3s ease-out, color 0.3s ease-out, border-color 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        input[type="text"]::placeholder, input[type="password"]::placeholder {
            color: var(--placeholder-color);
        }
        input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--focus-ring-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); /* Glow effect on focus */
        }

        /* Adjust desktop icon text for light mode */
        body.light-mode .desktop-icon span {
            color: var(--desktop-text-color); /* Ensures text color adapts */
        }
        /* Adjust start menu text for light mode */
        body.light-mode .start-menu h2,
        body.light-mode .start-menu ul li {
            color: var(--window-text); /* Ensures text color adapts */
        }
        /* Adjust start button for light mode */
        body.light-mode #start-button {
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        body.light-mode #start-button:hover {
            background-color: #60a5fa; /* Lighter blue hover for light mode */
        }
        body.light-mode #start-button .fa-windows {
            color: #005fba; /* Darker blue for Windows icon in light mode */
        }

        /* Common button styles */
        button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out, box-shadow 0.2s ease-in-out;
            border-radius: 8px; /* Default rounded corners for all buttons */
            padding: 0.75rem 1.5rem; /* Default padding */
            font-weight: 600; /* Semi-bold text */
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow */
            background-color: var(--general-button-bg);
            color: var(--general-button-text);
        }

        button:hover {
            background-color: var(--general-button-hover);
            transform: translateY(-1px); /* Slight lift effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* Enhanced shadow on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15); /* Pressed effect */
        }

        /* Specific button overrides */
        .window-header button {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0; /* Override default padding */
            width: 28px; /* Fixed size */
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--header-button-text);
        }
        .window-header button:hover {
            background-color: var(--header-button-hover);
            transform: none;
            box-shadow: none;
        }
        .window-header .close-btn:hover {
            background-color: #dc2626; /* Red for close button */
            color: white;
        }

        /* Calculator specific styles */
        #calc-display {
            background-color: var(--input-bg); /* Use theme variable */
            color: var(--input-text); /* Use theme variable */
            border: 1px solid var(--window-border); /* Use theme variable */
            text-align: right;
            font-size: 2.5rem; /* Larger font */
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .calc-btn {
            background-color: var(--input-bg); /* Match inputs or other suitable theme var */
            color: var(--input-text); /* Match inputs or other suitable theme var */
            border: none;
            font-size: 1.25rem;
            height: 50px;
            border-radius: 10px;
            transition: background-color 0.2s, transform 0.1s;
        }
        .calc-btn:hover {
            background-color: var(--header-button-hover); /* A slightly lighter background on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .calc-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .calc-btn.bg-orange-500 {
            background-color: #f97316; /* Orange for operators */
            color: white;
        }
        .calc-btn.bg-orange-500:hover {
            background-color: #ea580c;
        }
        .calc-btn.bg-blue-600 {
            background-color: #2563eb; /* Blue for equals */
            color: white;
        }
        .calc-btn.bg-blue-600:hover {
            background-color: #1d4ed8;
        }
        .calc-btn.bg-gray-500 {
            background-color: #6b7280; /* Gray for C, backspace */
            color: white;
        }
        .calc-btn.bg-gray-500:hover {
            background-color: #4b5563;
        }

        /* To-Do List specific styles */
        #todo-input {
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--window-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }
        #todo-input:focus {
            outline: none;
            border-color: var(--focus-ring-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        #add-todo-btn {
            background-color: #10b981; /* Green */
            color: white;
        }
        #add-todo-btn:hover {
            background-color: #059669;
        }
        #todo-list-items li {
            background-color: var(--sidebar-bg); /* Use sidebar background for list items */
            border: 1px solid var(--sidebar-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out;
        }
        #todo-list-items li button {
            background: none;
            box-shadow: none;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #ef4444; /* Red for delete */
        }
        #todo-list-items li button:hover {
            background-color: rgba(239, 68, 68, 0.1);
            transform: none;
        }

        /* Shortcuts Zone (Time/Date) */
        #shortcuts-zone {
            background-color: rgba(0, 0, 0, 0.5); /* Keep it dark semi-transparent */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; /* Keep text white */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        body.light-mode #shortcuts-zone {
            background-color: rgba(255, 255, 255, 0.5); /* Lighter semi-transparent */
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: black; /* Dark text for light mode */
        }

        /* Desktop icons zone */
        #desktop-icons-zone .desktop-icon:hover {
            background-color: rgba(0, 0, 0, 0.2); /* Dark mode subtle hover */
        }
        body.light-mode #desktop-icons-zone .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Light mode subtle hover */
        }

        /* Settings category item active state */
        .settings-category-item.active {
            background-color: #005fba; /* Consistent blue */
            color: white;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="absolute top-8 left-8 text-white text-4xl font-light font-['Source_Sans_3']">
            <span id="login-time"></span>
            <div class="text-xl mt-1 font-['Source_Sans_3']" id="login-date"></div>
        </div>

        <div class="login-card">
            <div class="profile-pic-login">
                <i class="fa-solid fa-user"></i> <!-- Default user icon -->
                <!-- <img src="assets/Profile/default_user.png" alt="User Profile Picture"> -->
            </div>
            <h2 class="welcome-message" id="welcome-message">Welcome Back, User Name</h2>
            <div class="mb-6 w-full">
                <input type="password" id="password-input" class="w-full text-center" placeholder="Enter password (any input)" onkeyup="handleLoginEnter(event)">
            </div>
            <button onclick="attemptLogin()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors shadow-lg">
                Sign In
            </button>
            <div id="login-spinner" class="windows-spinner">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <p id="login-message" class="text-red-400 mt-4 text-sm hidden"></p>
        </div>
    </div>

    <!-- Desktop Environment (initially blurred, then unblurred and active) -->
    <div id="desktop-env-container" class="w-full h-full flex flex-col">
        <!-- Actual Desktop Area (content above taskbar) -->
        <div id="desktop" class="flex-grow flex p-4 relative overflow-hidden">
            <!-- Left Zone: Desktop Icons -->
            <div id="desktop-icons-zone" class="w-1/4 min-w-[150px] max-w-[250px] overflow-y-auto pr-4">
                <div class="flex flex-col gap-4">
                    <!-- Desktop Icons -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="File Explorer" data-app-id="file-explorer">
                        <i class="fa-solid fa-folder-open text-blue-400 text-4xl"></i>
                        <span class="text-sm mt-1">File Explorer</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Browser" data-app-id="browser">
                        <i class="fa-solid fa-globe text-purple-400 text-4xl"></i>
                        <span class="text-sm mt-1">Browser</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Terminal" data-app-id="terminal">
                        <i class="fa-solid fa-terminal text-green-400 text-4xl"></i>
                        <span class="text-sm mt-1">Terminal</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Solar Panel" data-app-id="solar-panel">
                        <i class="fa-solid fa-solar-panel text-yellow-400 text-4xl"></i>
                        <span class="text-sm mt-1">Solar Panel</span>
                    </div>
                    <!-- New Settings App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Settings" data-app-id="settings">
                        <i class="fa-solid fa-gear text-gray-400 text-4xl"></i>
                        <span class="text-sm mt-1">Settings</span>
                    </div>
                    <!-- New About Windows App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="About Windows 13" data-app-id="about-windows">
                        <img src="assets/Logo/Windows_13_logo.png" alt="Windows 13 Logo" class="w-10 h-10">
                        <span class="text-sm mt-1 text-center">About Windows 13</span>
                    </div>
                    <!-- New Calculator App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Calculator" data-app-id="calculator">
                        <i class="fa-solid fa-calculator text-red-400 text-4xl"></i>
                        <span class="text-sm mt-1">Calculator</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Image Viewer" data-app-id="image-viewer">
                        <i class="fa-solid fa-image text-pink-400 text-4xl"></i>
                        <span class="text-sm mt-1">Image Viewer</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="To-Do List" data-app-id="todo-list">
                        <i class="fa-solid fa-list-check text-green-400 text-4xl"></i>
                        <span class="text-sm mt-1">To-Do List</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Weather" data-app-id="weather">
                        <i class="fa-solid fa-cloud-sun-rain text-blue-300 text-4xl"></i>
                        <span class="text-sm mt-1">Weather</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Display Settings" data-app-id="display-settings">
                        <i class="fa-solid fa-display text-blue-400 text-4xl"></i>
                        <span class="text-sm mt-1 text-center">Display Settings</span>
                    </div>
                </div>
            </div>

            <!-- Center Zone (flexible empty space for now) -->
            <div class="flex-grow"></div>

            <!-- Right Zone: Shortcuts (Time, Date) -->
            <div id="shortcuts-zone" class="w-1/4 min-w-[150px] max-w-[250px] p-4 rounded-lg backdrop-blur-md flex flex-col justify-between cursor-pointer" onclick="openApp('Date and Time', 'date-time')">
                <div class="text-center">
                    <div class="text-5xl font-light font-['Source_Sans_3']" id="desktop-time"></div>
                    <div class="text-xl mt-2 font-['Source_Sans_3']" id="desktop-date"></div>
                </div>
                <!-- Other quick links can be added here -->
            </div>
        </div>

        <!-- Windows Container -->
        <div id="windows-container" class="absolute inset-0">
            <!-- Windows will be dynamically added here -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="start-menu hidden backdrop-blur-md rounded-lg p-4 shadow-xl z-50">
            <!-- Left Panel: Recent Apps -->
            <div class="w-1/3 border-r border-gray-700 pr-4 overflow-y-auto">
                <h2 class="text-lg font-semibold mb-4 text-blue-400">Recent Apps</h2>
                <ul id="recent-apps-list" class="space-y-2">
                    <!-- Dynamically populated recent apps - example entries for now -->
                    <li class="start-menu-item" onclick="openApp('File Explorer', 'file-explorer'); toggleStartMenu()">
                        <i class="fa-solid fa-folder-open text-blue-400 text-xl mr-2"></i> File Explorer
                    </li>
                    <li class="start-menu-item" onclick="openApp('Browser', 'browser'); toggleStartMenu()">
                        <i class="fa-solid fa-globe text-purple-400 text-xl mr-2"></i> Browser
                    </li>
                    <li class="start-menu-item" onclick="openApp('Terminal', 'terminal'); toggleStartMenu()">
                        <i class="fa-solid fa-terminal text-green-400 text-xl mr-2"></i> Terminal
                    </li>
                    <li class="start-menu-item" onclick="openApp('Settings', 'settings'); toggleStartMenu()">
                        <i class="fa-solid fa-gear text-gray-400 text-xl mr-2"></i> Settings
                    </li>
                </ul>
            </div>

            <!-- Middle Panel: Updates -->
            <div class="w-1/3 border-r border-gray-700 px-4 overflow-y-auto">
                <h2 class="text-lg font-semibold mb-4 text-blue-400">Windows 13 Updates</h2>
                <!-- NEW UPDATE ENTRY START -->
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.95</p>
                    <p class="text-blue-400 mb-2">Codename: Background remake & Login change info</p>
                    <p class="text-gray-300 text-sm">
                        This update introduces significant visual enhancements, allowing users to customize their desktop
                        backgrounds with both predefined options and custom image URLs. Additionally, the login screen
                        now includes improved informational displays, providing clearer feedback during the sign-in process.
                        These changes aim to personalize the user experience and streamline initial system access.
                    </p>
                </div>
                <!-- NEW UPDATE ENTRY END -->
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.9</p>
                    <p class="text-blue-400 mb-2">Codename: Layout change & Start Menu change</p>
                    <p class="text-gray-300 text-sm">
                        This update brings a significant overhaul to the desktop layout.
                        The taskbar has been removed, integrating its core functionalities into the Start Menu.
                        The desktop now features a left-aligned icon zone and a right-aligned "Shortcuts" area,
                        which prominently displays the time and date, now clickable to open the new "Date/Time" application.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.8</p>
                    <p class="text-blue-400 mb-2">Codename: Scrolling added</p>
                    <p class="text-gray-300 text-sm">
                        This mini-update ensures that various application windows and content areas within the OS
                        now correctly support scrolling when their content exceeds the visible area.
                        This improves usability and access to information in apps like File Explorer, Terminal,
                        and other dynamic content displays.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.73</p>
                    <p class="text-blue-400 mb-2">Codename: Boot up sound Update & Loading Update</p>
                    <p class="text-gray-300 text-sm">
                        This significant update enhances the user's initial experience by refining the boot-up sound for a more pleasing auditory feedback.
                        Additionally, the loading spinner throughout the system has been redesigned to align with modern Windows aesthetics, offering a smoother and more visually appealing waiting indicator.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.4</p>
                    <p class="text-blue-400 mb-2">Codename: Login Patch & boot up sounds</p>
                    <p class="text-gray-300 text-sm">
                        This update revamps the login screen with a modern aesthetic and introduces a subtle boot-up sound for a more immersive experience.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="font-bold text-lg mb-2">Version: 0.3.0</p>
                    <p class="text-blue-400 mb-2">Codename: Desktop columns & a Windows Update setting (alpha version)</p>
                    <p class="text-gray-300 text-sm">
                        This update introduces a more organized desktop layout with columns and adds
                        a conceptual Windows Update setting for future expansion.
                    </p>
                </div>
            </div>

            <!-- Right Panel: Device Settings -->
            <div class="w-1/3 pl-4">
                <h2 class="text-lg font-semibold mb-4 text-blue-400">Device Settings</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Settings', 'settings'); toggleStartMenu()">
                        <i class="fa-solid fa-gear text-gray-400 text-2xl"></i> <span class="text-xs mt-1">Settings</span>
                    </div>
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Calculator', 'calculator'); toggleStartMenu()">
                        <i class="fa-solid fa-calculator text-red-400 text-2xl"></i> <span class="text-xs mt-1">Calculator</span>
                    </div>
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Browser', 'browser'); toggleStartMenu()">
                        <i class="fa-solid fa-globe text-purple-400 text-2xl"></i> <span class="text-xs mt-1">Internet</span>
                    </div>
                    <!-- Changed from Display Settings to Volume, opens the same app -->
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Display Settings', 'display-settings'); toggleStartMenu()">
                        <i class="fa-solid fa-volume-high text-blue-400 text-2xl"></i> <span class="text-xs mt-1">Volume</span>
                    </div>
                    <!-- Add more device settings icons as needed -->
                </div>
            </div>
        </div>

        <!-- Desktop Context Menu -->
        <div id="desktop-context-menu" class="context-menu hidden backdrop-blur-md rounded-lg p-2 shadow-xl z-50 text-sm">
            <div class="py-1 px-3 rounded-md cursor-pointer" onclick="openApp('Display Settings', 'display-settings'); hideContextMenu()">Display settings</div>
            <div class="py-1 px-3 rounded-md cursor-pointer" onclick="showMessage('Personalize opened!'); hideContextMenu()">Personalize</div>
            <div class="py-1 px-3 rounded-md cursor-pointer" onclick="showMessage('New folder created!'); hideContextMenu()">New Folder</div>
        </div>

    </div>

    <!-- Start Button at bottom-left corner -->
    <button id="start-button" class="absolute bottom-4 left-4 flex items-center justify-center w-12 h-12 rounded-full bg-gray-800 bg-opacity-90 backdrop-blur-md hover:bg-blue-600 focus:outline-none transition-colors z-40" onclick="toggleStartMenu()">
        <i class="fa-brands fa-windows text-blue-400 text-2xl"></i>
    </button>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden"></div>

<!-- Embedded JavaScript code -->
<script>
    // Global variables for DOM elements, assigned in initializeDesktopListeners()
    let desktopEnvContainer;
    let loginScreen;
    let passwordInput;
    let loginTimeDisplay;
    let loginDateDisplay;
    let loginSpinner;
    let loginCard; // New variable for login card
    let welcomeMessage; // New variable for welcome message

    let desktop;
    let desktopIconsZone; // New variable for desktop icons container
    let shortcutsZone;    // New variable for shortcuts container
    let desktopTimeDisplay; // New variable for desktop time
    let desktopDateDisplay; // New variable for desktop date

    let windowsContainer;
    let startMenu;
    let startButton;
    // Taskbar apps removed
    let desktopContextMenu;

    let zIndexCounter = 1000;
    let openWindows = {}; // Stores references to open window elements by app id

    // --- Tone.js Synth for Boot Sound ---
    const bootSynth = new Tone.Synth().toDestination();

    function playBootSound() {
        // Simple ascending arpeggio for a modern Windows boot sound feel
        const now = Tone.now();
        bootSynth.triggerAttackRelease("C4", "8n", now);
        bootSynth.triggerAttackRelease("E4", "8n", now + 0.1);
        bootSynth.triggerAttackRelease("G4", "8n", now + 0.2);
        bootSynth.triggerAttackRelease("C5", "4n", now + 0.3);
    }

    // --- Utility Functions ---

    // Function to display a custom message box
    function showMessage(message, duration = 3000) {
        const messageBox = document.getElementById('message-box');
        if (messageBox) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
                // Hide completely after transition
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Match CSS transition duration for opacity/transform
            }, duration);
        } else {
            console.warn('Message box element not found!');
        }
    }

    // --- Core OS Functions ---

    // Function to update time and date for both login screen and desktop shortcuts
    function updateTimeAndDate() {
        try {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };

            // Update login screen time and date
            if (loginTimeDisplay) loginTimeDisplay.textContent = now.toLocaleTimeString([], timeOptions);
            if (loginDateDisplay) loginDateDisplay.textContent = now.toLocaleDateString(undefined, dateOptions);

            // Update desktop shortcuts time and date (if desktop is visible)
            if (desktopTimeDisplay && desktopDateDisplay && desktopEnvContainer && desktopEnvContainer.classList.contains('desktop-active')) {
                desktopTimeDisplay.textContent = now.toLocaleTimeString([], timeOptions);
                desktopDateDisplay.textContent = now.toLocaleDateString(undefined, dateOptions);
            }
        } catch (error) {
            console.error('Error in updateTimeAndDate:', error);
            // showMessage(`Error updating time: ${error.message}`); // Optional: show user an error
        }
    }

    // Function to handle login transition
    function attemptLogin() {
        try {
            // Show spinner
            if (loginSpinner) loginSpinner.classList.add('show');

            // Play boot sound
            playBootSound();

            // Animate login screen fading out
            if (loginScreen) {
                anime({
                    targets: loginScreen,
                    opacity: 0,
                    duration: 800, // Longer duration for effect with spinner
                    easing: 'easeOutQuad',
                    complete: function() {
                        if (loginScreen) loginScreen.classList.add('hidden'); // Completely hide login screen
                        if (loginSpinner) loginSpinner.classList.remove('show'); // Hide spinner

                        // Unblur the desktop environment and make it the active display
                        if (desktopEnvContainer) {
                            desktopEnvContainer.classList.remove('blurred');
                            desktopEnvContainer.classList.add('desktop-active'); // Mark as active desktop
                        }
                    }
                });
            } else {
                console.error('loginScreen not found for animation.');
                if (loginSpinner) loginSpinner.classList.remove('show'); // Hide spinner on error
            }
        } catch (error) {
            console.error('Error during login attempt:', error);
            showMessage(`Login failed: ${error.message}`);
            if (loginSpinner) loginSpinner.classList.remove('show'); // Ensure spinner is hidden on error
        }
    }

    // Handle Enter key press on password input for login
    function handleLoginEnter(event) {
        if (event.key === 'Enter') {
            attemptLogin();
        }
    }

    // Function to toggle Start Menu visibility
    function toggleStartMenu() {
        try {
            // Retrieve element when function is called, as 'startMenu' global might be null on initial script load
            const startMenuElement = document.getElementById('start-menu');
            if (startMenuElement) {
                startMenuElement.classList.toggle('hidden');
            } else {
                console.warn('Start menu element not found.');
            }
        } catch (error) {
            console.error('Error toggling start menu:', error);
            showMessage(`Error: Cannot open Start Menu`);
        }
    }

    // Function to hide all context menus
    function hideAllContextMenus() {
        try {
            const desktopContextMenuElement = document.getElementById('desktop-context-menu');
            if (desktopContextMenuElement) {
                desktopContextMenuElement.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error hiding all context menus:', error);
        }
    }

    // Show desktop context menu
    function showContextMenu(event) {
        event.preventDefault(); // Prevent default browser context menu
        hideAllContextMenus(); // This will now get the element itself

        try {
            const desktopContextMenuElement = document.getElementById('desktop-context-menu');
            if (desktopContextMenuElement) {
                desktopContextMenuElement.style.left = `${event.clientX}px`;
                desktopContextMenuElement.style.top = `${event.clientY}px`;
                desktopContextMenuElement.classList.remove('hidden');
            } else {
                console.warn('Desktop context menu element not found.');
            }
        } catch (error) {
            console.error('Error showing context menu:', error);
            showMessage(`Error: Cannot display context menu`);
        }
    }

    // Hide desktop context menu
    function hideContextMenu() {
        try {
            const desktopContextMenuElement = document.getElementById('desktop-context-menu');
            if (desktopContextMenuElement) {
                desktopContextMenuElement.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error hiding context menu:', error);
        }
    }


    // Draggable and Resizable Window Logic
    function makeWindowDraggableAndResizable(windowElement, appId) {
        const header = windowElement.querySelector('.window-header');
        let isDragging = false;
        let isResizing = false;
        let currentX, currentY, initialX, initialY;
        let initialWidth, initialHeight;

        // Z-index management: bring clicked window to front
        windowElement.addEventListener('mousedown', () => {
            zIndexCounter++;
            windowElement.style.zIndex = zIndexCounter;
        });

        // Dragging
        if (header) {
            header.addEventListener('mousedown', (e) => {
                try {
                    if (windowElement.classList.contains('maximized')) return; // Cannot drag when maximized
                    isDragging = true;
                    initialX = e.clientX - windowElement.getBoundingClientRect().left;
                    initialY = e.clientY - windowElement.getBoundingClientRect().top;
                    header.style.cursor = 'grabbing';
                } catch (error) {
                    console.error('Error on header mousedown:', error);
                }
            });
        }

        // Event listener for mousemove on the whole document for dragging/resizing
        document.addEventListener('mousemove', (e) => {
            try {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    // Constrain window to desktop bounds
                    // Ensure 'desktop' element is available before calling getBoundingClientRect
                    const desktopElement = document.getElementById('desktop');
                    if (!desktopElement) {
                        console.error('Desktop element not found for drag/resize bounds.');
                        return;
                    }
                    const desktopRect = desktopElement.getBoundingClientRect();
                    const windowRect = windowElement.getBoundingClientRect();

                    currentX = Math.max(desktopRect.left, Math.min(currentX, desktopRect.right - windowRect.width));
                    currentY = Math.max(desktopRect.top, Math.min(currentY, desktopRect.bottom - windowRect.height));

                    windowElement.style.left = `${currentX}px`;
                    windowElement.style.top = `${currentY}px`;
                    windowElement.style.transform = 'none'; // Remove centering transform when dragged
                } else if (isResizing) {
                    e.preventDefault();
                    const newWidth = e.clientX - windowElement.getBoundingClientRect().left;
                    const newHeight = e.clientY - windowElement.getBoundingClientRect().top;

                    // Enforce minimum size
                    windowElement.style.width = `${Math.max(newWidth, windowElement.minWidth || 300)}px`;
                    windowElement.style.height = `${Math.max(newHeight, windowElement.minHeight || 200)}px`;
                }
            } catch (error) {
                console.error('Error during window drag/resize:', error);
                isDragging = false; // Stop operation on error
                isResizing = false;
                document.body.style.cursor = 'default';
            }
        });

        // Event listener for mouseup on the whole document to stop dragging/resizing
        document.addEventListener('mouseup', () => {
            try {
                isDragging = false;
                isResizing = false;
                if (header) header.style.cursor = 'grab'; // Restore cursor if header exists
                document.body.style.cursor = 'default';
            } catch (error) {
                console.error('Error on mouseup:', error);
            }
        });


        // Resizing (custom handle)
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        windowElement.appendChild(resizeHandle);

        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', (e) => {
                try {
                    if (windowElement.classList.contains('maximized')) return; // Cannot resize when maximized
                    isResizing = true;
                    initialX = e.clientX;
                    initialY = e.clientY;
                    initialWidth = windowElement.offsetWidth;
                    initialHeight = windowElement.offsetHeight;
                    e.stopPropagation(); // Prevent dragging from starting
                } catch (error) {
                    console.error('Error on resize handle mousedown:', error);
                }
            });
        }

        // Window controls
        const minimizeBtn = windowElement.querySelector('.minimize-btn');
        const maximizeRestoreBtn = windowElement.querySelector('.maximize-restore-btn');
        const closeBtn = windowElement.querySelector('.close-btn');
        // taskbarIcon handling is removed

        // Minimize
        if (minimizeBtn) {
            minimizeBtn.addEventListener('click', () => {
                try {
                    // Minimized windows just hide, no taskbar icon
                    windowElement.classList.add('minimized');
                } catch (error) {
                    console.error('Error minimizing window:', error);
                    showMessage(`Error minimizing ${appId}`);
                }
            });
        }

        // Maximize/Restore
        if (maximizeRestoreBtn) {
            maximizeRestoreBtn.addEventListener('click', () => {
                try {
                    if (windowElement.classList.contains('maximized')) {
                        // Restore
                        windowElement.classList.remove('maximized');
                        maximizeRestoreBtn.innerHTML = '<i class="fa-regular fa-square"></i>'; // Maximize icon
                        // Restore previous position and size if stored
                        if (windowElement.dataset.prevLeft && windowElement.dataset.prevTop &&
                            windowElement.dataset.prevWidth && windowElement.dataset.prevHeight) {
                            windowElement.style.left = windowElement.dataset.prevLeft;
                            windowElement.style.top = windowElement.dataset.prevTop;
                            windowElement.style.width = windowElement.dataset.prevWidth;
                            windowElement.style.height = windowElement.dataset.prevHeight;
                            windowElement.style.transform = windowElement.dataset.prevTransform || '';
                        }
                    } else {
                        // Maximize
                        // Store current position and size
                        windowElement.dataset.prevLeft = windowElement.style.left;
                        windowElement.dataset.prevTop = windowElement.style.top;
                        windowElement.dataset.prevWidth = windowElement.style.width;
                        windowElement.dataset.prevHeight = windowElement.style.height;
                        windowElement.dataset.prevTransform = windowElement.style.transform;

                        windowElement.classList.add('maximized');
                        maximizeRestoreBtn.innerHTML = '<i class="fa-solid fa-compress"></i>'; // Restore icon
                    }
                } catch (error) {
                    console.error('Error maximizing/restoring window:', error);
                    showMessage(`Error with ${appId} window size`);
                }
            });
        }

        // Close
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                try {
                    // Add closing animation class
                    windowElement.classList.add('closing');

                    // Listen for animation end before removing
                    windowElement.addEventListener('animationend', () => {
                        windowElement.remove();
                        delete openWindows[appId];
                    }, { once: true }); // Ensure listener runs only once
                } catch (error) {
                    console.error('Error closing window:', error);
                    showMessage(`Error closing ${appId}`);
                }
            });
        }
    }

    // Function to handle tab switching specifically for the "About Windows 13" app
    function showAboutTabForApp(parentWindow, tabName) {
        const aboutContent = parentWindow.querySelector('#about-content');
        const updatesContent = parentWindow.querySelector('#updates-content');
        const aboutTabBtn = parentWindow.querySelector('#about-tab-btn');
        const updatesTabBtn = parentWindow.querySelector('#updates-tab-btn');

        if (tabName === 'about') {
            if(aboutContent) aboutContent.classList.remove('hidden');
            if(updatesContent) updatesContent.classList.add('hidden');
            if(aboutTabBtn) {
                aboutTabBtn.classList.add('bg-blue-700');
                aboutTabBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
            }
            if(updatesTabBtn) {
                updatesTabBtn.classList.remove('bg-blue-700');
                updatesTabBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
            }
        } else if (tabName === 'updates') {
            if(aboutContent) aboutContent.classList.add('hidden');
            if(updatesContent) updatesContent.classList.remove('hidden');
            if(aboutTabBtn) {
                aboutTabBtn.classList.remove('bg-blue-700');
                aboutTabBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
            }
            if(updatesTabBtn) {
                updatesTabBtn.classList.add('bg-blue-700');
                updatesTabBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
            }
        }
    }

    // Function to display content in the settings app based on selected category
    function showSettingsCategory(settingsWindowElement, categoryId) {
        // Hide all content divs
        settingsWindowElement.querySelectorAll('.settings-content-area > div').forEach(div => {
            div.classList.add('hidden');
        });
        // Remove active class from all sidebar items
        settingsWindowElement.querySelectorAll('.settings-category-item').forEach(item => {
            item.classList.remove('active');
        });

        // Show the selected content div
        const selectedContent = settingsWindowElement.querySelector(`#${categoryId}-content`);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }

        // Add active class to the selected sidebar item
        const selectedSidebarItem = settingsWindowElement.querySelector(`[data-category-id="${categoryId}"]`);
        if (selectedSidebarItem) {
            selectedSidebarItem.classList.add('active');
        }

        // Special handling for "Accounts" and "Personalization" to load/update data
        if (categoryId === 'accounts') {
            const accountsUsernameInput = settingsWindowElement.querySelector('#accounts-username-input');
            const accountsPasswordInput = settingsWindowElement.querySelector('#accounts-password-input');
            if (accountsUsernameInput) accountsUsernameInput.value = window.userPreferences.username;
            if (accountsPasswordInput) accountsPasswordInput.value = window.userPreferences.password; // Insecure for production
        } else if (categoryId === 'personalization') {
            const currentWallpaperPreview = settingsWindowElement.querySelector('#current-wallpaper-preview');
            if (currentWallpaperPreview) {
                // Remove the "url()" and apply to background-image directly
                currentWallpaperPreview.style.backgroundImage = window.desktopEnvContainer.style.getPropertyValue('--desktop-image');
            }
            const wallpaperUrlInput = settingsWindowElement.querySelector('#wallpaper-url-input');
            if (wallpaperUrlInput) {
                // Set the input value to the current wallpaper URL (if not a predefined one)
                const currentWallpaper = window.userPreferences.wallpaperUrl;
                // If it's a predefined asset, don't show the URL in the input
                if (!currentWallpaper.startsWith('Assets/Background/')) {
                    wallpaperUrlInput.value = currentWallpaper;
                } else {
                    wallpaperUrlInput.value = ''; // Clear if it's a default asset
                }
            }
        }
    }

    // Open Application Window
    function openApp(appName, appId) {
        try {
            hideAllContextMenus();
            hideContextMenu();
            toggleStartMenu(); // Close start menu when an app is opened from it

            if (openWindows[appId]) {
                // If app is already open, bring it to front or restore if minimized
                const existingWindow = openWindows[appId];
                if (existingWindow.classList.contains('minimized')) {
                    existingWindow.classList.remove('minimized');
                }
                zIndexCounter++;
                existingWindow.style.zIndex = zIndexCounter;
                return;
            }

            // Ensure windowsContainer is defined when creating new windows
            const currentWindowsContainer = document.getElementById('windows-container');
            if (!currentWindowsContainer) {
                console.error('Windows container not found, cannot open app.');
                showMessage(`Error: System UI problem, cannot open ${appName}`);
                return;
            }

            zIndexCounter++; // Increment z-index for new window

            const windowElement = document.createElement('div');
            windowElement.id = `window-${appId}`;
            // Removed specific Tailwind classes here to rely on CSS variables for theming
            windowElement.className = `window flex flex-col opening`;
            windowElement.style.zIndex = zIndexCounter;
            windowElement.style.width = '70%'; // Initial width
            windowElement.style.height = '70%'; // Initial height
            // Centering is handled by CSS transform initially

            // Re-enable pointer events for the new window
            windowElement.style.pointerEvents = 'auto';


            let contentHTML = '';
            let iconHTML = ''; // Use iconHTML for the actual icon/image tag
            let bigIconHTML = ''; // For the large icon in the content area

            switch (appId) {
                case 'file-explorer':
                    iconHTML = '<i class="fa-solid fa-folder-open text-blue-400 text-lg"></i>';
                    bigIconHTML = '<i class="fa-solid fa-folder-open text-blue-400 text-8xl mb-4 opacity-50"></i>';
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <h3 class="text-xl font-semibold mb-3 relative z-10">My PC</h3>
                            <ul class="space-y-2 text-center relative z-10">
                                <li class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-hard-drive text-gray-500"></i> Local Disk (C:)
                                </li>
                                <li class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-folder text-yellow-500"></i> Documents
                                </li>
                                <li class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-folder text-yellow-500"></i> Downloads
                                </li>
                                <li class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-image text-purple-500"></i> Pictures
                                </li>
                                <li class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-music text-green-500"></i> Music
                                </li>
                                <li class="flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-video text-red-500"></i> Videos
                                </li>
                            </ul>
                            <div class="mt-4 p-3 bg-gray-800 rounded-md relative z-10">
                                <p class="text-sm">Welcome to your Windows 13 File Explorer! This is a simplified concept.</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'browser':
                    iconHTML = '<i class="fa-solid fa-globe text-purple-400 text-lg"></i>';
                    bigIconHTML = '<i class="fa-solid fa-globe text-purple-400 text-8xl mb-4 opacity-50"></i>';
                    contentHTML = `
                        <div class="flex items-center p-2 bg-gray-800 rounded-b-none border-b border-gray-700 relative z-10">
                            <input type="text" class="flex-grow rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value="https://www.conceptbrowser.com" readonly>
                            <button class="ml-2 p-1 rounded-full text-gray-400"><i class="fa-solid fa-sync"></i></button>
                        </div>
                        <div class="p-4 flex-grow overflow-auto text-center flex flex-col items-center justify-center relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <p class="text-lg text-gray-400 relative z-10">Welcome to the future of browsing!</p>
                            <p class="text-sm text-gray-500 mt-2 relative z-10">This is a conceptual browser for Windows 13.</p>
                        </div>
                    `;
                    break;
                case 'terminal':
                    iconHTML = '<i class="fa-solid fa-terminal text-green-400 text-lg"></i>';
                    bigIconHTML = '<i class="fa-solid fa-terminal text-green-400 text-8xl mb-4 opacity-50"></i>';
                    contentHTML = `
                        <div class="p-4 flex-grow font-mono text-sm overflow-auto bg-black text-green-300 rounded-b-lg relative">
                             <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <p class="relative z-10"><span class="text-blue-400">user@Windows13</span>:<span class="text-purple-400">/home/user</span>$ ls -la</p>
                            <p class="text-yellow-300 relative z-10">total 16</p>
                            <p class="relative z-10">drwxr-xr-x 4 user user 4096 Jun 15 05:26 .</p>
                            <p class="relative z-10">drwxr-xr-x 3 user user 4096 Jun 15 05:20 ..</p>
                            <p class="relative z-10">drwxr-xr-x 2 user user 4096 Jun 15 05:26 Documents</p>
                            <p class="relative z-10">drwxr-xr-x 2 user user 4096 Jun 15 05:26 Desktop</p>
                            <p class="relative z-10"><span class="text-blue-400">user@Windows13</span>:<span class="text-purple-400">/home/user</span>$ echo "Hello from Windows 13!"</p>
                            <p class="relative z-10">Hello from Windows 13!</p>
                            <p class="relative z-10"><span class="text-blue-400">user@Windows13</span>:<span class="text-purple-400">/home/user</span>$ _</p>
                        </div>
                    `;
                    break;
                case 'solar-panel':
                    iconHTML = '<i class="fa-solid fa-solar-panel text-yellow-400 text-lg"></i>';
                    bigIconHTML = '<i class="fa-solid fa-solar-panel text-yellow-400 text-8xl mb-4 opacity-50"></i>';
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <h3 class="text-2xl font-bold text-yellow-300 mb-2 relative z-10">Solar Panel Dashboard</h3>
                            <p class="text-gray-300 max-w-sm relative z-10">
                                Monitor your solar energy production and consumption in real-time. This is a conceptual application.
                            </p>
                            <div class="mt-4 text-sm relative z-10">
                                <p>Current Output: <span class="font-bold text-green-400">1.2 kW</span></p>
                                <p>Daily Production: <span class="font-bold text-blue-400">8.5 kWh</span></p>
                            </div>
                            <button class="mt-6 bg-gradient-to-r from-yellow-600 to-orange-500 text-white rounded-full shadow-lg hover:from-yellow-700 hover:to-orange-600 relative z-10">
                                View Analytics
                            </button>
                        </div>
                    `;
                    break;
                case 'settings':
                    iconHTML = '<i class="fa-solid fa-gear text-gray-400 text-lg"></i>';
                    // Settings app has a sidebar, so the main icon isn't needed in content
                    contentHTML = `
                        <div class="flex flex-row flex-grow">
                            <div class="settings-sidebar">
                                <h3 class="text-lg font-semibold mb-4 text-blue-400">Settings</h3>
                                <ul class="space-y-1">
                                    <li class="settings-category-item" data-category-id="system" onclick="showSettingsCategory(this.closest('.window'), 'system')">
                                        <i class="fa-solid fa-desktop"></i><span>System</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="network" onclick="showSettingsCategory(this.closest('.window'), 'network')">
                                        <i class="fa-solid fa-wifi"></i><span>Network & Internet</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="personalization" onclick="showSettingsCategory(this.closest('.window'), 'personalization')">
                                        <i class="fa-solid fa-brush"></i><span>Personalization</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="accounts" onclick="showSettingsCategory(this.closest('.window'), 'accounts')">
                                        <i class="fa-solid fa-user-circle"></i><span>Accounts</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="update-security" onclick="showSettingsCategory(this.closest('.window'), 'update-security')">
                                        <i class="fa-solid fa-shield-alt"></i><span>Update & Security</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="about" onclick="showSettingsCategory(this.closest('.window'), 'about')">
                                        <i class="fa-solid fa-info-circle"></i><span>About</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="settings-content-area">
                                <!-- System Settings Content -->
                                <div id="system-content" class="hidden">
                                    <h4 class="text-xl font-semibold mb-4">System</h4>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between">
                                            <span class="text-gray-300">Display Settings:</span>
                                            <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md" onclick="openApp('Display Settings', 'display-settings'); this.closest('.window').querySelector('.close-btn').click();">Open</button>
                                        </div>
                                        <div>
                                            <label for="sound-output" class="block text-sm font-medium text-gray-400 mb-1">Sound Output</label>
                                            <select id="sound-output" class="w-full rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option>Speakers (Realtek Audio)</option>
                                                <option>Headphones</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-6 p-3 bg-gray-800 rounded-md">
                                        <p class="text-sm text-gray-400">Manage display, sound, notifications, power, and battery settings.</p>
                                    </div>
                                </div>

                                <!-- Network & Internet Content -->
                                <div id="network-content" class="hidden">
                                    <h4 class="text-xl font-semibold mb-4">Network & Internet</h4>
                                    <p class="text-gray-300 mb-4">Manage your Wi-Fi, Ethernet, VPN, and other network settings.</p>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-300">Wi-Fi:</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" value="" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Personalization Content -->
                                <div id="personalization-content" class="hidden">
                                    <h4 class="text-xl font-semibold mb-4">Personalization</h4>
                                    <p class="text-gray-300 mb-4">Change your background, colors, lock screen, and themes.</p>
                                    <div class="flex flex-col gap-4">
                                        <h5 class="font-semibold text-gray-200">Desktop Background</h5>
                                        <div id="current-wallpaper-preview" class="w-full h-32 bg-gray-700 rounded-lg bg-cover bg-center mb-2" style="background-image: var(--desktop-image);"></div>
                                        <p class="text-sm text-gray-400 mb-2">Choose from predefined or enter a custom URL.</p>

                                        <div class="grid grid-cols-2 gap-2 mb-4">
                                            <img src="Assets/Background/BackgroundV2.png" alt="Default Wallpaper" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('Assets/Background/BackgroundV2.png', this)">
                                            <img src="https://placehold.co/400x240/007bff/ffffff?text=Blue+Gradient" alt="Blue Gradient" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('https://placehold.co/400x240/007bff/ffffff?text=Blue+Gradient', this)">
                                            <img src="https://placehold.co/400x240/28a745/ffffff?text=Green+Pattern" alt="Green Pattern" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('https://placehold.co/400x240/28a745/ffffff?text=Green+Pattern', this)">
                                            <img src="https://placehold.co/400x240/6f42c1/ffffff?text=Purple+Abstract" alt="Purple Abstract" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('https://placehold.co/400x240/6f42c1/ffffff?text=Purple+Abstract', this)">
                                        </div>

                                        <label for="wallpaper-url-input" class="block text-sm font-medium text-gray-400 mb-1">Custom Wallpaper URL</label>
                                        <input type="text" id="wallpaper-url-input" class="w-full" placeholder="Enter image URL">
                                        <button class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md" onclick="applyCustomWallpaper()">Apply Custom Wallpaper</button>
                                        <button class="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="saveUserPreferences()">Save Wallpaper</button>
                                    </div>
                                </div>

                                <!-- Accounts Content -->
                                <div id="accounts-content" class="hidden">
                                    <h4 class="text-xl font-semibold mb-4">Accounts</h4>
                                    <p class="text-gray-300 mb-4">Manage your user accounts and sign-in options.</p>
                                    <div class="flex flex-col gap-4">
                                        <div class="flex items-center gap-4 p-3 bg-gray-800 rounded-md">
                                            <div class="profile-pic-login w-16 h-16 text-3xl mx-0 my-0">
                                                <i class="fa-solid fa-user"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-lg" id="current-username-display">User Name</p>
                                                <p class="text-sm text-gray-400">Administrator</p>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="accounts-username-input" class="block text-sm font-medium text-gray-400 mb-1">Change Username</label>
                                            <input type="text" id="accounts-username-input" class="w-full" placeholder="New Username" value="${window.userPreferences.username}">
                                        </div>
                                        <div>
                                            <label for="accounts-password-input" class="block text-sm font-medium text-gray-400 mb-1">Change Password</label>
                                            <input type="password" id="accounts-password-input" class="w-full" placeholder="New Password (for demo only)" value="${window.userPreferences.password}">
                                            <p class="text-xs text-red-400 mt-1">Warning: In a real application, passwords should be hashed and never stored directly.</p>
                                        </div>
                                        <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="updateAccountDetails()">Save Account Changes</button>
                                    </div>
                                </div>

                                <!-- Update & Security Content -->
                                <div id="update-security-content" class="hidden">
                                    <h4 class="text-xl font-semibold mb-4">Update & Security</h4>
                                    <p class="text-gray-300 mb-4">Windows Update, Delivery Optimization, Windows Security, Backup, Troubleshoot, Recovery.</p>
                                    <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="showMessage('Checking for updates...');">Check for Updates</button>
                                    <div class="mt-4 p-3 bg-gray-800 rounded-md">
                                        <p class="text-sm text-gray-400">Last checked: Just now</p>
                                        <p class="text-sm text-gray-400">Updates are available (conceptual)!</p>
                                    </div>
                                </div>

                                <!-- About Settings Content -->
                                <div id="about-content" class="hidden">
                                    <h4 class="text-xl font-semibold mb-4">About</h4>
                                    <p class="text-gray-300 mb-4">
                                        Windows 13 Concept
                                    </p>
                                    <p class="text-sm text-gray-400">
                                        Version: 0.3.73
                                    </p>
                                    <p class="text-sm text-gray-400">
                                        Build: 10.0.23456.789
                                    </p>
                                    <p class="text-sm text-gray-400">
                                        Processor: Conceptual Core i9-13900K
                                    </p>
                                    <p class="text-sm text-gray-400">
                                        Installed RAM: 32.0 GB
                                    </p>
                                    <div class="mt-4 p-3 bg-gray-800 rounded-md">
                                        <p class="text-sm text-gray-400">This is a conceptual representation of system information.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'about-windows':
                    iconHTML = '<img src="assets/Logo/Windows_13_logo.png" alt="Windows 13 Logo" class="w-5 h-5">'; // Smaller for header
                    bigIconHTML = '<img src="assets/Logo/Windows_13_logo.png" alt="Windows 13 Logo" class="w-20 h-20 mb-4 opacity-50">'; // Larger, semi-transparent
                    contentHTML = `
                        <div class="flex flex-col flex-grow relative">
                            <div class="flex border-b border-gray-700">
                                <button id="about-tab-btn" class="px-4 py-2 border-r border-gray-700 bg-blue-700 rounded-t-lg transition-colors">About</button>
                                <button id="updates-tab-btn" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 transition-colors">Updates</button>
                            </div>
                            <div id="about-content" class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center text-center">
                                ${bigIconHTML}
                                <h3 class="text-xl font-semibold mb-3">About Windows 13 Concept</h3>
                                <p class="text-gray-300 mb-4">
                                    Welcome to Windows 13, a conceptual operating system designed to showcase modern UI/UX principles.
                                    This is a preview of what the future of desktop computing could look like.
                                </p>
                                <p class="text-gray-400 mt-4">
                                    For a glimpse into past concepts, you might be interested in the
                                    <a href="https://lttthedev.github.io/desktop.html" target="_blank" class="text-blue-400 hover:underline">Windows 12 demo website</a>.
                                </p>
                            </div>
                            <div id="updates-content" class="p-4 flex-grow overflow-auto hidden flex flex-col items-center justify-center text-center">
                                ${bigIconHTML}
                                <h3 class="text-xl font-semibold mb-3">Windows 13 Updates</h3>
                                <!-- NEW UPDATE ENTRY START -->
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.95</p>
                                    <p class="text-blue-400 mb-2">Codename: Background remake & Login change info</p>
                                    <p class="text-gray-300">
                                        This update introduces significant visual enhancements, allowing users to customize their desktop
                                        backgrounds with both predefined options and custom image URLs. Additionally, the login screen
                                        now includes improved informational displays, providing clearer feedback during the sign-in process.
                                        These changes aim to personalize the user experience and streamline initial system access.
                                    </p>
                                </div>
                                <!-- NEW UPDATE ENTRY END -->
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.9</p>
                                    <p class="text-blue-400 mb-2">Codename: Layout change & Start Menu change</p>
                                    <p class="text-gray-300">
                                        This update brings a significant overhaul to the desktop layout.
                                        The taskbar has been removed, integrating its core functionalities into the Start Menu.
                                        The desktop now features a left-aligned icon zone and a right-aligned "Shortcuts" area,
                                        which prominently displays the time and date, now clickable to open the new "Date/Time" application.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.8</p>
                                    <p class="text-blue-400 mb-2">Codename: Scrolling added</p>
                                    <p class="text-gray-300">
                                        This mini-update ensures that various application windows and content areas within the OS
                                        now correctly support scrolling when their content exceeds the visible area.
                                        This improves usability and access to information in apps like File Explorer, Terminal,
                                        and other dynamic content displays.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.73</p>
                                    <p class="text-blue-400 mb-2">Codename: Boot up sound Update & Loading Update</p>
                                    <p class="text-gray-300">
                                        This significant update enhances the user's initial experience by refining the boot-up sound for a more pleasing auditory feedback.
                                        Additionally, the loading spinner throughout the system has been redesigned to align with modern Windows aesthetics, offering a smoother and more visually appealing waiting indicator.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.4</p>
                                    <p class="text-blue-400 mb-2">Codename: Login Patch & boot up sounds</p>
                                    <p class="text-gray-300">
                                        This update revamps the login screen with a modern aesthetic and introduces a subtle boot-up sound for a more immersive experience.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.0</p>
                                    <p class="text-blue-400 mb-2">Codename: Desktop columns & a Windows Update setting (alpha version)</p>
                                    <p class="text-gray-300 text-sm">
                                        This update introduces a more organized desktop layout with columns and adds
                                        a conceptual Windows Update setting for future expansion.
                                    </p>
                                </div>
                                <p class="text-gray-500 text-sm mt-4">Check back for more exciting updates!</p>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    iconHTML = '<i class="fa-solid fa-cube text-gray-400 text-lg"></i>';
                    bigIconHTML = '<i class="fa-solid fa-cube text-gray-400 text-8xl mb-4 opacity-50"></i>';
                    contentHTML = `<div class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center relative"><div class="absolute inset-0 flex items-center justify-center pointer-events-none">${bigIconHTML}</div><h1>${appName}</h1><p>Welcome to ${appName}!</p></div>`;
            }

            windowElement.innerHTML = `
                <div class="window-header flex items-center justify-between p-3">
                    <div class="flex items-center gap-2">
                        ${iconHTML}
                        <span class="text-md font-semibold">${appName}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="minimize-btn">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <button class="maximize-restore-btn">
                            <i class="fa-regular fa-square"></i>
                        </button>
                        <button class="close-btn">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                <div class="window-content flex-grow overflow-auto relative">
                    ${contentHTML}
                </div>
            `;

            currentWindowsContainer.appendChild(windowElement); // Use the locally retrieved windowsContainer
            openWindows[appId] = windowElement;

            makeWindowDraggableAndResizable(windowElement, appId);

            // Remove opening animation class after it completes
            windowElement.addEventListener('animationend', () => {
                windowElement.classList.remove('opening');
            }, { once: true });

            // Manually trigger tab content display and attach listeners for "About Windows 13" if it was just opened
            if (appId === 'about-windows') {
                // Defer call slightly to ensure DOM elements within the newly created window are available
                setTimeout(() => {
                    const aboutTabBtn = windowElement.querySelector('#about-tab-btn');
                    const updatesTabBtn = windowElement.querySelector('#updates-tab-btn');

                    // Attach listeners to the tab buttons using the new function
                    if (aboutTabBtn) aboutTabBtn.addEventListener('click', () => showAboutTabForApp(windowElement, 'about'));
                    if (updatesTabBtn) updatesTabBtn.addEventListener('click', () => showAboutTabForApp(windowElement, 'updates'));

                    // Set initial tab
                    showAboutTabForApp(windowElement, 'about');
                }, 50); // Small delay
            }
            // Initialize Calculator logic if the Calculator app was just opened
            if (appId === 'calculator') {
                setTimeout(() => {
                    initializeCalculator(windowElement);
                }, 100); // Small delay to ensure elements are rendered
            }
            // Initialize To-Do List logic if the To-Do List app was just opened
            if (appId === 'todo-list') {
                setTimeout(() => {
                    initializeTodoList(windowElement);
                }, 100); // Small delay to ensure elements are rendered
            }
            // Initialize Display Settings logic if the Display Settings app was just opened
            if (appId === 'display-settings') {
                setTimeout(() => {
                    initializeDisplaySettings(windowElement);
                }, 100); // Small delay to ensure elements are rendered
                    const themeModeToggle = windowElement.querySelector('#theme-mode');
                    if (themeModeToggle) {
                        // Initialize the toggle state based on current body class
                        themeModeToggle.checked = document.body.classList.contains('light-mode');

                        themeModeToggle.addEventListener('change', () => {
                            if (themeModeToggle.checked) {
                                document.body.classList.add('light-mode');
                                window.userPreferences.theme = 'light-mode';
                            } else {
                                document.body.classList.remove('light-mode');
                                window.userPreferences.theme = 'dark-mode';
                            }
                            saveUserPreferences(); // Save theme preference
                        });
                    }
            }
            // Initialize Settings logic if the Settings app was just opened
            if (appId === 'settings') {
                setTimeout(() => {
                    // Set default category for settings
                    showSettingsCategory(windowElement, 'system');

                    // Attach event listeners to sidebar items
                    windowElement.querySelectorAll('.settings-category-item').forEach(item => {
                        item.addEventListener('click', () => {
                            showSettingsCategory(windowElement, item.dataset.categoryId);
                        });
                    });
                }, 100);
            }
            // Initialize Date and Time app logic if it was just opened
            if (appId === 'date-time') {
                setTimeout(() => {
                    updateDateTimeApp(windowElement); // Initial update
                    setInterval(() => updateDateTimeApp(windowElement), 1000); // Update every second
                }, 100);
            }

        } catch (error) {
            console.error(`Error opening app ${appName}:`, error);
            showMessage(`Error opening ${appName}: ${error.message}`);
        }
    }

    // --- Calculator Logic ---
    function initializeCalculator(calculatorWindowElement) {
        const display = calculatorWindowElement.querySelector('#calc-display');
        const buttons = calculatorWindowElement.querySelectorAll('.calc-btn');
        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        let waitingForSecondOperand = false;

        function updateDisplay() {
            display.value = currentInput;
        }

        function clearCalculator() {
            currentInput = '0';
            operator = null;
            firstOperand = null;
            waitingForSecondOperand = false;
            updateDisplay();
        }

        function inputDigit(digit) {
            if (waitingForSecondOperand) {
                currentInput = digit;
                waitingForSecondOperand = false;
            } else {
                currentInput = currentInput === '0' ? digit : currentInput + digit;
            }
            updateDisplay();
        }

        function inputDecimal() {
            if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            const inputValue = parseFloat(currentInput);

            if (operator && waitingForSecondOperand) {
                operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                firstOperand = inputValue;
            } else if (operator) {
                const result = operate(firstOperand, inputValue, operator);
                currentInput = String(result);
                firstOperand = result;
            }

            waitingForSecondOperand = true;
            operator = nextOperator;
            updateDisplay();
        }

        function operate(num1, num2, op) {
            switch (op) {
                case '+': return num1 + num2;
                case '-': return num1 - num2;
                case '*': return num1 * num2;
                case '/':
                    if (num2 === 0) {
                        showMessage('Error: Division by zero!');
                        return 0; // Or handle as an error state
                    }
                    return num1 / num2;
                default: return num2;
            }
        }

        buttons.forEach(button => {
            button.addEventListener('click', (event) => {
                const { textContent } = event.target;

                if (textContent === 'C') {
                    clearCalculator();
                    return;
                }
                if (textContent === '\u2190') { // Left arrow for backspace
                    currentInput = currentInput.slice(0, -1) || '0';
                    updateDisplay();
                    return;
                }
                if (textContent === '.') {
                    inputDecimal();
                    return;
                }
                if (['+', '-', '*', '/', '='].includes(textContent)) {
                    handleOperator(textContent);
                    return;
                }

                inputDigit(textContent);
            });
        });

        updateDisplay(); // Initial display update
    }

    // --- To-Do List Logic ---
    function initializeTodoList(todoWindowElement) {
        const todoInput = todoWindowElement.querySelector('#todo-input');
        const addTodoBtn = todoWindowElement.querySelector('#add-todo-btn');
        const todoListItems = todoWindowElement.querySelector('#todo-list-items');

        function addTask() {
            const taskText = todoInput.value.trim();
            if (taskText === '') {
                showMessage('Please enter a task!');
                return;
            }

            const listItem = document.createElement('li');
            listItem.className = 'flex items-center bg-gray-800 p-2 rounded-md justify-between';
            listItem.innerHTML = `
                <span>${taskText}</span>
                <button class="text-red-400 hover:text-red-500 text-sm delete-todo-btn">Delete</button>
            `;

            listItem.querySelector('.delete-todo-btn').addEventListener('click', () => {
                listItem.remove();
            });

            todoListItems.appendChild(listItem);
            todoInput.value = ''; // Clear input
            showMessage('Task added!');
        }

        if (addTodoBtn) {
            addTodoBtn.addEventListener('click', addTask);
        }
        if (todoInput) {
            todoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        }

        // Re-attach listeners to pre-existing (sample) delete buttons if any
        todoListItems.querySelectorAll('.delete-todo-btn').forEach(button => {
            button.onclick = function() { this.parentElement.remove(); };
        });
    }

    // --- Display Settings Logic ---
    function initializeDisplaySettings(displaySettingsWindowElement) {
        const scaleSlider = displaySettingsWindowElement.querySelector('#scale');
        const scaleValueSpan = displaySettingsWindowElement.querySelector('#scale-value');
        const brightnessSlider = displaySettingsWindowElement.querySelector('#brightness');
        const nightLightToggle = displaySettingsWindowElement.querySelector('#night-light');
        const desktopEnv = document.getElementById('desktop-env-container'); // Get the main desktop container

        // --- Scale Slider (Conceptual) ---
        if (scaleSlider && scaleValueSpan) {
            scaleSlider.addEventListener('input', () => {
                scaleValueSpan.textContent = `${scaleSlider.value}%`;
                showMessage(`Desktop scale set to ${scaleSlider.value}% (conceptual)`);
            });
        }

        // --- Brightness Slider ---
        if (brightnessSlider && desktopEnv) {
            // Set initial brightness based on slider value
            desktopEnv.style.setProperty('--desktop-brightness-value', `${brightnessSlider.value}%`);
            // Apply initial filter based on whether night light is active
            if (!desktopEnv.classList.contains('night-light-active')) {
                 desktopEnv.style.filter = `brightness(${brightnessSlider.value}%)`;
            } else {
                desktopEnv.style.filter = `brightness(${brightnessSlider.value}%) sepia(0.3) hue-rotate(-20deg)`;
            }

            brightnessSlider.addEventListener('input', () => {
                desktopEnv.style.setProperty('--desktop-brightness-value', `${brightnessSlider.value}%`);
                if (!desktopEnv.classList.contains('night-light-active')) {
                    desktopEnv.style.filter = `brightness(${brightnessSlider.value}%)`;
                } else {
                    desktopEnv.style.filter = `brightness(${brightnessSlider.value}%) sepia(0.3) hue-rotate(-20deg)`;
                }
            });
        }

        // --- Night Light Toggle ---
        if (nightLightToggle && desktopEnv) {
            // Set initial night light state based on its class
            nightLightToggle.checked = desktopEnv.classList.contains('night-light-active');

            nightLightToggle.addEventListener('change', () => {
                if (nightLightToggle.checked) {
                    desktopEnv.classList.add('night-light-active');
                    desktopEnv.style.filter = `brightness(${brightnessSlider.value || 100}%) sepia(0.3) hue-rotate(-20deg)`;
                } else {
                    desktopEnv.classList.remove('night-light-active');
                    desktopEnv.style.filter = `brightness(${brightnessSlider.value || 100}%)`;
                }
            });
        }

        // --- Resolution Dropdown (Conceptual) ---
        const resolutionSelect = displaySettingsWindowElement.querySelector('#resolution');
        if (resolutionSelect) {
            resolutionSelect.addEventListener('change', () => {
                showMessage(`Resolution set to ${resolutionSelect.value} (conceptual)`);
            });
        }

        // --- Theme Mode Toggle (Light/Dark) ---
        const themeModeToggle = displaySettingsWindowElement.querySelector('#theme-mode');
        if (themeModeToggle) {
            // Initialize the toggle state based on current body class
            themeModeToggle.checked = document.body.classList.contains('light-mode');

            themeModeToggle.addEventListener('change', () => {
                if (themeModeToggle.checked) {
                    document.body.classList.add('light-mode');
                    window.userPreferences.theme = 'light-mode';
                } else {
                    document.body.classList.remove('light-mode');
                    window.userPreferences.theme = 'dark-mode';
                }
                saveUserPreferences(); // Save theme preference
            });
        }
    }

    // Functions for Personalization section
    function selectWallpaper(url, element) {
        const currentWallpaperPreview = document.querySelector('#current-wallpaper-preview');
        const wallpaperUrlInput = document.querySelector('#wallpaper-url-input');

        // Update preview
        if (currentWallpaperPreview) {
            currentWallpaperPreview.style.backgroundImage = `url('${url}')`;
        }
        // Update global preference
        window.userPreferences.wallpaperUrl = url;
        // Clear custom URL input if a predefined one is selected
        if (wallpaperUrlInput) {
            wallpaperUrlInput.value = '';
        }

        // Add a visual indicator for selected wallpaper (optional, but good UX)
        document.querySelectorAll('#personalization-content img').forEach(img => {
            img.classList.remove('border-blue-500');
            img.classList.add('border-transparent');
        });
        element.classList.remove('border-transparent');
        element.classList.add('border-blue-500');

        showMessage('Wallpaper preview updated. Click "Save Wallpaper" to apply permanently.');
    }

    function applyCustomWallpaper() {
        const wallpaperUrlInput = document.querySelector('#wallpaper-url-input');
        if (wallpaperUrlInput && wallpaperUrlInput.value.trim() !== '') {
            const url = wallpaperUrlInput.value.trim();
            selectWallpaper(url, wallpaperUrlInput); // Pass input element as 'element' for selection highlight (optional)
        } else {
            showMessage('Please enter a valid image URL.');
        }
    }

    // Function for Accounts section
    function updateAccountDetails() {
        const accountsUsernameInput = document.querySelector('#accounts-username-input');
        const accountsPasswordInput = document.querySelector('#accounts-password-input');

        if (accountsUsernameInput) {
            window.userPreferences.username = accountsUsernameInput.value.trim();
        }
        if (accountsPasswordInput) {
            // WARNING: Storing plain text password for demo purposes.
            // In a real application, passwords must be securely hashed on the server side.
            window.userPreferences.password = accountsPasswordInput.value;
        }
        saveUserPreferences();
    }


    // --- Date and Time App Logic ---
    function updateDateTimeApp(appWindowElement) {
        const appTimeDisplay = appWindowElement.querySelector('#app-time');
        const appDateDisplay = appWindowElement.querySelector('#app-date');
        const now = new Date();
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

        if (appTimeDisplay) appTimeDisplay.textContent = now.toLocaleTimeString([], timeOptions);
        if (appDateDisplay) appDateDisplay.textContent = now.toLocaleDateString(undefined, dateOptions);
    }


    // Initialize main desktop event listeners after the DOM is fully loaded
    function initializeDesktopListeners() {
        // Assign global DOM variables here, after document is loaded
        desktopEnvContainer = document.getElementById('desktop-env-container');
        loginScreen = document.getElementById('login-screen');
        passwordInput = document.getElementById('password-input');
        loginTimeDisplay = document.getElementById('login-time');
        loginDateDisplay = document.getElementById('login-date');
        loginSpinner = document.getElementById('login-spinner');
        loginCard = document.querySelector('.login-card'); // Assign new variable
        welcomeMessage = document.getElementById('welcome-message'); // Assign new variable

        // desktop, windowsContainer, startMenu, startButton, desktopContextMenu
        // are now assigned after the DOM is ready.
        desktop = document.getElementById('desktop');
        desktopIconsZone = document.getElementById('desktop-icons-zone'); // Assign new variable
        shortcutsZone = document.getElementById('shortcuts-zone');    // Assign new variable
        desktopTimeDisplay = document.getElementById('desktop-time'); // Assign new variable
        desktopDateDisplay = document.getElementById('desktop-date'); // Assign new variable

        windowsContainer = document.getElementById('windows-container');
        startMenu = document.getElementById('start-menu');
        startButton = document.getElementById('start-button');
        // taskbarApps removed
        desktopContextMenu = document.getElementById('desktop-context-menu');

        // --- Attach event listeners to desktop icons dynamically ---
        const desktopIcons = document.querySelectorAll('.desktop-icon');
        desktopIcons.forEach(icon => {
            const appName = icon.dataset.appName;
            const appId = icon.dataset.appId;
            if (appName && appId) {
                icon.addEventListener('click', () => openApp(appName, appId));
            } else {
                console.warn(`Desktop icon missing data-app-name or data-app-id:`, icon);
            }
        });


        // Event listeners for desktop, context menu, and start menu
        if (desktop) {
            desktop.addEventListener('click', hideContextMenu);
            desktop.addEventListener('contextmenu', showContextMenu);
        }
        if (desktopContextMenu) {
            desktopContextMenu.addEventListener('click', (e) => e.stopPropagation());
        }
        if (startMenu && startButton) { // Ensure both exist for the start menu toggle
            document.addEventListener('click', function(event) {
                // If click is outside start menu and not on the start button, hide it
                if (!startMenu.contains(event.target) && !startButton.contains(event.target) && !startMenu.classList.contains('hidden')) {
                    startMenu.classList.add('hidden');
                }
            });
        }


        // Centralize mouseup/mousemove listeners for all draggable/resizable elements
        document.addEventListener('mousemove', (e) => {
            if (document.body.style.cursor === 'grabbing' || document.body.style.cursor === 'se-resize') {
                e.preventDefault();
            }
        });

        document.addEventListener('mouseup', () => {
            document.body.style.cursor = 'default';
        });

        // Initial update of time and date
        updateTimeAndDate();
        setInterval(updateTimeAndDate, 1000); // Update time every second

        // Set desktop to blurred state initially when the OS loads (before login)
        if (desktopEnvContainer) {
            desktopEnvContainer.classList.add('blurred');
            desktopEnvContainer.classList.remove('desktop-active'); // Ensure it's not active desktop during login
        }

        // The login screen should be visible initially.
        if (loginScreen) {
            loginScreen.classList.remove('hidden');
            // Animate login card and welcome message
            if (loginCard) loginCard.classList.add('show');
            // Show welcome message after a short delay
            setTimeout(() => {
                if (welcomeMessage) welcomeMessage.classList.add('show');
            }, 300);
        }
    }
    // No explicit window.onload here, as Firebase initialization handles it now.
    // The Firebase script module handles calling initializeDesktopListeners() and loadUserPreferences().
</script>
</body>
</html>
