<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 13 Concept (0.4.1)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts for custom typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Anime.js for advanced animations and transitions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        // Global user preferences - now persisted with Local Storage
        // This object represents the currently active user's preferences.
        // For simplicity, "new account" creation overwrites this single profile.
        window.userPreferences = {
            username: 'User Name',
            password: '', // Storing password in plaintext for demo ONLY. In production, this MUST be a hashed password.
            wallpaperUrl: 'Assets/Background/BackgroundV2.png',
            theme: 'dark-mode', // 'dark-mode' or 'light-mode'
            // For the beta intro modal
            betaIntroShown: false
        };

        // window.userId will now be a random ID per session, as there's no auth
        window.userId = crypto.randomUUID();
        window.isAuthReady = true; // Always true as there's no async auth

        // File system for File Explorer (conceptual)
        window.fileSystem = {
            'C:': {
                'Users': {
                    'Public': {
                        'Documents': {},
                        'Downloads': {},
                        'Pictures': {},
                        'Music': {},
                        'Videos': {}
                    },
                    'Guest': {
                        'Documents': {
                            'Important.txt': 'This is an important document.',
                            'Notes.md': '# My Notes\\n\\n- Task 1\\n- Task 2' // Use double backslash for newlines
                        },
                        'Desktop': {
                            'README.txt': 'Welcome to your desktop!'
                        }
                    }
                },
                'Program Files': {
                    'Applications': {
                        'Red Sun': 'The Red Sun application. A symbolic app.',
                        'Blue Sun': 'The Blue Sun application. A symbolic app.'
                    },
                    'SystemTools': {
                        'UpdateTool': 'System Update Tool files.'
                    }
                },
                'Windows': {}
            }
        };

        // Current directory for terminal and file explorer (starts at C:\)
        window.currentDirectory = window.fileSystem['C:'];
        window.currentPath = 'C:\\';

        /**
         * Loads user preferences from localStorage, merging with defaults if not all properties exist.
         * Applies the loaded preferences to the UI.
         */
        function loadUserPreferences() {
            try {
                const storedPreferences = localStorage.getItem('userPreferences');
                if (storedPreferences) {
                    const parsedPreferences = JSON.parse(storedPreferences);
                    // Merge stored preferences with default ones to ensure all properties are present
                    // This handles cases where new preference fields are added in later versions
                    window.userPreferences = { ...window.userPreferences, ...parsedPreferences };
                    console.log("User preferences loaded from localStorage:", window.userPreferences);
                } else {
                    console.log("No user preferences found in localStorage. Using defaults.");
                }
            } catch (error) {
                console.error("Error loading user preferences from localStorage:", error);
                showMessage("Error loading settings. Using default preferences.");
            }

            // Apply loaded or default preferences to the UI
            updateProfileDisplay();
            applyWallpaper(window.userPreferences.wallpaperUrl);
            applyTheme(window.userPreferences.theme); // applyTheme now also calls refreshDesktopAppearance
        }

        /**
         * Saves current user preferences to localStorage.
         */
        function saveUserPreferences() {
            try {
                localStorage.setItem('userPreferences', JSON.stringify(window.userPreferences));
                showMessage("Settings applied (persisted locally)!");
                console.log("User preferences saved to localStorage:", window.userPreferences);
            } catch (error) {
                console.error("Error saving user preferences to localStorage:", error);
                showMessage("Error saving settings. Changes might not be persistent.");
            }
            // Re-apply settings to ensure UI reflects any changes that might not be reactive
            updateProfileDisplay();
            // applyWallpaper and applyTheme are handled by refreshDesktopAppearance or directly
            applyTheme(window.userPreferences.theme); // This will now trigger refreshDesktopAppearance
        }

        /**
         * Updates the displayed username and password in the login and accounts screens.
         */
        function updateProfileDisplay() {
            const welcomeMessage = document.getElementById('welcome-message');
            if (welcomeMessage) {
                welcomeMessage.textContent = `Welcome Back, ${window.userPreferences.username}`;
            }
            const accountsUsernameInput = document.querySelector('#accounts-username-input');
            if (accountsUsernameInput) {
                accountsUsernameInput.value = window.userPreferences.username;
            }
            const accountsPasswordInput = document.querySelector('#accounts-password-input');
            if (accountsPasswordInput) {
                 accountsPasswordInput.value = window.userPreferences.password;
            }
             // Also update the current username display in settings if it exists
             const currentUsernameDisplay = document.getElementById('current-username-display');
            if (currentUsernameDisplay) {
                currentUsernameDisplay.textContent = window.userPreferences.username;
            }
        }

        /**
         * Applies the specified wallpaper URL to the desktop background.
         * @param {string} url - The URL of the wallpaper image.
         */
        function applyWallpaper(url) {
            const desktopEnvContainer = document.getElementById('desktop-env-container');
            if (desktopEnvContainer) {
                desktopEnvContainer.style.setProperty('--desktop-image', `url('${url}')`);
            }
        }

        /**
         * Applies the specified theme ('dark-mode' or 'light-mode') to the body.
         * Updates the theme toggle in display settings if it exists.
         * @param {string} theme - The theme to apply.
         */
        function applyTheme(theme) {
            if (document.body) {
                if (theme === 'light-mode') {
                    document.body.classList.add('light-mode');
                } else {
                    document.body.classList.remove('light-mode');
                }
            }
            // Update the toggle state if it exists (it's inside the display settings window)
            const themeModeToggleElement = document.querySelector('#display-settings-window #theme-mode');
            if (themeModeToggleElement) {
                themeModeToggleElement.checked = (theme === 'light-mode');
            }
            refreshDesktopAppearance(); // Call to re-evaluate filters/appearance
        }

        /**
         * Refreshes the desktop appearance, including wallpaper and filters,
         * based on current user preferences and display settings.
         */
        function refreshDesktopAppearance() {
            const desktopEnvContainer = document.getElementById('desktop-env-container');
            if (!desktopEnvContainer) return;

            // Apply wallpaper as it might have changed
            applyWallpaper(window.userPreferences.wallpaperUrl);

            // Re-evaluate filters (brightness, night light)
            let filters = [];
            let currentBrightness = 100; // Default brightness

            // Get brightness from the slider if the display settings window is open and slider exists
            const brightnessSliderElement = document.querySelector('#display-settings-window #brightness');
            if (brightnessSliderElement) {
                currentBrightness = parseFloat(brightnessSliderElement.value);
            }
            filters.push(`brightness(${currentBrightness}%)`);

            // Check night light state if the display settings window is open and toggle exists
            const nightLightToggleElement = document.querySelector('#display-settings-window #night-light');
            if (nightLightToggleElement && nightLightToggleElement.checked) {
                filters.push('sepia(0.3)', 'hue-rotate(-20deg)');
            }

            // Apply all accumulated filters
            desktopEnvContainer.style.filter = filters.join(' ');
        }

    </script>
    <!-- Embedded CSS styles -->
    <style>
        /* Define CSS variables for themes. Default values are for dark mode. */
        :root {
            --main-bg-color: #1a1a1a; /* Dark mode background for the entire body */
            --desktop-image: url('Assets/Background/BackgroundV2.png'); /* Default wallpaper */
            --desktop-text-color: #f9fafb; /* Light text for dark background */

            /* Gradient for desktop overlay in dark mode */
            --desktop-gradient-start: rgba(0, 0, 0, 0.4);
            --desktop-gradient-end: rgba(0, 0, 0, 0.6);

            --window-bg: rgba(26, 26, 26, 0.95); /* Semi-transparent dark gray for window background */
            --window-border: #3a3a3a; /* Darker gray border for windows */
            --window-text: #f9fafb; /* Light text for window content */
            --window-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); /* Softer, more modern shadow */

            --header-bg: #1f2937; /* Darker gray for window headers */
            --header-border: #3a3a3a; /* Darker gray border for headers */
            --header-button-hover: #374151; /* Darker gray for header button hover */
            --header-button-text: #9ca3af; /* Light gray for header button icons */

            --sidebar-bg: #2a2a2a; /* Dark gray for settings sidebar */
            --sidebar-border: #3a3a3a; /* Dark gray border for sidebar */
            --content-area-bg: #1a1a1a; /* Even darker gray for settings content area */

            --input-bg: #374151; /* Medium gray for inputs */
            --input-text: #f9fafb; /* Light text for inputs */
            --placeholder-color: #9ca3af; /* Gray placeholder text */
            --focus-ring-color: #3b82f6; /* Blue focus ring for inputs */

            --general-button-bg: #3b82f6; /* Blue for general buttons */
            --general-button-hover: #2563eb; /* Darker blue for general button hover */
            --general-button-text: #ffffff; /* White text for general buttons */

            --start-menu-item-hover: rgba(255, 255, 255, 0.1); /* Subtle hover for start menu items */
            --context-menu-item-hover: #3b82f6; /* Blue hover for context menu items */

            /* New modern specific variables */
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
        }

        /* Light mode overrides for CSS variables */
        body.light-mode {
            --main-bg-color: #e0e7ff; /* Lighter background for the body */
            --desktop-text-color: #1a1a1a; /* Dark text for light background */

            /* Gradient for desktop overlay in light mode */
            --desktop-gradient-start: rgba(255, 255, 255, 0.4);
            --desktop-gradient-end: rgba(255, 255, 255, 0.6);

            --window-bg: rgba(255, 255, 255, 0.95); /* Semi-transparent white for window background */
            --window-border: #d1d5db; /* Light gray border for windows */
            --window-text: #1a1a1a; /* Dark text for window content */
            --window-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Lighter, subtle shadow */

            --header-bg: #eff2f9; /* Lighter blue-ish for window headers */
            --header-border: #d1d5db; /* Light blue border for headers */
            --header-button-hover: #e0e7ff; /* Lighter blue for header button hover */
            --header-button-text: #3b82f6; /* Blue for header button icons */

            --sidebar-bg: #f5f7fa; /* Light gray for settings sidebar */
            --sidebar-border: #e5e7eb; /* Lighter gray border for sidebar */
            --content-area-bg: #ffffff; /* White for settings content area */

            --input-bg: #e5e7eb; /* Lighter gray for inputs */
            --input-text: #1a1a1a; /* Dark text for inputs */
            --placeholder-color: #6b7280; /* Darker gray placeholder text */
            --focus-ring-color: #60a5fa; /* Lighter blue focus ring */

            --general-button-bg: #60a5fa; /* Lighter blue for general buttons */
            --general-button-hover: #3b82f6; /* Darker blue for general button hover */

            --start-menu-item-hover: rgba(0, 0, 0, 0.05); /* Subtle hover for light mode start menu items */
            --context-menu-item-hover: #60a5fa; /* Lighter blue hover for context menu items */
        }

        /* Base styles applied to body and globally */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll */
            cursor: default;
            background-color: var(--main-bg-color); /* Apply main background color based on theme */
            color: var(--desktop-text-color); /* Apply desktop text color */
            transition: background-color 0.5s ease-out, color 0.5s ease-out;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--sidebar-bg); /* Use a theme-adaptive background */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888; /* Neutral gray for thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Darker neutral gray on hover */
        }

        /* Window styles */
        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            box-shadow: var(--window-shadow); /* Use theme variable for shadow */
            border-radius: var(--border-radius-lg); /* Modern rounded corners */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--window-bg);
            border: 1px solid var(--window-border);
            color: var(--window-text);
            transition: all 0.3s ease-out; /* Smoother transitions for all properties */
        }

        .window-header {
            cursor: grab;
            user-select: none;
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out;
        }

        .window-header:active {
            cursor: grabbing;
        }

        .resize-handle {
            position: absolute;
            width: 15px;
            height: 15px;
            bottom: 0;
            right: 0;
            cursor: se-resize;
            background: transparent;
            z-index: 10;
        }

        .maximized {
            width: 100vw !important;
            height: 100vh !important;
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            border-radius: 0 !important;
        }

        .minimized {
            display: none !important;
        }

        /* Start Menu and Custom Bottom Containers */
        .start-menu {
            position: fixed; /* Changed to fixed to stick to viewport bottom-left */
            bottom: 6rem; /* Position above the new standalone start button */
            left: 1rem;
            width: 900px;
            max-width: 95vw;
            height: 500px;
            max-height: calc(100vh - 7rem); /* Adjust max-height */
            overflow: hidden;
            transform-origin: bottom left;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease-out;
            display: flex;
            background-color: var(--window-bg);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            box-shadow: var(--window-shadow); /* Use window shadow for consistency */
            backdrop-filter: blur(20px); /* Stronger blur for modern frosted effect */
            border: 1px solid var(--window-border); /* Add border for consistency */
            z-index: 50; /* Ensure it's above other bottom elements but below modals */
        }

        .start-menu.hidden {
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
        }

        /* Standalone Start Button */
        #standalone-start-button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out, box-shadow 0.2s ease-in-out;
            position: fixed;
            bottom: 1rem; /* Adjust position */
            left: 1rem; /* Adjust position */
            z-index: 40; /* Above desktop, below start menu */
        }

        .start-menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-md);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .start-menu-item:hover {
            background-color: var(--start-menu-item-hover);
        }

        .context-menu {
            position: absolute;
            z-index: 9999;
            transform-origin: top left;
            /* Added transition for smoother appearance/disappearance */
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, background-color 0.3s ease-out;
            background-color: var(--window-bg);
            border-radius: var(--border-radius-md);
            padding: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px); /* Stronger blur */
            border: 1px solid var(--window-border); /* Add border for consistency */
        }
        .context-menu.hidden {
            transform: scale(0.9); /* Start slightly scaled down */
            opacity: 0;
            pointer-events: none;
        }

        .context-menu div {
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .context-menu div:hover {
            background-color: var(--context-menu-item-hover);
            color: white;
        }

        /* Keyframe animations for windows */
        @keyframes window-open {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .window.opening {
            animation: window-open 0.2s ease-out forwards;
        }

        @keyframes window-close {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        .window.closing {
            animation: window-close 0.2s ease-out forwards;
        }

        /* Desktop environment container */
        #desktop-env-container {
            position: fixed; /* Fix to viewport */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--main-bg-color); /* Background for area under wallpaper */
            background-image: var(--desktop-image);
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
            transition: filter 0.5s ease-out, background-color 0.5s ease-out;
            z-index: 1; /* Below login screen initially */
            display: flex; /* Keep flex for its internal structure */
            flex-direction: column; /* Keep flex for its internal structure */
        }
        /* Gradient overlay for the desktop background */
        #desktop-env-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, var(--desktop-gradient-start), var(--desktop-gradient-end));
            z-index: 2; /* Place above the background image but below content */
            pointer-events: none; /* Allow clicks to pass through */
            opacity: 1; /* Always visible */
            transition: background 0.5s ease-out;
        }
        #desktop-env-container.blurred {
            filter: blur(5px);
        }
        /* When login is complete, desktop-env-container will become the primary view */
        #desktop-env-container.desktop-active {
            z-index: 10; /* Bring to front when active desktop */
        }

        /* Login screen styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent; /* Allow blurred desktop to show through */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000; /* Ensure it's on top */
            color: white;
            transition: opacity 0.5s ease-out;
        }
        #login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-card {
            background: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
            backdrop-filter: blur(25px); /* Stronger blur for login */
            border-radius: var(--border-radius-lg);
            padding: 40px;
            text-align: center;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.7); /* More pronounced shadow */
            width: 90%;
            max-width: 450px; /* Slightly wider */
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(20px);
            opacity: 0;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle white border */
        }
        .login-card.show {
            transform: translateY(0);
            opacity: 1;
            transition: transform 0.6s ease-out, opacity 0.6s ease-out;
        }

        /* Profile picture on login screen */
        .profile-pic-login {
            width: 100px; /* Slightly larger */
            height: 100px;
            border-radius: 50%;
            background-color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px; /* Larger icon */
            margin-bottom: 28px; /* More space */
            color: white;
            overflow: hidden;
            border: 4px solid #60a5fa; /* Thicker border */
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); /* Enhanced glow */
        }
        .profile-pic-login img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Welcome Back message */
        .welcome-message {
            font-size: 2.8rem; /* Slightly larger text */
            font-weight: 300;
            margin-bottom: 1.8rem; /* More space */
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.6s ease-out 0.2s, transform 0.6s ease-out 0.2s; /* Delayed animation */
            color: #e0e7ff;
        }
        .welcome-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom Message Box Styles */
        #message-box {
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 11000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none;
        }
        #message-box.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Windows-style Loading Spinner */
        .windows-spinner {
            width: 50px;
            height: 50px;
            position: relative;
            margin-top: 20px;
            transform: rotate(45deg);
            display: none;
        }

        .windows-spinner.show {
            display: block;
        }

        .windows-spinner .dot {
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            border-radius: 50%;
            position: absolute;
            animation: windows-dot-spin 1.5s infinite ease-in-out;
            opacity: 0;
        }

        .windows-spinner .dot:nth-child(1) { top: 0; left: 0; animation-delay: 0s; }
        .windows-spinner .dot:nth-child(2) { top: 0; right: 0; animation-delay: 0.1s; }
        .windows-spinner .dot:nth-child(3) { bottom: 0; right: 0; animation-delay: 0.2s; }
        .windows-spinner .dot:nth-child(4) { bottom: 0; left: 0; animation-delay: 0.3s; }

        @keyframes windows-dot-spin {
            0%, 100% {
                transform: scale(0.5);
                opacity: 0;
            }
            25% {
                transform: scale(1);
                opacity: 1;
            }
            50%, 75% {
                transform: scale(0.5);
                opacity: 0;
            }
        }

        /* Ensure windows-container does not block clicks on desktop icons */
        #windows-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        /* Settings App Specific Styles (Windows 11-like, but refined) */
        .settings-sidebar {
            width: 280px; /* Wider sidebar */
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            padding: 1rem;
            flex-shrink: 0;
            overflow-y: auto;
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out;
            /* Added for more visual separation from content */
            box-shadow: inset -1px 0 0 rgba(255, 255, 255, 0.05);
        }

        .settings-content-area {
            flex-grow: 1;
            padding: 2rem; /* More padding */
            overflow-y: auto;
            background-color: var(--content-area-bg);
            transition: background-color 0.3s ease-out;
        }

        .settings-category-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1.25rem; /* Larger clickable area */
            border-radius: var(--border-radius-md);
            margin-bottom: 0.4rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .settings-category-item:hover {
            background-color: rgba(59, 130, 246, 0.2); /* A slightly brighter blue on hover */
        }

        .settings-category-item.active {
            background-color: rgba(59, 130, 246, 0.3); /* Lighter blue for active state */
            color: white; /* Keep text white */
            /* Add a distinct left border/shadow for active state */
            box-shadow: inset 4px 0 0 var(--general-button-bg); /* Use primary blue for indicator */
        }

        .settings-category-item i {
            margin-right: 1rem; /* More space for icon */
            font-size: 1.35rem; /* Slightly larger icon */
        }

        .settings-category-item span {
            font-weight: 500;
        }

        /* Input field styling based on theme variables */
        input[type="text"], input[type="password"], select, textarea { /* Added textarea */
            background-color: var(--input-bg);
            color: var(--input-text);
            padding: 0.85rem 1.25rem; /* Increased padding */
            border-radius: var(--border-radius-md); /* Slightly more rounded */
            border: 1px solid var(--window-border); /* Subtle border */
            transition: background-color 0.3s ease-out, color 0.3s ease-out, border-color 0.3s ease-out, box-shadow 0.3s ease-out;
        }
        input[type="text"]::placeholder, input[type="password"]::placeholder, textarea::placeholder { /* Added textarea */
            color: var(--placeholder-color);
        }
        input[type="text"]:focus, input[type="password"]:focus, select:focus, textarea:focus { /* Added textarea */
            outline: none;
            border-color: var(--focus-ring-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); /* Glow effect on focus */
        }
        /* Range input styling (brightness, scale) */
        input[type="range"] {
            -webkit-appearance: none; /* Override default */
            appearance: none;
            background: var(--input-bg); /* Track background */
            outline: none;
            border-radius: 5px;
            height: 8px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--general-button-bg); /* Thumb color */
            cursor: grab;
            margin-top: -6px; /* Center thumb vertically */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.6); /* Active glow */
        }


        /* Adjust desktop icon text for light mode */
        body.light-mode .desktop-icon span {
            color: var(--desktop-text-color); /* Ensures text color adapts */
        }
        /* Adjust start menu text for light mode */
        body.light-mode .start-menu h2,
        body.light-mode .start-menu ul li {
            color: var(--window-text); /* Ensures text color adapts */
        }
        /* Adjust start button for light mode */
        body.light-mode #standalone-start-button { /* Updated selector */
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        body.light-mode #standalone-start-button:hover { /* Updated selector */
            background-color: #60a5fa; /* Lighter blue hover for light mode */
        }
        body.light-mode #standalone-start-button .fa-windows { /* Updated selector */
            color: #005fba; /* Darker blue for Windows icon in light mode */
        }

        /* Common button styles */
        button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out, box-shadow 0.2s ease-in-out;
            border-radius: var(--border-radius-md); /* Default rounded corners for all buttons */
            padding: 0.75rem 1.5rem; /* Default padding */
            font-weight: 600; /* Semi-bold text */
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow */
            background-color: var(--general-button-bg);
            color: var(--general-button-text);
        }

        button:hover {
            background-color: var(--general-button-hover);
            transform: translateY(-1px); /* Slight lift effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* Enhanced shadow on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15); /* Pressed effect */
        }

        /* Specific button overrides */
        .window-header button {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0; /* Override default padding */
            width: 28px; /* Fixed size */
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--header-button-text);
        }
        .window-header button:hover {
            background-color: var(--header-button-hover);
            transform: none;
            box-shadow: none;
        }
        .window-header .close-btn:hover {
            background-color: #dc2626; /* Red for close button */
            color: white;
        }

        /* Taskbar app icon styles (Removed but keeping for historical context if needed) */
        .taskbar-app-icon {
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            /* display: none; will be removed with the taskbar */
        }
        .taskbar-app-icon:hover {
            background-color: rgba(59, 130, 246, 0.8) !important; /* Slightly lighter blue on hover */
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .taskbar-app-icon.active {
            background-color: #2563eb; /* Darker blue for active */
            border-color: #3b82f6;
            transform: translateY(-1px);
        }
        body.light-mode .taskbar-app-icon {
            background-color: rgba(96, 165, 250, 0.8);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.light-mode .taskbar-app-icon:hover {
            background-color: #3b82f6 !important;
        }
        body.light-mode .taskbar-app-icon.active {
            background-color: #3b82f6;
            border-color: #60a5fa;
        }


        /* Calculator specific styles */
        #calc-display {
            background-color: var(--input-bg); /* Use theme variable */
            color: var(--input-text); /* Use theme variable */
            border: 1px solid var(--window-border); /* Use theme variable */
            text-align: right;
            font-size: 2.5rem; /* Larger font */
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius-md);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .calc-btn {
            background-color: var(--input-bg); /* Match inputs or other suitable theme var */
            color: var(--input-text); /* Match inputs or other suitable theme var */
            border: none;
            font-size: 1.25rem;
            height: 50px;
            border-radius: var(--border-radius-md);
            transition: background-color 0.2s, transform 0.1s;
        }
        .calc-btn:hover {
            background-color: var(--header-button-hover); /* A slightly lighter background on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .calc-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .calc-btn.bg-orange-500 {
            background-color: #f97316; /* Orange for operators */
            color: white;
        }
        .calc-btn.bg-orange-500:hover {
            background-color: #ea580c;
        }
        .calc-btn.bg-blue-600 {
            background-color: #2563eb; /* Blue for equals */
            color: white;
        }
        .calc-btn.bg-blue-600:hover {
            background-color: #1d4ed8;
        }
        .calc-btn.bg-gray-500 {
            background-color: #6b7280; /* Gray for C, backspace */
            color: white;
        }
        .calc-btn.bg-gray-500:hover {
            background-color: #4b5563;
        }

        /* To-Do List specific styles */
        #todo-input {
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--window-border);
            border-radius: var(--border-radius-md);
            padding: 0.75rem 1rem;
        }
        #todo-input:focus {
            outline: none;
            border-color: var(--focus-ring-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        #add-todo-btn {
            background-color: #10b981; /* Green */
            color: white;
        }
        #add-todo-btn:hover {
            background-color: #059669;
        }
        #todo-list-items li {
            background-color: var(--sidebar-bg); /* Use sidebar background for list items */
            border: 1px solid var(--sidebar-border);
            border-radius: var(--border-radius-md);
            padding: 0.75rem 1rem;
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out;
        }
        #todo-list-items li button {
            background: none;
            box-shadow: none;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #ef4444; /* Red for delete */
        }
        #todo-list-items li button:hover {
            background-color: rgba(239, 68, 68, 0.1);
            transform: none;
        }

        /* Shortcuts Zone (Time/Date) */
        #shortcuts-zone {
            background-color: rgba(0, 0, 0, 0.5); /* Keep it dark semi-transparent */
            backdrop-filter: blur(15px); /* Stronger blur */
            border: 1px solid rgba(255, 255, 255, 0.15); /* Slightly more visible border */
            color: white; /* Keep text white */
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
            transition: background-color 0.3s ease-out, border-color 0.3s ease-out, box-shadow 0.3s ease-out;
            border-radius: var(--border-radius-lg); /* Rounded corners */
        }
        body.light-mode #shortcuts-zone {
            background-color: rgba(255, 255, 255, 0.5); /* Lighter semi-transparent */
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: black; /* Dark text for light mode */
        }

        /* Desktop icons zone */
        #desktop-icons-zone .desktop-icon:hover {
            background-color: rgba(0, 0, 0, 0.2); /* Dark mode subtle hover */
            border-radius: var(--border-radius-md); /* Apply rounded corners on hover */
        }
        body.light-mode #desktop-icons-zone .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Light mode subtle hover */
        }

        /* Settings category item active state */
        body.light-mode .settings-category-item.active {
            background-color: rgba(96, 165, 250, 0.3); /* Lighter blue for light mode active state */
            color: var(--window-text); /* Adapt text color */
            box-shadow: inset 4px 0 0 var(--general-button-bg);
        }
        body.light-mode .settings-category-item:hover {
            background-color: rgba(96, 165, 250, 0.15); /* Lighter blue hover for light mode */
        }


        /* Beta Intro Modal */
        #beta-intro-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.75); /* Slightly darker overlay */
            backdrop-filter: blur(15px); /* Stronger blur */
            z-index: 12000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        #beta-intro-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .beta-intro-card {
            background-color: var(--window-bg);
            border: 1px solid var(--window-border);
            color: var(--window-text);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem; /* More padding */
            width: 90%;
            max-width: 650px; /* Slightly wider */
            box-shadow: var(--window-shadow);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #beta-intro-modal.show .beta-intro-card {
            transform: translateY(0);
            opacity: 1;
        }

        /* --- NEW/UPDATED STYLES FOR "BETTER" UI --- */

        /* Enhanced Button Styles (excluding specific app buttons) */
        button:not(.window-header button, .calc-btn, #add-todo-btn) { /* Exclude app-specific buttons and window controls */
            background: linear-gradient(145deg, var(--general-button-bg), var(--general-button-hover));
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25); /* Slightly more pronounced shadow */
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1; /* Ensures pseudo-element is behind */
            transition: all 0.2s ease-in-out; /* Global transition for better feel */
        }

        button:not(.window-header button, .calc-btn, #add-todo-btn)::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.25); /* Slightly more opaque ripple effect */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.4s ease-out; /* Slower ripple */
            opacity: 0;
            z-index: -1;
        }

        button:not(.window-header button, .calc-btn, #add-todo-btn):hover::before {
            width: 250%; /* Expands more to cover button */
            height: 250%;
            opacity: 1;
        }

        button:not(.window-header button, .calc-btn, #add-todo-btn):active {
            transform: translateY(0px); /* Remove slight lift on active */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15); /* Pressed effect */
        }

        /* Desktop Icon active state */
        .desktop-icon.active {
            background-color: rgba(59, 130, 246, 0.3); /* A light blue highlight */
            border: 1px solid rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.5); /* Stronger glow */
            border-radius: var(--border-radius-md); /* Consistent rounded corners */
        }
        .desktop-icon:active {
            transform: scale(0.96); /* Slightly more pronounced press effect */
        }

        /* Light mode specific button overrides for general buttons */
        body.light-mode button:not(.window-header button, .calc-btn, #add-todo-btn) {
            background: linear-gradient(145deg, var(--general-button-hover), var(--general-button-bg)); /* Invert gradient for light mode */
            color: var(--general-button-text);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Lighter shadow in light mode */
        }
        body.light-mode button:not(.window-header button, .calc-btn, #add-todo-btn):hover {
            background: linear-gradient(145deg, var(--general-button-bg), var(--general-button-hover)); /* Restore hover gradient */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); /* More pronounced shadow on hover */
        }

        /* Window Header Button Hover for Light Mode */
        body.light-mode .window-header button:hover {
            background-color: var(--header-button-hover);
            color: var(--header-button-text);
        }
        body.light-mode .window-header .close-btn:hover {
            background-color: #dc2626; /* Red for close button */
            color: white;
        }

        /* Snapping Preview styles */
        .snap-preview {
            position: absolute;
            background-color: rgba(59, 130, 246, 0.25); /* Slightly more opaque blue */
            border: 2px dashed rgba(59, 130, 246, 0.7); /* Stronger dashed border */
            border-radius: var(--border-radius-lg); /* Consistent rounded corners */
            z-index: 9999; /* Above windows, below login/modals */
            pointer-events: none; /* Crucial: allow clicks to pass through */
            transition: opacity 0.1s ease-out;
            opacity: 0; /* Hidden by default */
        }
        .snap-preview.show {
            opacity: 1;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="absolute top-8 left-8 text-white text-4xl font-light font-['Source_Sans_3']">
            <span id="login-time"></span>
            <div class="text-xl mt-1 font-['Source_Sans_3']" id="login-date"></div>
        </div>

        <div class="login-card">
            <div class="profile-pic-login">
                <i class="fa-solid fa-user"></i> <!-- Default user icon -->
                <!-- <img src="assets/Profile/default_user.png" alt="User Profile Picture"> -->
            </div>
            <h2 class="welcome-message" id="welcome-message">Welcome Back, User Name</h2>
            <div class="mb-6 w-full">
                <input type="password" id="password-input" class="w-full text-center" placeholder="Enter password">
                <p id="login-error-message" class="text-red-400 text-sm mt-2 hidden">Incorrect password.</p>
            </div>
            <button onclick="attemptLogin()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors shadow-lg">
                Sign In
            </button>
            <button onclick="showCreateAccountModal()" class="mt-4 w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors shadow-lg">
                Create New Account
            </button>
            <div id="login-spinner" class="windows-spinner">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>

    <!-- Create Account Modal (Hidden by default) -->
    <div id="create-account-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-md z-[11000] flex items-center justify-center">
        <div class="bg-gray-900 p-8 rounded-lg shadow-xl w-full max-w-md text-white">
            <h3 class="text-2xl font-bold mb-4 text-center">Create New Account</h3>
            <div class="mb-4">
                <label for="new-username-input" class="block text-sm font-medium text-gray-400 mb-1">Username</label>
                <input type="text" id="new-username-input" class="w-full" placeholder="Enter username">
            </div>
            <div class="mb-6">
                <label for="new-password-input" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                <input type="password" id="new-password-input" class="w-full" placeholder="Enter password">
            </div>
            <button onclick="createAccount()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                Create Account
            </button>
            <button onclick="hideCreateAccountModal()" class="mt-3 w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                Cancel
            </button>
        </div>
    </div>


    <!-- Desktop Environment (initially blurred, then unblurred and active) -->
    <div id="desktop-env-container" class="w-full h-full flex flex-col">
        <!-- Actual Desktop Area (content above bottom controls) -->
        <div id="desktop" class="flex-grow flex p-4 relative overflow-hidden">
            <!-- Left Zone: Desktop Icons -->
            <div id="desktop-icons-zone" class="w-1/4 min-w-[150px] max-w-[250px] overflow-y-auto pr-4">
                <div class="flex flex-col gap-4">
                    <!-- Desktop Icons -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="File Explorer" data-app-id="file-explorer">
                        <i class="fa-solid fa-folder-open text-blue-400 text-4xl"></i>
                        <span class="text-sm mt-1">File Explorer</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Browser" data-app-id="browser">
                        <i class="fa-solid fa-globe text-purple-400 text-4xl"></i>
                        <span class="text-sm mt-1">Browser</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Terminal" data-app-id="terminal">
                        <i class="fa-solid fa-terminal text-green-400 text-4xl"></i>
                        <span class="text-sm mt-1">Terminal</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Solar Panel" data-app-id="solar-panel">
                        <i class="fa-solid fa-solar-panel text-yellow-400 text-4xl"></i>
                        <span class="text-sm mt-1">Solar Panel</span>
                    </div>
                    <!-- New Settings App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Settings" data-app-id="settings">
                        <i class="fa-solid fa-gear text-gray-400 text-4xl"></i>
                        <span class="text-sm mt-1">Settings</span>
                    </div>
                    <!-- New About Windows App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="About Windows 13" data-app-id="about-windows">
                        <img src="assets/Logo/Windows_13_logo.png" alt="Windows 13 Logo" class="w-10 h-10">
                        <span class="text-sm mt-1 text-center">About Windows 13</span>
                    </div>
                    <!-- New Calculator App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Calculator" data-app-id="calculator">
                        <i class="fa-solid fa-calculator text-red-400 text-4xl"></i>
                        <span class="text-sm mt-1">Calculator</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Image Viewer" data-app-id="image-viewer">
                        <i class="fa-solid fa-image text-pink-400 text-4xl"></i>
                        <span class="text-sm mt-1">Image Viewer</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="To-Do List" data-app-id="todo-list">
                        <i class="fa-solid fa-list-check text-green-400 text-4xl"></i>
                        <span class="text-sm mt-1">To-Do List</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Weather" data-app-id="weather">
                        <i class="fa-solid fa-cloud-sun-rain text-blue-300 text-4xl"></i>
                        <span class="text-sm mt-1">Weather</span>
                    </div>
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Display Settings" data-app-id="display-settings">
                        <i class="fa-solid fa-display text-blue-400 text-4xl"></i>
                        <span class="text-sm mt-1 text-center">Display Settings</span>
                    </div>
                    <!-- New Recycle Bin App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Recycle Bin" data-app-id="recycle-bin">
                        <i class="fa-solid fa-trash-can text-gray-500 text-4xl"></i>
                        <span class="text-sm mt-1">Recycle Bin</span>
                    </div>
                    <!-- New Code Editor App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Code Editor" data-app-id="code-editor">
                        <i class="fa-solid fa-code text-orange-400 text-4xl"></i>
                        <span class="text-sm mt-1">Code Editor</span>
                    </div>
                    <!-- New Windows Update App Icon -->
                    <div class="desktop-icon flex flex-col items-center cursor-pointer p-2 rounded-lg hover:bg-gray-800 transition-colors transition-transform duration-150 hover:scale-105" data-app-name="Windows Update" data-app-id="windows-update">
                        <i class="fa-solid fa-cloud-arrow-down text-blue-500 text-4xl"></i>
                        <span class="text-sm mt-1 text-center">Windows Update</span>
                    </div>
                </div>
            </div>

            <!-- Center Zone (flexible empty space for now) -->
            <div class="flex-grow"></div>

            <!-- Right Zone: Shortcuts (Time, Date) -->
            <div id="shortcuts-zone" class="w-1/4 min-w-[150px] max-w-[250px] p-4 rounded-lg backdrop-blur-md flex flex-col justify-between cursor-pointer" onclick="openApp('Date and Time', 'date-time')">
                <div class="text-center">
                    <div class="text-5xl font-light font-['Source_Sans_3']" id="desktop-time"></div>
                    <div class="text-xl mt-2 font-['Source_Sans_3']" id="desktop-date"></div>
                </div>
                <!-- Other quick links can be added here -->
            </div>
        </div>

        <!-- Windows Container -->
        <div id="windows-container" class="absolute inset-0">
            <!-- Windows will be dynamically added here -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="start-menu hidden backdrop-blur-md rounded-lg p-4 shadow-xl z-50">
            <!-- Left Panel: Recent Apps -->
            <div class="w-1/3 border-r border-gray-700 pr-4 overflow-y-auto">
                <h2 class="text-lg font-semibold mb-4 text-blue-400">Recent Apps</h2>
                <ul id="recent-apps-list" class="space-y-2">
                    <!-- Dynamically populated recent apps - example entries for now -->
                    <li class="start-menu-item" onclick="openApp('File Explorer', 'file-explorer'); toggleStartMenu()">
                        <i class="fa-solid fa-folder-open text-blue-400 text-xl mr-2"></i> File Explorer
                    </li>
                    <li class="start-menu-item" onclick="openApp('Browser', 'browser'); toggleStartMenu()">
                        <i class="fa-solid fa-globe text-purple-400 text-xl mr-2"></i> Browser
                    </li>
                    <li class="start-menu-item" onclick="openApp('Terminal', 'terminal'); toggleStartMenu()">
                        <i class="fa-solid fa-terminal text-green-400 text-xl mr-2"></i> Terminal
                    </li>
                    <li class="start-menu-item" onclick="openApp('Settings', 'settings'); toggleStartMenu()">
                        <i class="fa-solid fa-gear text-gray-400 text-xl mr-2"></i> Settings
                    </li>
                    <li class="start-menu-item" onclick="openApp('Code Editor', 'code-editor'); toggleStartMenu()">
                        <i class="fa-solid fa-code text-orange-400 text-xl mr-2"></i> Code Editor
                    </li>
                    <li class="start-menu-item" onclick="openApp('Windows Update', 'windows-update'); toggleStartMenu()">
                        <i class="fa-solid fa-cloud-arrow-down text-blue-500 text-xl mr-2"></i> Windows Update
                    </li>
                </ul>
            </div>

            <!-- Middle Panel: Updates -->
            <div class="w-1/3 border-r border-gray-700 px-4 overflow-y-auto">
                <h2 class="text-lg font-semibold mb-4 text-blue-400">Windows 13 Updates</h2>
                <!-- NEW UPDATE ENTRY START -->
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.4.1</p>
                    <p class="text-blue-400 mb-2">Key Changes: Terminal & Settings Redesigned</p>
                    <p class="text-gray-300 text-sm">
                        This update focuses on user interface refinements. The Terminal has been completely redesigned for a more modern and functional command-line experience. Additionally, the Settings application has been remade to align with contemporary Windows design principles, offering a more intuitive and visually appealing user experience.
                    </p>
                </div>
                <!-- NEW UPDATE ENTRY END -->
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: V0.4.0 (Official)</p>
                    <p class="text-blue-400 mb-2">Codename: Stability & Feature Parity</p>
                    <p class="text-gray-300 text-sm">
                        Thank you for your patience! This official release was delayed to ensure critical bug fixes,
                        performance optimizations, and feature completeness for a seamless user experience.
                        We've focused on enhancing underlying stability, refining UI animations, and implementing
                        robust error handling. This version brings all the promised features of the beta
                        into a production-ready state, ensuring reliability and a polished feel.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.95</p>
                    <p class="text-blue-400 mb-2">Codename: Background remake & Login change info</p>
                    <p class="text-gray-300 text-sm">
                        This update introduces significant visual enhancements, allowing users to customize their desktop
                        backgrounds with both predefined options and custom image URLs. Additionally, the login screen
                        now includes improved informational displays, providing clearer feedback during the sign-in process.
                        These changes aim to personalize the user experience and streamline initial system access.
                    </p>
                </div>
                <!-- NEW UPDATE ENTRY END -->
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.9</p>
                    <p class="text-blue-400 mb-2">Codename: Layout change & Start Menu change</p>
                    <p class="text-gray-300 text-sm">
                        This update brings a significant overhaul to the desktop layout.
                        The taskbar has been removed, integrating its core functionalities into the Start Menu.
                        The desktop now features a left-aligned icon zone and a right-aligned "Shortcuts" area,
                        which prominently displays the time and date, now clickable to open the new "Date/Time" application.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.8</p>
                    <p class="text-blue-400 mb-2">Codename: Scrolling added</p>
                    <p class="text-gray-300 text-sm">
                        This mini-update ensures that various application windows and content areas within the OS
                        now correctly support scrolling when their content exceeds the visible area.
                        This improves usability and access to information in apps like File Explorer, Terminal,
                        and other dynamic content displays.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.73</p>
                    <p class="text-blue-400 mb-2">Codename: Boot up sound Update & Loading Update</p>
                    <p class="text-gray-300 text-sm">
                        This significant update enhances the user's initial experience by refining the boot-up sound for a more pleasing auditory feedback.
                        Additionally, the loading spinner throughout the system has been redesigned to align with modern Windows aesthetics, offering a smoother and more visually appealing waiting indicator.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <p class="font-bold text-lg mb-2">Version: 0.3.4</p>
                    <p class="text-blue-400 mb-2">Codename: Login Patch & boot up sounds</p>
                    <p class="text-300 text-sm">
                        This update revamps the login screen with a modern aesthetic and introduces a subtle boot-up sound for a more immersive experience.
                    </p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="font-bold text-lg mb-2">Version: 0.3.0</p>
                    <p class="text-blue-400 mb-2">Codename: Desktop columns & a Windows Update setting (alpha version)</p>
                    <p class="text-gray-300 text-sm">
                        This update introduces a more organized desktop layout with columns and adds
                        a conceptual Windows Update setting for future expansion.
                    </p>
                </div>
            </div>

            <!-- Right Panel: Device Settings -->
            <div class="w-1/3 pl-4">
                <h2 class="text-lg font-semibold mb-4 text-blue-400">Device Settings</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Settings', 'settings'); toggleStartMenu()">
                        <i class="fa-solid fa-gear text-gray-400 text-2xl"></i> <span class="text-xs mt-1">Settings</span>
                    </div>
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Calculator', 'calculator'); toggleStartMenu()">
                        <i class="fa-solid fa-calculator text-red-400 text-2xl"></i> <span class="text-xs mt-1">Calculator</span>
                    </div>
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Browser', 'browser'); toggleStartMenu()">
                        <i class="fa-solid fa-globe text-purple-400 text-2xl"></i> <span class="text-xs mt-1">Internet</span>
                    </div>
                    <!-- Changed from Display Settings to Volume, opens the same app -->
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="openApp('Display Settings', 'display-settings'); toggleStartMenu()">
                        <i class="fa-solid fa-volume-high text-blue-400 text-2xl"></i> <span class="text-xs mt-1">Volume</span>
                    </div>
                    <div class="start-menu-item flex flex-col items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer" onclick="showMessage('Power Options!'); toggleStartMenu()">
                        <i class="fa-solid fa-power-off text-red-400 text-2xl"></i>
                        <span class="text-xs mt-1">Power</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Context Menu -->
        <div id="desktop-context-menu" class="context-menu hidden backdrop-blur-md rounded-lg p-2 shadow-xl z-50 text-sm">
            <div class="py-1 px-3 rounded-md cursor-pointer" onclick="openApp('Display Settings', 'display-settings'); hideContextMenu()">Display settings</div>
            <div class="py-1 px-3 rounded-md cursor-pointer" onclick="showMessage('Personalize opened!'); hideContextMenu()">Personalize</div>
            <div class="py-1 px-3 rounded-md cursor-pointer" onclick="showMessage('New folder created!'); hideContextMenu()">New Folder</div>
        </div>

        <!-- NEW: Custom Internet & Volume Container at bottom-middle -->
        <div id="internet-volume-container" class="flex items-center space-x-4 bg-gray-800 bg-opacity-90 backdrop-blur-md rounded-t-lg px-6 py-3 fixed bottom-0 left-1/2 -translate-x-1/2 z-40 shadow-xl transition-all duration-300">
            <i class="fa-solid fa-wifi text-white text-xl cursor-pointer hover:text-blue-400" onclick="showMessage('Wi-Fi settings opened (conceptual)!')"></i>
            <i class="fa-solid fa-volume-high text-white text-xl cursor-pointer hover:text-blue-400" onclick="openApp('Display Settings', 'display-settings')"></i>
            <span id="system-time-bottom" class="text-white text-sm"></span>
            <span id="system-date-bottom" class="text-white text-sm"></span>
        </div>

        <!-- NEW: Standalone Start Button at bottom-left -->
        <button id="standalone-start-button" class="fixed bottom-4 left-4 flex items-center justify-center w-14 h-14 rounded-full bg-gray-800 bg-opacity-90 backdrop-blur-md hover:bg-blue-600 focus:outline-none transition-colors z-40 shadow-xl" onclick="toggleStartMenu()">
            <i class="fa-brands fa-windows text-blue-400 text-3xl"></i>
        </button>

    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden"></div>

    <!-- Beta Intro Modal -->
    <div id="beta-intro-modal" class="hidden">
        <div class="beta-intro-card">
            <h2 class="text-3xl font-bold mb-4 text-blue-400">Welcome to Windows 13 (0.4.1)</h2>
            <h3 class="text-xl font-semibold mb-3">Key Changes: Terminal & Settings Redesigned</h3>
            <p class="text-gray-300 mb-6">
                This update focuses on user interface refinements. The Terminal has been completely redesigned for a more modern and functional command-line experience. Additionally, the Settings application has been remade to align with contemporary Windows design principles, offering a more intuitive and visually appealing user experience.
            </p>
            <button onclick="hideBetaIntro()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">
                Got It!
            </button>
        </div>
    </div>


<!-- Embedded JavaScript code -->
<script>
    // Global variables for DOM elements, assigned in initializeDesktopListeners()
    let desktopEnvContainer;
    let loginScreen;
    let passwordInput;
    let loginTimeDisplay;
    let loginDateDisplay;
    let loginSpinner;
    let loginCard;
    let welcomeMessage;
    let loginErrorMessage; // For displaying login errors
    let createAccountModal;
    let newUsernameInput;
    let newPasswordInput;

    let desktop;
    let desktopIconsZone;
    let shortcutsZone;
    let desktopTimeDisplay;
    let desktopDateDisplay;

    let windowsContainer;
    let startMenu;
    let standaloneStartButton; // Changed from startButton
    let desktopContextMenu;
    // let taskbarApps; // Removed taskbarApps as taskbar is gone

    let internetVolumeContainer; // New reference
    let systemTimeBottom; // New reference
    let systemDateBottom; // New reference


    let zIndexCounter = 1000;
    let openWindows = {}; // Stores references to open window elements by app id

    // Global snap preview element (created once, reused)
    let snapPreviewElement = null;
    // Global variable to keep track of the currently active desktop icon
    let activeDesktopIcon = null;


    // --- Tone.js Synth for Boot Sound ---
    const bootSynth = new Tone.Synth().toDestination();

    function playBootSound() {
        // Simple ascending arpeggio for a modern Windows boot sound feel
        const now = Tone.now();
        bootSynth.triggerAttackRelease("C4", "8n", now);
        bootSynth.triggerAttackRelease("E4", "8n", now + 0.1);
        bootSynth.triggerAttackRelease("G4", "8n", now + 0.2);
        bootSynth.triggerAttackRelease("C5", "4n", now + 0.3);
    }

    // --- Utility Functions ---

    // Function to display a custom message box
    function showMessage(message, duration = 3000) {
        const messageBox = document.getElementById('message-box');
        if (messageBox) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
                // Hide completely after transition
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Match CSS transition duration for opacity/transform
            }, duration);
        } else {
            console.warn('Message box element not found!');
        }
    }

    /**
     * Shows the beta introduction modal if it hasn't been shown before.
     */
    function showBetaIntro() {
        if (!window.userPreferences.betaIntroShown && betaIntroModal) {
            betaIntroModal.classList.remove('hidden');
            setTimeout(() => betaIntroModal.classList.add('show'), 50); // Small delay for CSS transition
        }
    }

    /**
     * Hides the beta introduction modal and marks it as shown.
     */
    function hideBetaIntro() {
        if (betaIntroModal) {
            betaIntroModal.classList.remove('show');
            betaIntroModal.addEventListener('transitionend', () => {
                if (!betaIntroModal.classList.contains('show')) {
                    betaIntroModal.classList.add('hidden');
                }
            }, { once: true });
        }
        window.userPreferences.betaIntroShown = true;
        saveUserPreferences(); // Persist that the intro has been shown
    }

    /**
     * Sets the active desktop icon, removing the active state from any previously active icon.
     * @param {HTMLElement|null} iconElement - The icon element to set as active, or null to clear.
     */
    function setActiveDesktopIcon(iconElement) {
        // Remove active class from previously active icon
        if (activeDesktopIcon && activeDesktopIcon !== iconElement) {
            activeDesktopIcon.classList.remove('active');
        }
        // Add active class to the new icon
        if (iconElement) {
            iconElement.classList.add('active');
        }
        activeDesktopIcon = iconElement;
    }


    // --- Core OS Functions ---

    // Function to update time and date for both login screen and desktop shortcuts
    function updateTimeAndDate() {
        try {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };

            // Update login screen time and date
            if (loginTimeDisplay) loginTimeDisplay.textContent = now.toLocaleTimeString([], timeOptions);
            if (loginDateDisplay) loginDateDisplay.textContent = now.toLocaleDateString(undefined, dateOptions);

            // Update desktop shortcuts time and date (if desktop is visible)
            if (desktopTimeDisplay && desktopDateDisplay && desktopEnvContainer && desktopEnvContainer.classList.contains('desktop-active')) {
                desktopTimeDisplay.textContent = now.toLocaleTimeString([], timeOptions);
                desktopDateDisplay.textContent = now.toLocaleDateString(undefined, dateOptions);
            }
            // Update time and date in the new bottom-middle container
            if (systemTimeBottom && systemDateBottom) {
                systemTimeBottom.textContent = now.toLocaleTimeString([], timeOptions);
                systemDateBottom.textContent = now.toLocaleDateString();
            }

        } catch (error) {
            console.error('Error in updateTimeAndDate:', error);
        }
    }

    // Function to handle login transition
    function attemptLogin() {
        try {
            const enteredPassword = passwordInput.value;
            const storedPassword = window.userPreferences.password;

            if (loginErrorMessage) loginErrorMessage.classList.add('hidden'); // Hide previous error

            if (!storedPassword) { // First time login or new account created
                if (enteredPassword.length > 0) {
                    window.userPreferences.password = enteredPassword;
                    saveUserPreferences();
                    performLoginTransition();
                } else {
                    if (loginErrorMessage) {
                        loginErrorMessage.textContent = 'Please enter a password to set up your account.';
                        loginErrorMessage.classList.remove('hidden');
                    }
                }
            } else { // Password is set, validate it
                if (enteredPassword === storedPassword) {
                    performLoginTransition();
                } else {
                    if (loginErrorMessage) {
                        loginErrorMessage.textContent = 'Incorrect password.';
                        loginErrorMessage.classList.remove('hidden');
                    }
                }
            }
        } catch (error) {
            console.error('Error during login attempt:', error);
            showMessage(`Login failed: ${error.message}`);
        }
    }

    function performLoginTransition() {
        if (loginSpinner) loginSpinner.classList.add('show');
        playBootSound(); // Play boot sound only on successful login

        if (loginScreen) {
            anime({
                targets: loginScreen,
                opacity: 0,
                duration: 800,
                easing: 'easeOutQuad',
                complete: function() {
                    if (loginScreen) loginScreen.classList.add('hidden');
                    if (loginSpinner) loginSpinner.classList.remove('show');
                    if (desktopEnvContainer) {
                        desktopEnvContainer.classList.remove('blurred');
                        desktopEnvContainer.classList.add('desktop-active');
                        refreshDesktopAppearance(); // Call here after desktop is active
                    }
                    showBetaIntro(); // Show beta intro after successful login transition
                }
            });
        } else {
            console.error('loginScreen not found for animation.');
            if (loginSpinner) loginSpinner.classList.remove('show');
        }
    }

    // Handle Enter key press on password input for login - ATTACHED PROGRAMMATICALLY
    function handleLoginEnter(event) {
        if (event.key === 'Enter') {
            attemptLogin();
        }
    }

    /**
     * Shows the create account modal.
     */
    function showCreateAccountModal() {
        if (createAccountModal) {
            createAccountModal.classList.remove('hidden');
            // Clear inputs when showing
            if (newUsernameInput) newUsernameInput.value = '';
            if (newPasswordInput) newPasswordInput.value = '';
            // Pre-fill username with current if it's not default
            if (window.userPreferences.username !== 'User Name' && newUsernameInput) {
                newUsernameInput.value = window.userPreferences.username;
            }
        }
    }

    /**
     * Hides the create account modal.
     */
    function hideCreateAccountModal() {
        if (createAccountModal) {
            createAccountModal.classList.add('hidden');
        }
    }

    /**
     * Creates a new conceptual account (overwrites existing user data).
     */
    function createAccount() {
        const username = newUsernameInput.value.trim();
        const password = newPasswordInput.value;

        if (!username) {
            showMessage('Username cannot be empty.');
            return;
        }
        if (!password) {
            showMessage('Password cannot be empty.');
            return;
        }

        window.userPreferences.username = username;
        window.userPreferences.password = password;
        saveUserPreferences();
        hideCreateAccountModal();
        showMessage(`Account for ${username} created! Please sign in.`);
        // Update login screen to reflect new user and clear password input
        if (passwordInput) passwordInput.value = '';
        updateProfileDisplay(); // Update welcome message
    }


    // Function to toggle Start Menu visibility
    function toggleStartMenu() {
        try {
            const startMenuElement = document.getElementById('start-menu');
            if (startMenuElement) {
                if (startMenuElement.classList.contains('hidden')) {
                    startMenuElement.classList.remove('hidden');
                    // Optional: animate using anime.js for more complex effects
                    anime({
                        targets: startMenuElement,
                        scale: [0.95, 1],
                        opacity: [0, 1],
                        duration: 200,
                        easing: 'easeOutQuad'
                    });
                } else {
                    anime({
                        targets: startMenuElement,
                        scale: [1, 0.95],
                        opacity: [1, 0],
                        duration: 200,
                        easing: 'easeInQuad',
                        complete: function() {
                            startMenuElement.classList.add('hidden');
                        }
                    });
                }
            } else {
                console.warn('Start menu element not found.');
            }
        } catch (error) {
            console.error('Error toggling start menu:', error);
            showMessage(`Error: Cannot open Start Menu`);
        }
    }

    // Function to hide all context menus
    function hideAllContextMenus() {
        try {
            const desktopContextMenuElement = document.getElementById('desktop-context-menu');
            if (desktopContextMenuElement && !desktopContextMenuElement.classList.contains('hidden')) {
                // Animate out
                anime({
                    targets: desktopContextMenuElement,
                    scale: [1, 0.9],
                    opacity: [1, 0],
                    duration: 100,
                    easing: 'easeInQuad',
                    complete: function() {
                        desktopContextMenuElement.classList.add('hidden');
                    }
                });
            }
        } catch (error) {
            console.error('Error hiding all context menus:', error);
        }
    }

    // Show desktop context menu
    function showContextMenu(event) {
        event.preventDefault(); // Prevent default browser context menu
        hideAllContextMenus(); // This will now get the element itself

        try {
            const desktopContextMenuElement = document.getElementById('desktop-context-menu');
            if (desktopContextMenuElement) {
                desktopContextMenuElement.style.left = `${event.clientX}px`;
                desktopContextMenuElement.style.top = `${event.clientY}px`;
                desktopContextMenuElement.classList.remove('hidden');
                // Animate in
                anime({
                    targets: desktopContextMenuElement,
                    scale: [0.9, 1],
                    opacity: [0, 1],
                    duration: 100,
                    easing: 'easeOutQuad'
                });
                // Prevent clicks on the context menu from propagating to the desktop
                // and causing it to immediately close.
                desktopContextMenuElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                }, { once: true }); // Use once: true to remove listener after first click
            } else {
                console.warn('Desktop context menu element not found.');
            }
        } catch (error) {
            console.error('Error showing context menu:', error);
            showMessage(`Error: Cannot display context menu`);
        }
    }

    // Hide desktop context menu
    function hideContextMenu() {
        try {
            const desktopContextMenuElement = document.getElementById('desktop-context-menu');
            if (desktopContextMenuElement && !desktopContextMenuElement.classList.contains('hidden')) {
                // Animate out and then hide
                anime({
                    targets: desktopContextMenuElement,
                    scale: [1, 0.9],
                    opacity: [1, 0],
                    duration: 100,
                    easing: 'easeInQuad',
                    complete: function() {
                        desktopContextMenuElement.classList.add('hidden');
                    }
                });
            }
        } catch (error) {
            console.error('Error hiding context menu:', error);
        }
    }

    /**
     * Initializes the global snap preview element.
     */
    function initializeSnapPreview() {
        if (!snapPreviewElement) {
            snapPreviewElement = document.createElement('div');
            snapPreviewElement.className = 'snap-preview hidden'; // Hidden by default
            if (windowsContainer) {
                windowsContainer.appendChild(snapPreviewElement); // Add to the windows container
            } else {
                console.error('Windows container not found, cannot initialize snap preview.');
            }
        }
    }

    // Draggable and Resizable Window Logic
    function makeWindowDraggableAndResizable(windowElement, appId) {
        const header = windowElement.querySelector('.window-header');
        let isDragging = false;
        let isResizing = false;
        let initialMouseX, initialMouseY;
        let initialWindowX, initialWindowY;
        let initialWidth, initialHeight;

        let snappedState = null; // null, 'left', 'right', 'max'

        // Z-index management: bring clicked window to front
        windowElement.addEventListener('mousedown', () => {
            zIndexCounter++;
            windowElement.style.zIndex = zIndexCounter;
            if (snapPreviewElement) snapPreviewElement.classList.remove('show'); // Hide preview if interaction starts on a window

            // No taskbar icons to activate/deactivate anymore
        });

        // Dragging
        if (header) {
            header.addEventListener('mousedown', (e) => {
                // If maximized, restore first before dragging
                if (windowElement.classList.contains('maximized')) {
                    const maximizeRestoreBtn = windowElement.querySelector('.maximize-restore-btn');
                    if (maximizeRestoreBtn) {
                        maximizeRestoreBtn.click(); // Simulate click to restore
                        // After restoring, re-initialize drag state based on new position
                        const rect = windowElement.getBoundingClientRect();
                        initialWindowX = rect.left;
                        initialWindowY = rect.top;
                    } else {
                        return; // Should not happen if a maximize/restore button exists
                    }
                } else {
                    const rect = windowElement.getBoundingClientRect();
                    windowElement.style.left = `${rect.left}px`;
                    windowElement.style.top = `${rect.top}px`;
                    windowElement.style.transform = 'none'; // Remove centering transform
                    windowElement.style.right = 'auto'; // Clear right/bottom for direct left/top control
                    windowElement.style.bottom = 'auto';
                    initialWindowX = rect.left;
                    initialWindowY = rect.top;
                }

                isDragging = true;
                initialMouseX = e.clientX;
                initialMouseY = e.clientY;
                header.style.cursor = 'grabbing';
                snappedState = null; // Clear snapped state when dragging starts
            });
        }

        // Event listener for mousemove on the whole document for dragging/resizing
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                let newX = initialWindowX + (e.clientX - initialMouseX);
                let newY = initialWindowY + (e.clientY - initialMouseY);

                // Snapping Logic
                const desktopRect = desktop.getBoundingClientRect();
                const snapThreshold = 15; // pixels from edge to trigger snap

                let previewType = null;
                let previewWidth, previewHeight, previewLeft, previewTop;

                // Check for top edge (maximize)
                if (e.clientY < desktopRect.top + snapThreshold) {
                    previewType = 'max';
                    previewWidth = desktopRect.width;
                    previewHeight = desktopRect.height; // Full desktop height
                    previewLeft = desktopRect.left;
                    previewTop = desktopRect.top;
                }
                // Check for left edge (snap left)
                else if (e.clientX < desktopRect.left + snapThreshold) {
                    previewType = 'left';
                    previewWidth = desktopRect.width / 2;
                    previewHeight = desktopRect.height;
                    previewLeft = desktopRect.left;
                    previewTop = desktopRect.top;
                }
                // Check for right edge (snap right)
                else if (e.clientX > desktopRect.right - snapThreshold) {
                    previewType = 'right';
                    previewWidth = desktopRect.width / 2;
                    previewHeight = desktopRect.height;
                    previewLeft = desktopRect.left + desktopRect.width / 2;
                    previewTop = desktopRect.top;
                } else {
                    // No snap zone
                    previewType = null;
                }

                if (previewType && snapPreviewElement) {
                    snapPreviewElement.style.width = `${previewWidth}px`;
                    snapPreviewElement.style.height = `${previewHeight}px`;
                    snapPreviewElement.style.left = `${previewLeft}px`;
                    snapPreviewElement.style.top = `${previewTop}px`;
                    snapPreviewElement.classList.add('show');
                } else if (snapPreviewElement) {
                    snapPreviewElement.classList.remove('show');
                }

                // Update actual window position only if no snap preview is active
                if (!previewType) {
                    const windowRect = windowElement.getBoundingClientRect(); // Get updated rect
                    newX = Math.max(desktopRect.left, Math.min(newX, desktopRect.right - windowRect.width));
                    newY = Math.max(desktopRect.top, Math.min(newY, desktopRect.bottom - windowRect.height));

                    windowElement.style.left = `${newX}px`;
                    windowElement.style.top = `${newY}px`;
                }

            } else if (isResizing) {
                e.preventDefault();
                let newWidth = initialWidth + (e.clientX - initialMouseX);
                let newHeight = initialHeight + (e.clientY - initialMouseY);

                windowElement.style.width = `${Math.max(newWidth, 300)}px`;
                windowElement.style.height = `${Math.max(newHeight, 200)}px`;
            }
        });

        // Event listener for mouseup on the whole document to stop dragging/resizing
        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                isDragging = false;
                header.style.cursor = 'grab'; // Restore cursor

                if (snapPreviewElement && snapPreviewElement.classList.contains('show')) {
                    // Apply snap
                    const previewRect = snapPreviewElement.getBoundingClientRect();
                    windowElement.style.width = `${previewRect.width}px`;
                    windowElement.style.height = `${previewRect.height}px`;
                    windowElement.style.left = `${previewRect.left}px`;
                    windowElement.style.top = `${previewRect.top}px`;
                    windowElement.style.transform = 'none'; // Ensure no conflicting transforms
                    windowElement.style.right = 'auto';
                    windowElement.style.bottom = 'auto';

                    // If maximizing, update the icon on the window controls
                    const maximizeRestoreBtn = windowElement.querySelector('.maximize-restore-btn');
                    if (maximizeRestoreBtn) {
                         maximizeRestoreBtn.innerHTML = '<i class="fa-solid fa-compress"></i>'; // Restore icon
                         windowElement.classList.add('maximized'); // Add maximized class
                    }
                } else {
                    // If not snapped, ensure maximized state is removed if it was a false alarm.
                    // This is important if a user moves a maximized window and doesn't snap it.
                     windowElement.classList.remove('maximized');
                     const maximizeRestoreBtn = windowElement.querySelector('.maximize-restore-btn');
                     if (maximizeRestoreBtn) maximizeRestoreBtn.innerHTML = '<i class="fa-regular fa-square"></i>';
                }
                if (snapPreviewElement) snapPreviewElement.classList.remove('show');
            }
            isResizing = false;
            document.body.style.cursor = 'default';
        });

        // Resizing (custom handle)
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        windowElement.appendChild(resizeHandle);

        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', (e) => {
                try {
                    if (windowElement.classList.contains('maximized')) return; // Cannot resize when maximized
                    isResizing = true;
                    initialMouseX = e.clientX;
                    initialMouseY = e.clientY;
                    initialWidth = windowElement.offsetWidth;
                    initialHeight = windowElement.offsetHeight;
                    e.stopPropagation(); // Prevent dragging from starting
                } catch (error) {
                    console.error('Error on resize handle mousedown:', error);
                }
            });
        }

        // Window controls
        const minimizeBtn = windowElement.querySelector('.minimize-btn');
        const maximizeRestoreBtn = windowElement.querySelector('.maximize-restore-btn');
        const closeBtn = windowElement.querySelector('.close-btn');

        // Minimize
        if (minimizeBtn) {
            minimizeBtn.addEventListener('click', () => {
                try {
                    windowElement.classList.add('minimized');
                    // No taskbar icon to remove 'active' class from directly anymore
                } catch (error) {
                    console.error('Error minimizing window:', error);
                    showMessage(`Error minimizing ${appId}`);
                }
            });
        }

        // Maximize/Restore
        if (maximizeRestoreBtn) {
            maximizeRestoreBtn.addEventListener('click', () => {
                try {
                    if (windowElement.classList.contains('maximized')) {
                        // Restore
                        windowElement.classList.remove('maximized');
                        maximizeRestoreBtn.innerHTML = '<i class="fa-regular fa-square"></i>'; // Maximize icon
                        // Restore previous position and size if stored
                        if (windowElement.dataset.prevLeft && windowElement.dataset.prevTop &&
                            windowElement.dataset.prevWidth && windowElement.dataset.prevHeight) {
                            windowElement.style.left = windowElement.dataset.prevLeft;
                            windowElement.style.top = windowElement.dataset.prevTop;
                            windowElement.style.width = windowElement.dataset.prevWidth;
                            windowElement.style.height = windowElement.dataset.prevHeight;
                            windowElement.style.transform = windowElement.dataset.prevTransform || '';
                        }
                    } else {
                        // Maximize
                        // Store current position and size
                        const rect = windowElement.getBoundingClientRect();
                        windowElement.dataset.prevLeft = `${rect.left}px`;
                        windowElement.dataset.prevTop = `${rect.top}px`;
                        windowElement.dataset.prevWidth = `${rect.width}px`;
                        windowElement.dataset.prevHeight = `${rect.height}px`;
                        windowElement.dataset.prevTransform = windowElement.style.transform;

                        windowElement.classList.add('maximized');
                        maximizeRestoreBtn.innerHTML = '<i class="fa-solid fa-compress"></i>'; // Restore icon
                        // Ensure window takes full desktop space
                        const desktopRect = desktop.getBoundingClientRect();
                        windowElement.style.left = `${desktopRect.left}px`;
                        windowElement.style.top = `${desktopRect.top}px`;
                        windowElement.style.width = `${desktopRect.width}px`;
                        windowElement.style.height = `${desktopRect.height}px`;
                        windowElement.style.transform = 'none';
                    }
                } catch (error) {
                    console.error('Error maximizing/restoring window:', error);
                    showMessage(`Error with ${appId} window size`);
                }
            });
        }

        // Close
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                try {
                    // Add closing animation class
                    windowElement.classList.add('closing');

                    // Listen for animation end before removing
                    windowElement.addEventListener('animationend', () => {
                        // If the closed app's icon was active, clear active state
                        if (activeDesktopIcon && activeDesktopIcon.dataset.appId === appId) {
                            setActiveDesktopIcon(null);
                        }
                        windowElement.remove();
                        delete openWindows[appId];
                        // No taskbar icon to remove anymore
                    }, { once: true }); // Ensure listener runs only once
                } catch (error) {
                    console.error('Error closing window:', error);
                    showMessage(`Error closing ${appId}`);
                }
            });
        }
        // Set initial position after appending for correct getBoundingClientRect values
        const desktopRect = desktop.getBoundingClientRect();
        const initialX = desktopRect.width * 0.15; // 15% from left of desktop
        const initialY = desktopRect.height * 0.15; // 15% from top of desktop
        const initialWidthCalculated = desktopRect.width * 0.7; // 70% of desktop width
        const initialHeightCalculated = desktopRect.height * 0.7; // 70% of desktop height

        windowElement.style.left = `${initialX}px`;
        windowElement.style.top = `${initialY}px`;
        windowElement.style.width = `${initialWidthCalculated}px`;
        windowElement.style.height = `${initialHeightCalculated}px`;
    }

    /**
     * Helper function to create a new window element with basic controls.
     * @param {string} appTitle - The title of the app.
     * @param {string} appId - Unique ID for the app.
     * @param {string} iconHTML - HTML string for the app icon (e.g., '<i class="..."></i>').
     * @returns {HTMLElement} The newly created window element.
     */
    function createNewWindow(appTitle, appId, iconHTML) {
        const windowElement = document.createElement('div');
        windowElement.id = `window-${appId}`;
        windowElement.className = `window flex flex-col opening`;
        windowElement.style.zIndex = zIndexCounter++; // Set z-index and increment
        windowElement.style.pointerEvents = 'auto'; // Re-enable pointer events for the new window

        windowElement.innerHTML = `
            <div class="window-header flex items-center justify-between p-3">
                <div class="flex items-center gap-2">
                    ${iconHTML}
                    <span class="text-md font-semibold">${appTitle}</span>
                </div>
                <div class="flex space-x-2">
                    <button class="minimize-btn">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                    <button class="maximize-restore-btn">
                        <i class="fa-regular fa-square"></i>
                    </button>
                    <button class="close-btn">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <div class="window-content flex-grow overflow-auto relative">
                <!-- App specific content will be injected here -->
            </div>
        `;

        windowsContainer.appendChild(windowElement);
        openWindows[appId] = windowElement;

        // No taskbar icons to add anymore, as per user request.

        // Ensure input is focused when window opens - relevant for terminal/editor
        windowElement.addEventListener('animationend', () => {
            windowElement.classList.remove('opening');
            // Auto-focus on relevant elements if they exist
            const inputElement = windowElement.querySelector('input[type="text"], textarea');
            if (inputElement) {
                inputElement.focus();
            }
        }, { once: true });


        makeWindowDraggableAndResizable(windowElement, appId); // Apply drag/resize after creation

        return windowElement;
    }

    /**
     * Helper function to restore a minimized window and bring it to front.
     * @param {HTMLElement} windowElement - The window element to restore.
     */
    function restoreWindow(windowElement) {
        windowElement.classList.remove('minimized');
        zIndexCounter++;
        windowElement.style.zIndex = zIndexCounter;
        // No taskbar icon to activate anymore.
    }


    // Function to handle tab switching specifically for the "About Windows 13" app
    function showSettingsCategory(parentWindow, categoryId) {
        // Hide all content areas within the settings app
        parentWindow.querySelectorAll('.settings-content-area > div').forEach(div => {
            div.classList.add('hidden');
            div.classList.remove('animate-fade-in'); // Remove animation class if present
        });
        // Deactivate all sidebar items
        parentWindow.querySelectorAll('.settings-category-item').forEach(item => {
            item.classList.remove('active');
            // Re-apply original hover states if they were overridden by active state
            item.classList.add('hover:bg-[rgba(59,130,246,0.2)]');
        });

        // Show the selected content area
        const targetContent = parentWindow.querySelector(`#${categoryId}-content`);
        if (targetContent) {
            targetContent.classList.remove('hidden');
            // Optional: Add a fade-in animation for content change
            anime({
                targets: targetContent,
                opacity: [0, 1],
                duration: 200,
                easing: 'easeOutQuad'
            });
        }

        // Activate the clicked sidebar item
        const clickedItem = parentWindow.querySelector(`.settings-category-item[data-category-id="${categoryId}"]`);
        if (clickedItem) {
            clickedItem.classList.add('active');
            // Remove hover class from the active item as it's now visually active
            clickedItem.classList.remove('hover:bg-[rgba(59,130,246,0.2)]');
        }

         // Special handling for personalization to ensure wallpaper preview and inputs are updated
        if (categoryId === 'personalization') {
            const currentWallpaperPreview = parentWindow.querySelector('#current-wallpaper-preview');
            if (currentWallpaperPreview) {
                currentWallpaperPreview.style.backgroundImage = `url('${window.userPreferences.wallpaperUrl}')`;
            }
             // Ensure existing wallpaper is visually selected
            document.querySelectorAll('#personalization-content img').forEach(img => {
                img.classList.remove('border-blue-500');
                img.classList.add('border-transparent');
                if (img.src.includes(encodeURIComponent(window.userPreferences.wallpaperUrl))) {
                    img.classList.remove('border-transparent');
                    img.classList.add('border-blue-500');
                }
            });
            const wallpaperUrlInput = parentWindow.querySelector('#wallpaper-url-input');
            if (wallpaperUrlInput) {
                wallpaperUrlInput.value = ''; // Clear custom URL field on category switch
            }
        }
        // Special handling for accounts to update display
        if (categoryId === 'accounts') {
            updateProfileDisplay(); // Call this to refresh username/password fields
        }

        // Special handling for Display Settings category to initialize its controls
        if (categoryId === 'system') {
            const displaySettingsButton = parentWindow.querySelector('#system-content button');
            if (displaySettingsButton) {
                displaySettingsButton.onclick = () => {
                    openApp('Display Settings', 'display-settings');
                    parentWindow.querySelector('.close-btn').click(); // Close settings when opening display settings
                };
            }
        }
    }


    // Function to handle tab switching specifically for the "About Windows 13" app
    function showAboutTabForApp(parentWindow, tabName) {
        const aboutContent = parentWindow.querySelector('#about-content');
        const updatesContent = parentWindow.querySelector('#updates-content');
        const aboutTabBtn = parentWindow.querySelector('#about-tab-btn');
        const updatesTabBtn = parentWindow.querySelector('#updates-tab-btn');

        if (tabName === 'about') {
            if(aboutContent) aboutContent.classList.remove('hidden');
            if(updatesContent) updatesContent.classList.add('hidden');
            if(aboutTabBtn) {
                aboutTabBtn.classList.add('bg-blue-700');
                aboutTabBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
            }
            if(updatesTabBtn) {
                updatesTabBtn.classList.remove('bg-blue-700');
                updatesTabBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
            }
        } else if (tabName === 'updates') {
            if(aboutContent) aboutContent.classList.add('hidden');
            if(updatesContent) updatesContent.classList.remove('hidden');
            if(aboutTabBtn) {
                aboutTabBtn.classList.remove('bg-blue-700');
                aboutTabBtn.classList.add('bg-gray-800', 'hover:bg-gray-700');
            }
            if(updatesTabBtn) {
                updatesTabBtn.classList.add('bg-blue-700');
                updatesTabBtn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
            }
        }
    }

    // Open Application Window
    function openApp(appName, appId, event) { // Added event parameter
        try {
            hideAllContextMenus();
            // Don't toggle start menu if the app is opened from context menu directly
            // only toggle if it was opened via a start menu item or icon
            if (event && (event.currentTarget.closest('#start-menu') || event.currentTarget.classList.contains('desktop-icon'))) {
                 toggleStartMenu();
            }

            let clickedIconElement = null;
            if (event && event.currentTarget.classList.contains('desktop-icon')) {
                clickedIconElement = event.currentTarget;
                setActiveDesktopIcon(clickedIconElement); // Set this icon as active
            } else {
                setActiveDesktopIcon(null); // Clear active icon if opened from start menu
            }


            if (openWindows[appId]) {
                // If app is already open, bring it to front or restore if minimized
                restoreWindow(openWindows[appId]);
                return;
            }

            // Define icon HTML for window header
            let iconHTML = '';
            switch (appId) {
                case 'file-explorer': iconHTML = '<i class="fa-solid fa-folder-open text-blue-400 text-lg"></i>'; break;
                case 'browser': iconHTML = '<i class="fa-solid fa-globe text-purple-400 text-lg"></i>'; break;
                case 'terminal': iconHTML = '<i class="fa-solid fa-terminal text-green-400 text-lg"></i>'; break;
                case 'solar-panel': iconHTML = '<i class="fa-solid fa-solar-panel text-yellow-400 text-lg"></i>'; break;
                case 'settings': iconHTML = '<i class="fa-solid fa-gear text-gray-400 text-lg"></i>'; break;
                case 'about-windows': iconHTML = '<img src="assets/Logo/Windows_13_logo.png" alt="Win13" class="w-5 h-5">'; break; // Smaller for header
                case 'calculator': iconHTML = '<i class="fa-solid fa-calculator text-red-400 text-lg"></i>'; break;
                case 'image-viewer': iconHTML = '<i class="fa-solid fa-image text-pink-400 text-lg"></i>'; break;
                case 'todo-list': iconHTML = '<i class="fa-solid fa-list-check text-green-400 text-lg"></i>'; break;
                case 'weather': iconHTML = '<i class="fa-solid fa-cloud-sun-rain text-blue-300 text-lg"></i>'; break;
                case 'display-settings': iconHTML = '<i class="fa-solid fa-display text-blue-400 text-lg"></i>'; break;
                case 'recycle-bin': iconHTML = '<i class="fa-solid fa-trash-can text-gray-500 text-lg"></i>'; break;
                case 'code-editor': iconHTML = '<i class="fa-solid fa-code text-orange-400 text-lg"></i>'; break;
                case 'windows-update': iconHTML = '<i class="fa-solid fa-cloud-arrow-down text-blue-500 text-lg"></i>'; break;
                case 'date-time': iconHTML = '<i class="fa-solid fa-clock text-blue-400 text-lg"></i>'; break;
                default: iconHTML = '<i class="fa-solid fa-cube text-gray-400 text-lg"></i>'; break;
            }

            const windowElement = createNewWindow(appName, appId, iconHTML);
            let contentHTML = '';
            let bigIconHTML = iconHTML.replace('text-lg', 'text-8xl mb-4 opacity-50'); // For larger icons in content area

            switch (appId) {
                case 'file-explorer':
                    contentHTML = `
                        <div class="flex flex-col flex-grow p-4 overflow-auto">
                            <div class="flex items-center space-x-2 mb-4">
                                <button id="fe-back-btn" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-white"><i class="fas fa-arrow-left"></i></button>
                                <button id="fe-up-btn" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-white"><i class="fas fa-arrow-up"></i></button>
                                <span id="fe-path-display" class="flex-grow text-gray-300 bg-gray-800 px-3 py-1 rounded-md cursor-pointer truncate" onclick="copyToClipboard(this.textContent)">${window.currentPath}</span>
                            </div>
                            <div id="fe-content" class="flex-grow overflow-auto bg-gray-800 rounded-lg p-3">
                                <!-- File system content will be rendered here -->
                            </div>
                        </div>
                    `;
                    break;
                case 'browser':
                    contentHTML = `
                        <div class="flex items-center p-2 bg-gray-800 rounded-b-none border-b border-gray-700 relative z-10">
                            <input type="text" class="flex-grow rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value="https://www.conceptbrowser.com" readonly>
                            <button class="ml-2 p-1 rounded-full text-gray-400"><i class="fa-solid fa-sync"></i></button>
                        </div>
                        <div class="p-4 flex-grow overflow-auto text-center relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <p class="text-lg text-gray-400 relative z-10">Welcome to the future of browsing!</p>
                            <p class="text-sm text-gray-500 mt-2 relative z-10">This is a conceptual browser for Windows 13.</p>
                        </div>
                    `;
                    break;
                case 'terminal':
                    contentHTML = `
                        <div class="p-4 flex-grow font-mono text-sm overflow-auto bg-black text-gray-200 rounded-b-lg">
                             <div id="terminal-output-${appId}" class="h-full overflow-y-auto pb-8">
                                <pre>Welcome to the Terminal!</pre>
                                <pre>Type 'help' for commands.</pre>
                                <pre class="mt-2">Connecting to host...</pre>
                                <pre>Connection established.</pre>
                             </div>
                             <div class="flex items-center mt-2">
                                <span class="text-green-400">user@computer</span>:<span id="terminal-current-path-${appId}" class="text-blue-400">${window.currentPath.replace(/\\/g, '/')}</span>$&nbsp;
                                <input type="text" id="terminal-input-${appId}" class="flex-grow bg-transparent text-gray-200 border-none outline-none caret-white p-0" autofocus>
                             </div>
                        </div>
                    `;
                    break;
                case 'solar-panel':
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <h3 class="text-2xl font-bold text-yellow-300 mb-2 relative z-10">Solar Panel Dashboard</h3>
                            <p class="text-gray-300 max-w-sm relative z-10">
                                Monitor your solar energy production and consumption in real-time. This is a conceptual application.
                            </p>
                            <div class="mt-4 text-sm relative z-10">
                                <p>Current Output: <span class="font-bold text-green-400">1.2 kW</span></p>
                                <p>Daily Production: <span class="font-bold text-blue-400">8.5 kWh</span></p>
                            </div>
                            <button class="mt-6 px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-full shadow-lg relative z-10">
                                View Analytics
                            </button>
                        </div>
                    `;
                    break;
                case 'settings':
                    contentHTML = `
                        <div class="flex flex-row flex-grow">
                            <div class="settings-sidebar">
                                <h3 class="text-xl font-semibold mb-6 text-gray-100">Settings</h3>
                                <ul class="space-y-1">
                                    <li class="settings-category-item" data-category-id="system" onclick="showSettingsCategory(this.closest('.window'), 'system')">
                                        <i class="fa-solid fa-desktop"></i><span>System</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="network" onclick="showSettingsCategory(this.closest('.window'), 'network')">
                                        <i class="fa-solid fa-wifi"></i><span>Network & Internet</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="personalization" onclick="showSettingsCategory(this.closest('.window'), 'personalization')">
                                        <i class="fa-solid fa-brush"></i><span>Personalization</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="accounts" onclick="showSettingsCategory(this.closest('.window'), 'accounts')">
                                        <i class="fa-solid fa-user-circle"></i><span>Accounts</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="update-security" onclick="showSettingsCategory(this.closest('.window'), 'update-security')">
                                        <i class="fa-solid fa-shield-alt"></i><span>Update & Security</span>
                                    </li>
                                    <li class="settings-category-item" data-category-id="about" onclick="showSettingsCategory(this.closest('.window'), 'about')">
                                        <i class="fa-solid fa-info-circle"></i><span>About</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="settings-content-area">
                                <!-- System Settings Content -->
                                <div id="system-content" class="hidden">
                                    <h4 class="text-2xl font-semibold mb-6">System</h4>
                                    <div class="space-y-6">
                                        <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                                            <div>
                                                <p class="font-medium text-lg mb-1">Display</p>
                                                <p class="text-sm text-gray-400">Manage your connected displays and display settings.</p>
                                            </div>
                                            <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md" onclick="openApp('Display Settings', 'display-settings'); this.closest('.window').querySelector('.close-btn').click();">Open Display Settings</button>
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Sound Output</p>
                                            <select id="sound-output" class="w-full rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option>Speakers (Realtek Audio)</option>
                                                <option>Headphones</option>
                                            </select>
                                            <p class="text-sm text-gray-400 mt-2">Choose your output device and adjust volume.</p>
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Notifications & actions</p>
                                            <p class="text-sm text-gray-400">Manage notifications from apps and other senders.</p>
                                            <button class="mt-3 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md">Notification settings</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Network & Internet Content -->
                                <div id="network-content" class="hidden">
                                    <h4 class="text-2xl font-semibold mb-6">Network & Internet</h4>
                                    <div class="space-y-6">
                                        <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                                            <div>
                                                <p class="font-medium text-lg mb-1">Wi-Fi</p>
                                                <p class="text-sm text-gray-400">Connect to, manage, or disconnect from Wi-Fi networks.</p>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" value="" class="sr-only peer" checked>
                                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Ethernet</p>
                                            <p class="text-sm text-gray-400">View your network properties for wired connections.</p>
                                            <button class="mt-3 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md">View network properties</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Personalization Content -->
                                <div id="personalization-content" class="hidden">
                                    <h4 class="text-2xl font-semibold mb-6">Personalization</h4>
                                    <div class="space-y-6">
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <h5 class="font-medium text-lg mb-3">Desktop Background</h5>
                                            <div id="current-wallpaper-preview" class="w-full h-32 bg-gray-700 rounded-lg bg-cover bg-center mb-4" style="background-image: var(--desktop-image);"></div>
                                            <p class="text-sm text-gray-400 mb-3">Choose from predefined or enter a custom URL.</p>

                                            <div class="grid grid-cols-2 gap-3 mb-4">
                                                <img src="Assets/Background/BackgroundV2.png" alt="Default Wallpaper" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('Assets/Background/BackgroundV2.png', this)">
                                                <img src="https://placehold.co/400x240/007bff/ffffff?text=Blue+Gradient" alt="Blue Gradient" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('https://placehold.co/400x240/007bff/ffffff?text=Blue+Gradient', this)">
                                                <img src="https://placehold.co/400x240/28a745/ffffff?text=Green+Pattern" alt="Green Pattern" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('https://placehold.co/400x240/28a745/ffffff?text=Green+Pattern', this)">
                                                <img src="https://placehold.co/400x240/6f42c1/ffffff?text=Purple+Abstract" alt="Purple Abstract" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="selectWallpaper('https://placehold.co/400x240/6f42c1/ffffff?text=Purple+Abstract', this)">
                                            </div>

                                            <label for="wallpaper-url-input" class="block text-sm font-medium text-gray-400 mb-2">Custom Wallpaper URL</label>
                                            <input type="text" id="wallpaper-url-input" class="w-full mb-3" placeholder="Enter image URL">
                                            <button class="px-5 py-2 bg-blue-600 hover:bg-blue-700 rounded-md" onclick="applyCustomWallpaper()">Apply Custom Wallpaper</button>
                                            <button class="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="saveUserPreferences()">Save Wallpaper</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Accounts Content -->
                                <div id="accounts-content" class="hidden">
                                    <h4 class="text-2xl font-semibold mb-6">Accounts</h4>
                                    <div class="space-y-6">
                                        <div class="bg-gray-800 p-4 rounded-lg flex items-center gap-4">
                                            <div class="profile-pic-login w-16 h-16 text-3xl mx-0 my-0">
                                                <i class="fa-solid fa-user"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-lg" id="current-username-display">User Name</p>
                                                <p class="text-sm text-gray-400">Administrator</p>
                                            </div>
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <label for="accounts-username-input" class="block text-sm font-medium text-gray-400 mb-2">Change Username</label>
                                            <input type="text" id="accounts-username-input" class="w-full mb-3" placeholder="New Username" value="${window.userPreferences.username}">
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <label for="accounts-password-input" class="block text-sm font-medium text-gray-400 mb-2">Change Password</label>
                                            <input type="password" id="accounts-password-input" class="w-full mb-1" placeholder="New Password (for demo only)" value="${window.userPreferences.password}">
                                            <p class="text-xs text-red-400 mt-1">Warning: In a real application, passwords should be hashed and never stored directly.</p>
                                        </div>
                                        <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="updateAccountDetails()">Save Account Changes</button>
                                    </div>
                                </div>

                                <!-- Update & Security Content -->
                                <div id="update-security-content" class="hidden">
                                    <h4 class="text-2xl font-semibold mb-6">Update & Security</h4>
                                    <div class="space-y-6">
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Windows Update</p>
                                            <p class="text-sm text-gray-400">Check for and manage updates to Windows.</p>
                                            <button class="mt-3 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="showMessage('Checking for updates...');">Check for Updates</button>
                                            <p class="text-sm text-gray-400 mt-3">Last checked: Just now</p>
                                            <p class="text-sm text-gray-400">Updates are available (conceptual)!</p>
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Windows Security</p>
                                            <p class="text-sm text-gray-400">Manage virus & threat protection, firewall, and account protection.</p>
                                            <button class="mt-3 px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-md">Open Windows Security</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- About Settings Content -->
                                <div id="about-content" class="hidden">
                                    <h4 class="text-2xl font-semibold mb-6">About</h4>
                                    <div class="space-y-4">
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Device specifications</p>
                                            <p class="text-gray-300">
                                                Windows 13 Concept
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                Version: 0.4.1
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                Build: 10.0.23456.800
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                Processor: Conceptual Core i9-13900K
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                Installed RAM: 32.0 GB
                                            </p>
                                        </div>
                                        <div class="bg-gray-800 p-4 rounded-lg">
                                            <p class="font-medium text-lg mb-2">Windows specifications</p>
                                            <p class="text-gray-300">
                                                Edition: Windows 13 Home (Concept)
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                Version: 23H2 (Conceptual)
                                            </p>
                                            <p class="text-sm text-gray-400">
                                                Installed on: 6/15/2025
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'about-windows':
                    // Update bigIconHTML for specific apps if needed
                    bigIconHTML = '<img src="assets/Logo/Windows_13_logo.png" alt="Windows 13 Logo" class="w-20 h-20 mb-4 opacity-50">';
                    contentHTML = `
                        <div class="flex flex-col flex-grow relative">
                            <div class="flex border-b border-gray-700">
                                <button id="about-tab-btn" class="px-4 py-2 border-r border-gray-700 bg-blue-700 rounded-t-lg transition-colors">About</button>
                                <button id="updates-tab-btn" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 transition-colors">Updates</button>
                            </div>
                            <div id="about-content" class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center text-center">
                                ${bigIconHTML}
                                <h3 class="text-xl font-semibold mb-3">About Windows 13 Concept</h3>
                                <p class="text-gray-300 mb-4">
                                    Welcome to Windows 13, a conceptual operating system designed to showcase modern UI/UX principles.
                                    This is a preview of what the future of desktop computing could look like.
                                </p>
                                <p class="text-gray-400 mt-4">
                                    For a glimpse into past concepts, you might be interested in the
                                    <a href="https://lttthedev.github.io/desktop.html" target="_blank" class="text-blue-400 hover:underline">Windows 12 demo website</a>.
                                </p>
                            </div>
                            <div id="updates-content" class="p-4 flex-grow overflow-auto hidden flex flex-col items-center justify-center text-center">
                                ${bigIconHTML}
                                <h3 class="text-xl font-semibold mb-3">Windows 13 Updates</h3>
                                <!-- NEW UPDATE ENTRY START -->
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.4.1</p>
                                    <p class="text-blue-400 mb-2">Key Changes: Terminal & Settings Redesigned</p>
                                    <p class="text-gray-300">
                                        This update focuses on user interface refinements. The Terminal has been completely redesigned for a more modern and functional command-line experience. Additionally, the Settings application has been remade to align with contemporary Windows design principles, offering a more intuitive and visually appealing user experience.
                                    </p>
                                </div>
                                <!-- NEW UPDATE ENTRY END -->
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: V0.4.0 (Official)</p>
                                    <p class="text-blue-400 mb-2">Codename: Stability & Feature Parity</p>
                                    <p class="text-gray-300">
                                        Thank you for your patience! This official release was delayed to ensure critical bug fixes,
                                        performance optimizations, and feature completeness for a seamless user experience.
                                        We've focused on enhancing underlying stability, refining UI animations, and implementing
                                        robust error handling. This version brings all the promised features of the beta
                                        into a production-ready state, ensuring reliability and a polished feel.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.95</p>
                                    <p class="text-blue-400 mb-2">Codename: Background remake & Login change info</p>
                                    <p class="text-gray-300">
                                        This update introduces significant visual enhancements, allowing users to customize their desktop
                                        backgrounds with both predefined options and custom image URLs. Additionally, the login screen
                                        now includes improved informational displays, providing clearer feedback during the sign-in process.
                                        These changes aim to personalize the user experience and streamline initial system access.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.9</p>
                                    <p class="text-blue-400 mb-2">Codename: Layout change & Start Menu change</p>
                                    <p class="text-gray-300">
                                        This update brings a significant overhaul to the desktop layout.
                                        The taskbar has been removed, integrating its core functionalities into the Start Menu.
                                        The desktop now features a left-aligned icon zone and a right-aligned "Shortcuts" area,
                                        which prominently displays the time and date, now clickable to open the new "Date/Time" application.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.8</p>
                                    <p class="text-blue-400 mb-2">Codename: Scrolling added</p>
                                    <p class="text-gray-300">
                                        This mini-update ensures that various application windows and content areas within the OS
                                        now correctly support scrolling when their content exceeds the visible area.
                                        This improves usability and access to information in apps like File Explorer, Terminal,
                                        and other dynamic content displays.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.73</p>
                                    <p class="text-blue-400 mb-2">Codename: Boot up sound Update & Loading Update</p>
                                    <p class="text-gray-300">
                                        This significant update enhances the user's initial experience by refining the boot-up sound for a more pleasing auditory feedback.
                                        Additionally, the loading spinner throughout the system has been redesigned to align with modern Windows aesthetics, offering a smoother and more visually appealing waiting indicator.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.4</p>
                                    <p class="text-blue-400 mb-2">Codename: Login Patch & boot up sounds</p>
                                    <p class="text-gray-300">
                                        This update revamps the login screen with a modern aesthetic and introduces a subtle boot-up sound for a more immersive experience.
                                    </p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="font-bold text-lg mb-2">Version: 0.3.0</p>
                                    <p class="text-blue-400 mb-2">Codename: Desktop columns & a Windows Update setting (alpha version)</p>
                                    <p class="text-gray-300 text-sm">
                                        This update introduces a more organized desktop layout with columns and adds
                                        a conceptual Windows Update setting for future expansion.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'date-time':
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto relative flex flex-col justify-between">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <div class="app-main-content relative z-10 flex flex-col items-center justify-center h-full">
                                <h3 class="text-xl font-semibold mb-3">Date and Time</h3>
                                <p class="text-gray-300 mb-4">Welcome to Date and Time! Here's the current system time:</p>
                                <div class="text-center">
                                    <p class="text-5xl font-bold text-blue-300" id="app-current-time"></p>
                                    <p class="text-2xl text-gray-400 mt-2" id="app-current-date"></p>
                                </div>
                                <div class="mt-6 flex justify-center gap-4">
                                    <button class="px-4 py-2 bg-blue-600 rounded-md hover:bg-blue-700">Change Time</button>
                                    <button class="px-4 py-2 bg-gray-700 rounded-md hover:bg-gray-600">Change Date</button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'calculator':
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center">
                            <div class="w-full max-w-sm bg-gray-900 rounded-lg shadow-xl p-4">
                                <input type="text" id="calc-display" class="w-full mb-4 px-3 py-2 text-3xl text-right bg-gray-700 text-white rounded-md focus:outline-none" value="0" readonly>
                                <div class="grid grid-cols-4 gap-2">
                                    <button class="calc-btn bg-gray-500 col-span-2" data-value="C">C</button>
                                    <button class="calc-btn bg-gray-500" data-value="\u2190">←</button>
                                    <button class="calc-btn bg-orange-500" data-value="/">/</button>

                                    <button class="calc-btn" data-value="7">7</button>
                                    <button class="calc-btn" data-value="8">8</button>
                                    <button class="calc-btn" data-value="9">9</button>
                                    <button class="calc-btn bg-orange-500" data-value="*">*</button>

                                    <button class="calc-btn" data-value="4">4</button>
                                    <button class="calc-btn" data-value="5">5</button>
                                    <button class="calc-btn" data-value="6">6</button>
                                    <button class="calc-btn bg-orange-500" data-value="-">-</button>

                                    <button class="calc-btn" data-value="1">1</button>
                                    <button class="calc-btn" data-value="2">2</button>
                                    <button class="calc-btn" data-value="3">3</button>
                                    <button class="calc-btn bg-orange-500" data-value="+">+</button>

                                    <button class="calc-btn col-span-2" data-value="0">0</button>
                                    <button class="calc-btn" data-value=".">.</button>
                                    <button class="calc-btn bg-blue-600" data-value="=">=</button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'todo-list':
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto">
                            <h3 class="text-xl font-semibold mb-4">My To-Do List</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="todo-input" class="flex-grow rounded-md" placeholder="Add a new task...">
                                <button id="add-todo-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">Add</button>
                            </div>
                            <ul id="todo-list-items" class="space-y-2">
                                <!-- Example tasks, dynamically added/removed -->
                                <li class="flex items-center bg-gray-800 p-2 rounded-md justify-between">
                                    <span>Learn more about Windows 13</span>
                                    <button class="text-red-400 hover:text-red-500 text-sm delete-todo-btn">Delete</button>
                                </li>
                                <li class="flex items-center bg-gray-800 p-2 rounded-md justify-between">
                                    <span>Build a new app concept</span>
                                    <button class="text-red-400 hover:text-red-500 text-sm delete-todo-btn">Delete</button>
                                </li>
                            </ul>
                        </div>
                    `;
                    break;
                case 'display-settings':
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto">
                            <h3 class="text-xl font-semibold mb-4">Display Settings</h3>

                            <div class="mb-6">
                                <label for="theme-mode" class="flex items-center cursor-pointer">
                                    <span class="text-gray-300 mr-3">Dark Mode / Light Mode</span>
                                    <div class="relative">
                                        <input type="checkbox" id="theme-mode" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>

                            <div class="mb-6">
                                <label for="brightness" class="block text-lg font-medium text-gray-300 mb-2">Brightness</label>
                                <input type="range" id="brightness" min="20" max="100" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <span class="text-sm text-gray-400 mt-2">Adjust screen brightness.</span>
                            </div>

                            <div class="mb-6">
                                <label for="night-light" class="flex items-center cursor-pointer">
                                    <span class="text-gray-300 mr-3">Night Light</span>
                                    <div class="relative">
                                        <input type="checkbox" id="night-light" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    </div>
                                </label>
                                <p class="text-sm text-gray-400 mt-2">Reduce blue light to help you sleep.</p>
                            </div>

                            <div class="mb-6">
                                <label for="scale" class="block text-lg font-medium text-gray-300 mb-2">Scale and Layout</label>
                                <input type="range" id="scale" min="100" max="200" value="100" step="25" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <p class="text-sm text-gray-400 mt-1">Recommended: <span id="scale-value">100%</span></p>
                            </div>

                            <div class="mb-6">
                                <label for="resolution" class="block text-lg font-medium text-gray-300 mb-2">Display Resolution</label>
                                <select id="resolution" class="w-full rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option>1920 x 1080 (Recommended)</option>
                                    <option>1600 x 900</option>
                                    <option>1366 x 768</option>
                                    <option>1280 x 720</option>
                                </select>
                            </div>

                            <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="saveUserPreferences()">Apply Display Settings</button>
                        </div>
                    `;
                    break;
                case 'recycle-bin':
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto flex flex-col items-center justify-center relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <h3 class="text-2xl font-bold text-gray-300 mb-2 relative z-10">Recycle Bin</h3>
                            <p class="text-gray-400 max-w-sm text-center relative z-10">
                                This is where deleted files go. Currently, it's empty.
                                You can restore items or empty the recycle bin from here (conceptual).
                            </p>
                            <div class="mt-6 flex justify-center gap-4 relative z-10">
                                <button class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-full shadow-lg" onclick="showMessage('Recycle Bin emptied!');">
                                    Empty Recycle Bin
                                </button>
                                <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg" onclick="showMessage('No items to restore!');">
                                    Restore All Items
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                case 'code-editor':
                    contentHTML = `
                        <div class="flex-grow flex flex-col">
                            <div class="p-2 bg-gray-700 flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-200">Untitled.txt</span>
                                <div>
                                    <button class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-md" onclick="showMessage('Save functionality requires a backend!');">Save</button>
                                    <button class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-1 rounded-md" onclick="showMessage('Load functionality requires a backend!');">Load</button>
                                </div>
                            </div>
                            <textarea id="code-editor-textarea-${appId}" class="flex-grow w-full h-full p-4 bg-gray-900 text-white font-mono text-sm resize-none outline-none"></textarea>
                        </div>
                    `;
                    break;
                case 'windows-update':
                    contentHTML = `
                        <div class="p-4 text-center flex flex-col items-center justify-center h-full">
                            <h2 class="text-xl font-semibold mb-4">Windows 13 Update</h2>
                            <canvas id="update-canvas-${appId}" width="200" height="200" class="border border-blue-500 rounded-full mb-4"></canvas>
                            <p id="update-status-${appId}" class="text-lg text-blue-400">Checking for updates...</p>
                            <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" onclick="startUpdateAnimation('${appId}')">Start Update</button>
                        </div>
                    `;
                    break;
                default:
                    contentHTML = `
                        <div class="p-4 flex-grow overflow-auto relative">
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                ${bigIconHTML}
                            </div>
                            <h1 class="relative z-10">${appName}</h1>
                            <p class="relative z-10">Welcome to ${appName}!</p>
                            <div class="mt-4 p-3 bg-gray-800 rounded-md relative z-10">
                                <p class="text-sm">This is a generic application window.</p>
                            </div>
                        </div>
                    `;
            }

            windowElement.querySelector('.window-content').innerHTML = contentHTML;

            // Initialize app-specific logic after content is set
            if (appId === 'about-windows') {
                const aboutTabBtn = windowElement.querySelector('#about-tab-btn');
                const updatesTabBtn = windowElement.querySelector('#updates-tab-btn');
                if (aboutTabBtn) aboutTabBtn.addEventListener('click', () => showAboutTabForApp(windowElement, 'about'));
                if (updatesTabBtn) updatesTabBtn.addEventListener('click', () => showAboutTabForApp(windowElement, 'updates'));
                showAboutTabForApp(windowElement, 'about'); // Default to about tab
            } else if (appId === 'calculator') {
                initializeCalculator(windowElement);
            } else if (appId === 'todo-list') {
                initializeTodoList(windowElement);
            } else if (appId === 'display-settings') {
                initializeDisplaySettings(windowElement);
            } else if (appId === 'settings') {
                showSettingsCategory(windowElement, 'system'); // Default to system settings
                windowElement.querySelectorAll('.settings-category-item').forEach(item => {
                    item.addEventListener('click', () => {
                        showSettingsCategory(windowElement, item.dataset.categoryId);
                    });
                });
            } else if (appId === 'date-time') {
                updateDateTimeApp(windowElement);
                // Set interval for live updates within the app
                windowElement._updateInterval = setInterval(() => updateDateTimeApp(windowElement), 1000);
                 // Clear interval when window is closed
                windowElement.querySelector('.close-btn').addEventListener('click', () => {
                    if (windowElement._updateInterval) {
                        clearInterval(windowElement._updateInterval);
                    }
                }, { once: true });
            } else if (appId === 'terminal') {
                initializeTerminal(windowElement);
            } else if (appId === 'file-explorer') {
                initializeFileExplorer(windowElement);
            } else if (appId === 'windows-update') {
                // Initial canvas draw for Windows Update
                const canvas = windowElement.querySelector(`#update-canvas-${appId}`);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    drawUpdateCircle(ctx, canvas.width / 2, canvas.height / 2, 80, 0);
                }
            }


        } catch (error) {
            console.error(`Error opening app ${appName}:`, error);
            showMessage(`Error opening ${appName}: ${error.message}`);
        }
    }

    // --- Calculator Logic ---
    function initializeCalculator(calculatorWindowElement) {
        const display = calculatorWindowElement.querySelector('#calc-display');
        const buttons = calculatorWindowElement.querySelectorAll('.calc-btn');
        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        let waitingForSecondOperand = false;

        function updateDisplay() {
            display.value = currentInput;
        }

        function clearCalculator() {
            currentInput = '0';
            operator = null;
            firstOperand = null;
            waitingForSecondOperand = false;
            updateDisplay();
        }

        function inputDigit(digit) {
            if (waitingForSecondOperand) {
                currentInput = digit;
                waitingForSecondOperand = false;
            } else {
                // Prevent multiple leading zeros, but allow '0.'
                if (currentInput === '0' && digit !== '.') {
                    currentInput = digit;
                } else {
                    currentInput += digit;
                }
            }
            updateDisplay();
        }

        function inputDecimal() {
            // Only add a decimal if one doesn't already exist in the current input
            if (!currentInput.includes('.')) {
                currentInput += '.';
            }
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            const inputValue = parseFloat(currentInput);

            if (operator && waitingForSecondOperand) {
                operator = nextOperator; // Allow changing operator before second operand is entered
                return;
            }

            if (firstOperand === null) {
                firstOperand = inputValue;
            } else if (operator) {
                const result = operate(firstOperand, inputValue, operator);
                currentInput = String(result);
                firstOperand = result;
            }

            waitingForSecondOperand = true;
            operator = nextOperator;
            updateDisplay();
        }

        function operate(num1, num2, op) {
            switch (op) {
                case '+': return num1 + num2;
                case '-': return num1 - num2;
                case '*': return num1 * num2;
                case '/':
                    if (num2 === 0) {
                        showMessage('Error: Division by zero!');
                        return NaN; // Return NaN to indicate an error state in the calculator
                    }
                    return num1 / num2;
                default: return num2;
            }
        }

        buttons.forEach(button => {
            button.addEventListener('click', (event) => {
                const { value } = event.target.dataset; // Use data-value attribute

                if (value === 'C') {
                    clearCalculator();
                    return;
                }
                if (value === '\u2190') { // Left arrow for backspace
                    currentInput = currentInput.slice(0, -1) || '0';
                    updateDisplay();
                    return;
                }
                if (value === '.') {
                    inputDecimal();
                    return;
                }
                if (['+', '-', '*', '/', '='].includes(value)) {
                    handleOperator(value);
                    return;
                }

                inputDigit(value);
            });
        });

        updateDisplay(); // Initial display update
    }

    // --- To-Do List Logic ---
    function initializeTodoList(todoWindowElement) {
        const todoInput = todoWindowElement.querySelector('#todo-input');
        const addTodoBtn = todoWindowElement.querySelector('#add-todo-btn');
        const todoListItems = todoWindowElement.querySelector('#todo-list-items');

        function addTask() {
            const taskText = todoInput.value.trim();
            if (taskText === '') {
                showMessage('Please enter a task!');
                return;
            }

            const listItem = document.createElement('li');
            listItem.className = 'flex items-center bg-gray-800 p-2 rounded-md justify-between';
            listItem.innerHTML = `
                <span>${taskText}</span>
                <button class="text-red-400 hover:text-red-500 text-sm delete-todo-btn">Delete</button>
            `;

            listItem.querySelector('.delete-todo-btn').addEventListener('click', () => {
                listItem.remove();
            });

            todoListItems.appendChild(listItem);
            todoInput.value = ''; // Clear input
            showMessage('Task added!');
        }

        if (addTodoBtn) {
            addTodoBtn.addEventListener('click', addTask);
        }
        if (todoInput) {
            todoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTask();
                }
            });
        }

        // Re-attach listeners to pre-existing (sample) delete buttons if any
        todoListItems.querySelectorAll('.delete-todo-btn').forEach(button => {
            button.onclick = function() { this.parentElement.remove(); };
        });
    }

    // --- Display Settings Logic ---
    function initializeDisplaySettings(displaySettingsWindowElement) {
        const scaleSlider = displaySettingsWindowElement.querySelector('#scale');
        const scaleValueSpan = displaySettingsWindowElement.querySelector('#scale-value');
        const brightnessSlider = displaySettingsWindowElement.querySelector('#brightness');
        const nightLightToggle = displaySettingsWindowElement.querySelector('#night-light');
        const themeModeToggle = displaySettingsWindowElement.querySelector('#theme-mode'); // Get themeModeToggle inside the function

        const desktopEnv = document.getElementById('desktop-env-container'); // Get the main desktop container

        // --- Scale Slider (Conceptual) ---
        if (scaleSlider && scaleValueSpan) {
            scaleSlider.addEventListener('input', () => {
                scaleValueSpan.textContent = `${scaleSlider.value}%`;
                // No actual scaling applied, just UI feedback
                showMessage(`Desktop scale set to ${scaleSlider.value}% (conceptual)`);
            });
            // Set initial value display
            scaleValueSpan.textContent = `${scaleSlider.value}%`;
        }

        // --- Brightness Slider ---
        if (brightnessSlider && desktopEnv) {
            // Get initial brightness from computed style or default
            let currentBrightness = parseFloat(getComputedStyle(desktopEnv).filter.match(/brightness\((\d+(\.\d+)?)%\)/)?.[1]) || 100;
            brightnessSlider.value = currentBrightness;

            brightnessSlider.addEventListener('input', () => {
                refreshDesktopAppearance(); // Re-calculate and apply all filters
            });
        }

        // --- Night Light Toggle ---
        if (nightLightToggle && desktopEnv) {
            // Set initial night light state based on its class
            nightLightToggle.checked = desktopEnv.classList.contains('night-light-active');

            nightLightToggle.addEventListener('change', () => {
                if (nightLightToggle.checked) {
                    desktopEnv.classList.add('night-light-active');
                } else {
                    desktopEnv.classList.remove('night-light-active');
                }
                refreshDesktopAppearance(); // Re-calculate and apply all filters
            });
        }

        // --- Resolution Dropdown (Conceptual) ---
        const resolutionSelect = displaySettingsWindowElement.querySelector('#resolution');
        if (resolutionSelect) {
            resolutionSelect.addEventListener('change', () => {
                showMessage(`Resolution set to ${resolutionSelect.value} (conceptual)`);
            });
        }

        // --- Theme Mode Toggle (Light/Dark) ---
        if (themeModeToggle) {
            // Initialize the toggle state based on current body class
            themeModeToggle.checked = document.body.classList.contains('light-mode');

            themeModeToggle.addEventListener('change', () => {
                if (themeModeToggle.checked) {
                    window.userPreferences.theme = 'light-mode';
                } else {
                    window.userPreferences.theme = 'dark-mode';
                }
                applyTheme(window.userPreferences.theme); // This will now trigger refreshDesktopAppearance
                saveUserPreferences(); // This will persist to localStorage
            });
        }
        // Initial call to set filters when display settings window opens
        refreshDesktopAppearance();
    }

    // Functions for Personalization section
    function selectWallpaper(url, element) {
        const currentWallpaperPreview = document.querySelector('#current-wallpaper-preview');
        const wallpaperUrlInput = document.querySelector('#wallpaper-url-input');

        // Update preview
        if (currentWallpaperPreview) {
            currentWallpaperPreview.style.backgroundImage = `url('${url}')`;
        }
        // Update global preference
        window.userPreferences.wallpaperUrl = url;
        // Clear custom URL input if a predefined one is selected
        if (wallpaperUrlInput) {
            wallpaperUrlInput.value = '';
        }

        // Add a visual indicator for selected wallpaper (optional, but good UX)
        document.querySelectorAll('#personalization-content img').forEach(img => {
            img.classList.remove('border-blue-500');
            img.classList.add('border-transparent');
        });
        if (element) { // Check if element is provided (e.g., for predefined wallpapers)
            element.classList.remove('border-transparent');
            element.classList.add('border-blue-500');
        }
        refreshDesktopAppearance(); // Refresh appearance to show new wallpaper
        showMessage('Wallpaper preview updated. Click "Save Wallpaper" to apply.');
    }

    function applyCustomWallpaper() {
        const wallpaperUrlInput = document.querySelector('#wallpaper-url-input');
        if (wallpaperUrlInput && wallpaperUrlInput.value.trim() !== '') {
            const url = wallpaperUrlInput.value.trim();
            selectWallpaper(url, null); // Pass null for element as it's a custom URL
            // Visually mark the custom input as "selected" or active
            document.querySelectorAll('#personalization-content img').forEach(img => {
                img.classList.remove('border-blue-500');
                img.classList.add('border-transparent');
            });
            wallpaperUrlInput.style.borderColor = 'var(--focus-ring-color)';
            wallpaperUrlInput.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.4)';
        } else {
            showMessage('Please enter a valid image URL.');
        }
    }

    // Function for Accounts section
    function updateAccountDetails() {
        const accountsUsernameInput = document.querySelector('#accounts-username-input');
        const accountsPasswordInput = document.querySelector('#accounts-password-input');

        if (accountsUsernameInput) {
            window.userPreferences.username = accountsUsernameInput.value.trim();
        }
        if (accountsPasswordInput) {
            // WARNING: Storing plain text password for demo purposes.
            // In a real application, passwords must be securely hashed on the server side.
            window.userPreferences.password = accountsPasswordInput.value;
        }
        saveUserPreferences(); // This will now persist to localStorage
    }


    // --- Date and Time App Logic ---
    function updateDateTimeApp(appWindowElement) {
        const appTimeDisplay = appWindowElement.querySelector('#app-current-time');
        const appDateDisplay = appWindowElement.querySelector('#app-current-date');
        const now = new Date();
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

        if (appTimeDisplay) appTimeDisplay.textContent = now.toLocaleTimeString([], timeOptions);
        if (appDateDisplay) appDateDisplay.textContent = now.toLocaleDateString(undefined, dateOptions);
    }

    // --- Terminal Logic ---
    function initializeTerminal(terminalWindowElement) {
        const terminalOutput = terminalWindowElement.querySelector(`#terminal-output-${terminalWindowElement.id.replace('window-', '')}`);
        const terminalInput = terminalWindowElement.querySelector(`#terminal-input-${terminalWindowElement.id.replace('window-', '')}`);
        const terminalPathDisplay = terminalWindowElement.querySelector(`#terminal-current-path-${terminalWindowElement.id.replace('window-', '')}`);

        // Update the path displayed in the prompt
        function updateTerminalPrompt() {
            if (terminalPathDisplay) {
                terminalPathDisplay.textContent = window.currentPath.replace(/\\/g, '/');
            }
        }

        function appendOutput(text, type = 'normal') {
            const p = document.createElement('pre'); // Use pre for monospace and preserve whitespace
            p.innerHTML = text; // Use innerHTML for styling within pre
            if (type === 'error') p.classList.add('text-red-400');
            terminalOutput.appendChild(p);
            terminalOutput.scrollTop = terminalOutput.scrollHeight; // Scroll to bottom
        }

        function executeCommand(command) {
            appendOutput(`<span class="text-green-400">user@computer</span>:<span class="text-blue-400">${window.currentPath.replace(/\\/g, '/')}</span>$&nbsp;${command}`); // Echo the command
            const parts = command.split(' ').filter(p => p !== '');
            const cmd = parts[0];
            const args = parts.slice(1);

            switch (cmd.toLowerCase()) { // Case-insensitive commands
                case 'help':
                    appendOutput('Available commands:');
                    appendOutput('  <span class="text-yellow-400">ls</span> - list directory contents');
                    appendOutput('  <span class="text-yellow-400">cd &lt;directory&gt;</span> - change directory');
                    appendOutput('  <span class="text-yellow-400">echo &lt;message&gt;</span> - print message');
                    appendOutput('  <span class="text-yellow-400">clear</span> - clear the terminal screen');
                    appendOutput('  <span class="text-yellow-400">pwd</span> - print working directory');
                    break;
                case 'ls':
                    listDirectory(terminalOutput, window.currentPath, true); // Pass true to enable rich formatting
                    break;
                case 'cd':
                    changeDirectory(args[0], terminalOutput, updateTerminalPrompt); // Pass updateTerminalPrompt callback
                    break;
                case 'echo':
                    appendOutput(args.join(' '));
                    break;
                case 'clear':
                    terminalOutput.innerHTML = '';
                    break;
                case 'pwd':
                    appendOutput(window.currentPath);
                    break;
                case '': // Empty command
                    break;
                default:
                    appendOutput(`'${cmd}' is not recognized as an internal or external command.`, 'error');
                    break;
            }
            terminalInput.value = ''; // Clear input after command
        }

        terminalInput.addEventListener('keydown', (e) => { // Use keydown to prevent default enter behavior
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent new line in input
                executeCommand(terminalInput.value.trim());
            }
        });

        terminalInput.focus(); // Focus input on open
        updateTerminalPrompt(); // Initial prompt update
    }

    // Helper functions for Terminal and File Explorer
    function getDirectoryContents(path) {
        let current = window.fileSystem;
        const pathParts = path.split('\\').filter(p => p !== '');

        for (const part of pathParts) {
            if (current[part] === undefined) {
                return null; // Path not found
            }
            current = current[part];
        }
        return current;
    }

    // Modified listDirectory to support rich formatting for terminal
    function listDirectory(outputElement, currentPath, isTerminal = false) {
        const contents = getDirectoryContents(currentPath);
        if (!contents) {
            const p = document.createElement('pre');
            p.classList.add('text-red-400');
            p.textContent = `Error: Cannot access '${currentPath}'`;
            outputElement.appendChild(p);
            return;
        }

        if (Object.keys(contents).length === 0) {
            const p = document.createElement('pre');
            p.textContent = `Directory '${currentPath}' is empty.`;
            outputElement.appendChild(p);
            return;
        }

        const sortedItems = Object.keys(contents).sort(); // Sort alphabetically
        sortedItems.forEach(item => {
            const type = typeof contents[item] === 'object' ? 'DIR' : 'FILE';
            let formattedItem = '';
            if (isTerminal) {
                if (type === 'DIR') {
                    formattedItem = `<span class="text-blue-300"><i class="fa-solid fa-folder mr-2"></i>${item}/</span>`;
                } else {
                    formattedItem = `<span class="text-gray-300"><i class="fa-solid fa-file mr-2"></i>${item}</span>`;
                }
                const p = document.createElement('pre');
                p.innerHTML = formattedItem;
                outputElement.appendChild(p);
            } else {
                // Original file explorer rendering logic (currently unused for desktop icons, but for FE)
                const iconClass = isFolder ? 'fa-folder text-yellow-500' : 'fa-file text-gray-500';
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer transition-colors';
                itemElement.innerHTML = `<i class="fa-solid ${iconClass} mr-3 text-xl"></i><span>${item}</span>`;
                outputElement.appendChild(itemElement);
            }
        });
    }

    function changeDirectory(dir, outputElement, callback) {
        if (!dir) {
            showMessage('Usage: cd <directory>');
            return;
        }

        let newPathParts = window.currentPath.split('\\').filter(p => p !== '');

        if (dir === '..') {
            if (newPathParts.length > 1) { // Prevent going above root C:
                newPathParts.pop();
            }
        } else if (dir === '/') { // Go to root
            newPathParts = ['C:'];
        } else if (dir.startsWith('C:\\') || dir.startsWith('c:\\')) { // Absolute path
            const absoluteParts = dir.split('\\').filter(p => p !== '');
            if (absoluteParts[0].toLowerCase() === 'c:') {
                newPathParts = absoluteParts;
            } else {
                appendOutput(`Invalid path: ${dir}`, 'error');
                return;
            }
        } else { // Relative path
            newPathParts.push(dir);
        }

        const testPath = newPathParts.join('\\');
        const resolvedPathContents = getDirectoryContents(testPath);

        if (resolvedPathContents && typeof resolvedPathContents === 'object') { // Check if it's a valid directory object
            window.currentPath = testPath + (testPath.endsWith(':') ? '\\' : ''); // Ensure trailing slash for drives
            if (callback) callback(); // Call the callback to update the prompt
        } else {
            appendOutput(`Directory not found: '${dir}'`, 'error');
        }
    }


    // --- File Explorer Logic ---
    let feCurrentDirHandle = window.fileSystem['C:']; // Represents the current directory object
    let fePathHistory = ['C:']; // Stores path history for back button

    function initializeFileExplorer(feWindowElement) {
        const fePathDisplay = feWindowElement.querySelector('#fe-path-display');
        const feContent = feWindowElement.querySelector('#fe-content');
        const feBackBtn = feWindowElement.querySelector('#fe-back-btn');
        const feUpBtn = feWindowElement.querySelector('#fe-up-btn');

        function updateFileExplorerView() {
            fePathDisplay.textContent = fePathHistory.join('\\') + '\\'; // Update path display
            feContent.innerHTML = ''; // Clear current content

            const currentContents = getDirectoryContents(fePathHistory.join('\\'));
            if (!currentContents) {
                feContent.innerHTML = '<p class="text-red-400">Error: Directory not found or inaccessible.</p>';
                return;
            }

            const items = Object.keys(currentContents).sort();

            if (items.length === 0) {
                feContent.innerHTML = '<p class="text-gray-400">This folder is empty.</p>';
            } else {
                items.forEach(item => {
                    const isFolder = typeof currentContents[item] === 'object';
                    const iconClass = isFolder ? 'fa-folder text-yellow-500' : 'fa-file text-gray-500';
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer transition-colors';
                    itemElement.innerHTML = `<i class="fa-solid ${iconClass} mr-3 text-xl"></i><span>${item}</span>`;

                    if (isFolder) {
                        itemElement.addEventListener('click', () => {
                            fePathHistory.push(item);
                            updateFileExplorerView();
                        });
                    } else {
                        itemElement.addEventListener('click', () => {
                            // Conceptual file open
                            const fileContent = currentContents[item];
                            showMessage(`Opened file: ${item}. Content: "${fileContent.substring(0, Math.min(fileContent.length, 50))}..."`);
                            // In a real app, you'd open a text editor or appropriate viewer
                        });
                    }
                    feContent.appendChild(itemElement);
                });
            }
            // Update button states
            feBackBtn.disabled = fePathHistory.length <= 1; // Can't go back from root
            feUpBtn.disabled = fePathHistory.length <= 1; // Can't go up from root
        }

        // Back button functionality
        feBackBtn.addEventListener('click', () => {
            if (fePathHistory.length > 1) {
                fePathHistory.pop();
                updateFileExplorerView();
            }
        });

        // Up button functionality (same as back for now, simplified)
        feUpBtn.addEventListener('click', () => {
            if (fePathHistory.length > 1) {
                fePathHistory.pop();
                updateFileExplorerView();
            }
        });

        // Initial view load
        updateFileExplorerView();
    }


    // Function to copy text to clipboard
    function copyToClipboard(text) {
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showMessage('Path copied to clipboard!');
    }

    // --- Windows Update Canvas Logic ---
    function drawUpdateCircle(ctx, x, y, radius, progress) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.strokeStyle = '#374151'; // Gray background for the circle
        ctx.lineWidth = 10;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(x, y, radius, -Math.PI / 2, -Math.PI / 2 + (Math.PI * 2 * progress));
        ctx.strokeStyle = '#3B82F6'; // Blue for progress
        ctx.lineWidth = 10;
        ctx.stroke();

        ctx.font = '24px Inter';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${Math.round(progress * 100)}%`, x, y);
    }

    function startUpdateAnimation(appId) {
        const canvas = document.getElementById(`update-canvas-${appId}`);
        const ctx = canvas.getContext('2d');
        const statusElement = document.getElementById(`update-status-${appId}`);
        let progress = 0;
        const duration = 5000; // 5 seconds for full update
        const startTime = performance.now();

        function animate(currentTime) {
            const elapsedTime = currentTime - startTime;
            progress = Math.min(elapsedTime / duration, 1);
            drawUpdateCircle(ctx, canvas.width / 2, canvas.height / 2, 80, progress);
            statusElement.textContent = `Updating... ${Math.round(progress * 100)}%`;

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                statusElement.textContent = 'Update Complete!';
                showMessage('Windows has been updated!'); // Generic message
            }
        }
        requestAnimationFrame(animate);
    }


    // Initialize main desktop event listeners after the DOM is fully loaded
    function initializeDesktopListeners() {
        // Assign global DOM variables here, after document is loaded
        desktopEnvContainer = document.getElementById('desktop-env-container');
        loginScreen = document.getElementById('login-screen');
        passwordInput = document.getElementById('password-input');
        loginTimeDisplay = document.getElementById('login-time');
        loginDateDisplay = document.getElementById('login-date');
        loginSpinner = document.getElementById('login-spinner');
        loginCard = document.querySelector('.login-card');
        welcomeMessage = document.getElementById('welcome-message');
        loginErrorMessage = document.getElementById('login-error-message');
        createAccountModal = document.getElementById('create-account-modal');
        newUsernameInput = document.getElementById('new-username-input');
        newPasswordInput = document.getElementById('new-password-input');
        betaIntroModal = document.getElementById('beta-intro-modal'); // Assign beta intro modal

        desktop = document.getElementById('desktop');
        desktopIconsZone = document.getElementById('desktop-icons-zone');
        shortcutsZone = document.getElementById('shortcuts-zone');
        desktopTimeDisplay = document.getElementById('desktop-time');
        desktopDateDisplay = document.getElementById('desktop-date');

        windowsContainer = document.getElementById('windows-container');
        startMenu = document.getElementById('start-menu');
        standaloneStartButton = document.getElementById('standalone-start-button'); // Corrected variable name
        desktopContextMenu = document.getElementById('desktop-context-menu');
        // taskbarApps = document.getElementById('taskbar-apps'); // This element was removed

        internetVolumeContainer = document.getElementById('internet-volume-container'); // New reference
        systemTimeBottom = document.getElementById('system-time-bottom'); // New reference
        systemDateBottom = document.getElementById('system-date-bottom'); // New reference


        // Update document title
        document.title = "Windows 13 Concept (0.4.1)"; // Updated title

        // Initialize the snap preview element once
        initializeSnapPreview();


        // --- Attach event listeners to desktop icons dynamically ---
        const desktopIcons = document.querySelectorAll('.desktop-icon');
        desktopIcons.forEach(icon => {
            const appName = icon.dataset.appName;
            const appId = icon.dataset.appId;
            if (appName && appId) {
                icon.addEventListener('click', (e) => openApp(appName, appId, e)); // Pass event object
            } else {
                console.warn(`Desktop icon missing data-app-name or data-app-id:`, icon);
            }
        });

        // Attach keyup event listener to password input programmatically
        if (passwordInput) {
            passwordInput.addEventListener('keyup', handleLoginEnter);
        }


        // Event listeners for desktop, context menu, and start menu
        if (desktop) {
            desktop.addEventListener('click', (e) => {
                hideAllContextMenus(); // Call hideAll to ensure context menu hides when clicking elsewhere
                // If the click target is the desktop itself or related zones, deselect icon
                if (e.target === desktop || e.target.id === 'desktop-icons-zone' || e.target.id === 'shortcuts-zone') {
                    setActiveDesktopIcon(null);
                }
            });
            desktop.addEventListener('contextmenu', (e) => {
                setActiveDesktopIcon(null); // Deselect any active icon on right-click
                showContextMenu(e);
            });
        }
        // This is crucial: stop propagation for clicks INSIDE the context menu
        if (desktopContextMenu) {
            desktopContextMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        if (startMenu && standaloneStartButton) { // Changed startButton to standaloneStartButton
            document.addEventListener('click', function(event) {
                // If click is outside start menu and not on the start button, hide it
                if (!startMenu.contains(event.target) && !standaloneStartButton.contains(event.target) && !startMenu.classList.contains('hidden')) { // Changed startButton to standaloneStartButton
                    toggleStartMenu(); // Use toggle function for animation
                }
            });
        }


        // Centralize mouseup/mousemove listeners for all draggable/resizable elements
        document.addEventListener('mousemove', (e) => {
            if (document.body.style.cursor === 'grabbing' || document.body.style.cursor === 'se-resize') {
                e.preventDefault();
            }
        });

        document.addEventListener('mouseup', () => {
            document.body.style.cursor = 'default';
        });

        // Initial update of time and date
        updateTimeAndDate();
        setInterval(updateTimeAndDate, 1000); // Update time every second

        // Set desktop to blurred state initially when the OS loads (before login)
        if (desktopEnvContainer) {
            desktopEnvContainer.classList.add('blurred');
            desktopEnvContainer.classList.remove('desktop-active'); // Ensure it's not active desktop during login
        }

        // The login screen should be visible initially.
        if (loginScreen) {
            loginScreen.classList.remove('hidden');
            // Animate login card and welcome message
            if (loginCard) loginCard.classList.add('show');
            // Show welcome message after a short delay
            setTimeout(() => {
                if (welcomeMessage) welcomeMessage.classList.add('show');
            }, 300);
        }

        // Load initial user preferences (now from in-memory defaults)
        loadUserPreferences();
    }

    // Call initializeDesktopListeners when the window fully loads
    window.addEventListener('load', () => {
        initializeDesktopListeners();
    });
</script>
</body>
</html>
